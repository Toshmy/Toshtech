<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>ToshBoard ‚Äî Mainnet ToshScore (Scorecards)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root{
    --bg:#0c1222; --bg2:#0b1226; --fg:#e8fff6; --muted:#a8ffd9;
    --accent:#00ffae; --accent2:#00d99c; --card:rgba(255,255,255,.05);
    --border:rgba(0,255,174,.2); --shadow:0 0 30px rgba(0,255,174,.18);
    --red:#ef4444; --green:#22c55e; --blue:#49a8ff; --amber:#f59e0b; --gray:#9aa3b2;
  }
  html,body{margin:0;background:radial-gradient(circle at 20% 10%, #1a2238 0%, var(--bg) 70%);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{max-width:1200px;margin:22px auto;padding:0 16px}
  .glow{ text-shadow:0 0 8px var(--accent), 0 0 18px var(--accent) }
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .between{justify-content:space-between}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:.25rem .6rem;border-radius:999px;background:#081021;border:1px solid var(--border);color:#bfeede;font-size:12px}
  input,button,select{border-radius:12px;border:1px solid var(--border);background:#0f1730;color:#fff;padding:10px}
  button{cursor:pointer}
  .btn{background:linear-gradient(135deg, var(--accent), var(--accent2));color:#00251b;border:0;font-weight:700}
  .btn.gray{background:linear-gradient(135deg,#64748b,#475569);color:#eef5ff}
  a{color:#93c5fd;text-decoration:none}
  .grid{display:grid;gap:12px}
  @media(min-width:700px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media(min-width:1024px){ .grid{grid-template-columns:repeat(3,1fr)} }

  .card{background:var(--card);border:1px solid var(--border);backdrop-filter:blur(6px);border-radius:16px;box-shadow:var(--shadow);padding:14px}
  .token-head{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
  .token-title{display:flex;flex-direction:column;gap:2px}
  .token-title .sym{font-weight:800;font-size:16px}
  .token-title .sub{font-size:12px;color:#bfeede}
  .score-badge{min-width:100px;min-height:100px;display:flex;align-items:center;justify-content:center;border-radius:16px;border:1px solid var(--border);background:#0b162f;position:relative}
  .score-num{font-size:24px;font-weight:900}
  .score-lbl{font-size:11px;color:#bfeede}
  .ring{position:absolute;inset:8px}

  /* Score badge coloring */
  .score-badge.good{box-shadow:0 0 0 1px rgba(34,197,94,.25), 0 0 22px rgba(34,197,94,.18)}
  .score-badge.ok{box-shadow:0 0 0 1px rgba(132,204,22,.25), 0 0 22px rgba(132,204,22,.18)}
  .score-badge.warn{box-shadow:0 0 0 1px rgba(245,158,11,.25), 0 0 22px rgba(245,158,11,.18)}
  .score-badge.bad{box-shadow:0 0 0 1px rgba(239,68,68,.25), 0 0 22px rgba(239,68,68,.18)}
  .score-badge.good .score-num{color:#34d399}
  .score-badge.ok .score-num{color:#a3e635}
  .score-badge.warn .score-num{color:#f59e0b}
  .score-badge.bad .score-num{color:#ef4444}

  /* Compact info chips */
  .rowchips{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}
  .chip{border:1px solid var(--border);border-radius:999px;padding:.15rem .5rem;background:#0f1730;font-size:12px;white-space:nowrap}
  .chip.bad{border-color:rgba(239,68,68,.6); color:#fecaca}

  /* Category metric pills (visual, low numbers) */
  .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  @media(min-width:1024px){ .metrics{grid-template-columns:repeat(6,1fr)} }
  .metric{display:flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:12px;padding:6px 8px;background:#0f1730}
  .metric .ico{font-size:14px}
  .metric .name{font-size:12px;color:#cfe}
  .metric .mbar{flex:1;height:6px;border-radius:999px;background:#0b1430;overflow:hidden;border:1px solid rgba(255,255,255,.06)}
  .metric .mbar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .metric.ok{box-shadow:0 0 0 1px rgba(34,197,94,.18) inset}
  .metric.warn{box-shadow:0 0 0 1px rgba(245,158,11,.18) inset}
  .metric.bad{box-shadow:0 0 0 1px rgba(239,68,68,.25) inset}

  .footer-note{font-size:12px;color:#9fead1;margin-top:8px}

  /* Details accordion */
  details.more{margin-top:8px}
  details.more summary{cursor:pointer;color:#9fead1}
  .brow{display:flex;justify-content:space-between;gap:8px;font-size:12px;margin:4px 0}
  .bar{height:10px;border-radius:999px;background:#0f1730;border:1px solid var(--border);display:flex;overflow:hidden}
  .seg-burn{background:#ef4444}
  .seg-locked{background:#49a8ff}
  .seg-circ{background:#22c55e}

  /* loading overlay */
  .overlay{position:fixed;inset:0;background:rgba(6,10,24,.8);backdrop-filter:blur(3px);display:none;place-items:center;z-index:50}
  .overlay .panel{width:min(680px,92vw);background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
  .progress{height:12px;border-radius:999px;background:#0b1430;border:1px solid var(--border);overflow:hidden}
  .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2))}
</style>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
<div class="wrap">
  <header class="row between">
    <h1 class="glow" style="margin:0">üìä ToshBoard ‚Äî Mainnet ToshScore</h1>
    <div class="row">
      <input id="search" placeholder="Search name / symbol / 0x‚Ä¶" style="min-width:220px">
      <select id="sorter" title="Sort">
        <option value="score">Sort: Score (desc)</option>
        <option value="locked">Sort: Locked %</option>
        <option value="mc">Sort: Market Cap</option>
        <option value="liq">Sort: Liquidity</option>
        <option value="age">Sort: Age</option>
      </select>
      <button id="reload" class="btn gray">Reload</button>
      <span id="status" class="pill">Idle</span>
    </div>
  </header>

  <div id="cards" class="grid" style="margin-top:10px"></div>
  <div class="footer-note">Data: pools_cache.json ‚Ä¢ Launchpad subgraph ‚Ä¢ Explorer (holders) ‚Ä¢ HolderRadar (votes). P90 on pools‚Äô reserve_in_usd.</div>
</div>

<!-- Loading overlay -->
<div id="overlay" class="overlay">
  <div class="panel">
    <div class="row between" style="margin-bottom:8px">
      <div class="glow">Loading tokens‚Ä¶</div>
      <span id="count" class="pill">0 / 0</span>
    </div>
    <div class="progress" aria-label="overall loading progress"><i id="progressFill"></i></div>
    <div class="row between" style="margin-top:6px">
      <span class="pill" id="stage">Starting‚Ä¶</span>
      <span class="pill" id="elapsed">‚Äî</span>
    </div>
  </div>
</div>

<script>
/* ================== CONFIG ================== */
const RPC = "https://rpc-pepu-v2-mainnet-0.t.conduit.xyz";
const EXPLORER = "https://explorer-pepu-v2-mainnet-0.t.conduit.xyz";
const LOCKER = "0xCCEfe66507762370C2487dd198d7D1fEfc6dEF8F";
const WORKER = "https://odd-feather-f250.toshtech777.workers.dev/?url=";    // CORS relay
const POOLS_URL = "https://www.toshtech.xyz/pools_cache.json";               // local cache

const BURNS = [
  "0xa9fD599cd8857e90059c83e4885Dc09986039085",
  "0x000000000000000000000000000000000000dEaD"
];

const ERC20 = [
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function totalSupply() view returns (uint256)",
  "function balanceOf(address) view returns (uint256)"
];
const LOCKER_ABI = [
  "function getActiveLocksByToken(address token,uint256 offset,uint256 limit) view returns (uint256[] lockIds,address[] owners,uint256[] amounts,uint256[] unlockTimes,string[] names)"
];

const ro = new ethers.providers.JsonRpcProvider(RPC);

/* ================== Weights ================== */
const W_LOCKED = 30;     // Locked % (cap 50%)
const W_TIME   = 10;     // Avg remaining lock time
const W_DEV    = 10;     // Only ‚Äúcreator locked?‚Äù
const W_AGE    = 10;     // Age from GQL
const W_HEALTH_DEPTH = 7; // part of health
const W_HEALTH_VOL   = 8; // part of health
const W_HEALTH = W_HEALTH_DEPTH + W_HEALTH_VOL; // 15
const W_VOTES  = 10;
const W_HOLD   = 15;     // Top-10 share (EOA, excl contracts & burns)

/* ================== Utils ================== */
const $ = id => document.getElementById(id);
const setStatus = t => { $("status").textContent = t; $("stage").textContent = t; };
const niceUSD = v => (v==null||isNaN(v)) ? "‚Äî" : new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:2}).format(+v);
const niceNum = v => (v==null||isNaN(v)) ? "‚Äî" : new Intl.NumberFormat('en-US').format(+v);
const short = a => a.slice(0,6)+"‚Ä¶"+a.slice(-4);
const pct = v => isFinite(v) ? v.toFixed(2)+"%" : "‚Äî";
const fmtScore = v => new Intl.NumberFormat('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2}).format(+v||0);
function p90(arr){
  const xs = arr.filter(v=>isFinite(v)&&v>0).sort((a,b)=>a-b);
  if(!xs.length) return 0;
  const idx = Math.ceil(xs.length*0.9)-1;
  return xs[Math.max(0,Math.min(xs.length-1,idx))];
}
function clock(ms){ const s=Math.floor(ms/1000); const m=Math.floor(s/60); const rs=s%60; return (m?m+"m ":"")+rs+"s"; }
function scoreClass(s){ if(s>=75) return 'good'; if(s>=60) return 'ok'; if(s>=40) return 'warn'; return 'bad'; }
function clamp01(x){ return Math.max(0,Math.min(1,x)); }

/* ================== Fetchers ================== */
async function loadPools(){
  const r = await fetch(POOLS_URL,{cache:'no-cache'}); if(!r.ok) throw new Error('pools '+r.status);
  const js = await r.json(); return js?.data || [];
}
async function loadVotes(){
  try{
    const u = WORKER + encodeURIComponent("https://holderradar.com/api/votes/ranking?period=30d&limit=100");
    const r = await fetch(u,{cache:'no-cache'}); if(!r.ok) throw new Error('votes '+r.status);
    return await r.json();
  }catch(e){ console.warn("votes failed", e); return []; }
}
async function loadCreators(){
  const url = "https://pepu-mainnet2-pumppad.0sum.io/subgraphs/name/launchpad";
  const query = `
    query Q { presales(orderBy:blockTimestamp, orderDirection:desc, first:1000){
      token minter blockTimestamp
    } }`;
  try{
    const r = await fetch(url,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({query})});
    if(!r.ok) throw new Error('gql '+r.status);
    const js = await r.json();
    const map = new Map();
    (js?.data?.presales||[]).forEach(p=>{
      const key = (p.token||"").toLowerCase();
      const ts  = Number(p.blockTimestamp||0);
      const prev= map.get(key);
      if(!prev || ts>prev.blockTimestamp) map.set(key,{minter:(p.minter||"").toLowerCase(),blockTimestamp:ts});
    });
    return map;
  }catch(e){ console.warn("gql creators failed", e); return new Map(); }
}
async function fetchJsonRelay(url){
  const r = await fetch(WORKER+encodeURIComponent(url),{cache:'no-cache'}); if(!r.ok) throw new Error('relay '+r.status);
  return r.json();
}

// Top holders (EOA only), paginate until N or pages exhausted
async function fetchTopHolders(token, N=10, maxPages=10){
  const base = `${EXPLORER}/api/v2/tokens/${token}/holders`;
  let js = await fetchJsonRelay(base);
  if(!js?.items) return { raw: [], top: [] };
  const burnSet = new Set(BURNS.map(a=>a.toLowerCase()));

  let eoa = (js.items||[])
    .map(it=>({ address:(it.address?.hash)||"", is_contract:!!(it.address?.is_contract), value:BigInt(it.value||"0") }))
    .filter(it=> it.address && !burnSet.has(it.address.toLowerCase()) && !it.is_contract && it.value>0n);

  let next = js.next_page_params; let page = 1;
  while(eoa.length < N && next && page < maxPages){
    const qp = new URLSearchParams(); for(const k in next) qp.set(k,String(next[k]));
    js = await fetchJsonRelay(base+"?"+qp.toString());
    const more = (js.items||[])
      .map(it=>({ address:(it.address?.hash)||"", is_contract:!!(it.address?.is_contract), value:BigInt(it.value||"0") }))
      .filter(it=> it.address && !burnSet.has(it.address.toLowerCase()) && !it.is_contract && it.value>0n);
    eoa = eoa.concat(more);
    next = js.next_page_params; page++;
  }
  eoa.sort((a,b)=> (a.value<b.value?1:-1));
  return { raw: eoa, top: eoa.slice(0,N) };
}

/* ================== Onchain helpers ================== */
async function getLocksAndSupply(token){
  const erc = new ethers.Contract(token, ERC20, ro);
  const [dec, total, ...burns] = await Promise.all([
    erc.decimals().catch(()=>18),
    erc.totalSupply().catch(()=>ethers.BigNumber.from(0)),
    ...BURNS.map(a=>erc.balanceOf(a).catch(()=>ethers.BigNumber.from(0)))
  ]);
  let burned = ethers.BigNumber.from(0); for(const b of burns) burned=burned.add(b);
  const locker = new ethers.Contract(LOCKER, LOCKER_ABI, ro);
  const [ids, owners, amounts, unlocks] = await locker.getActiveLocksByToken(token,0,1000).catch(()=>[[],[],[],[]]);

  const now = Math.floor(Date.now()/1000);
  let totalLocked = ethers.BigNumber.from(0), sumRem=0, cnt=0;
  const ownerTotals = new Map();
  for(let i=0;i<amounts.length;i++){
    const amt = amounts[i]; totalLocked=totalLocked.add(amt);
    const own = owners[i].toLowerCase();
    ownerTotals.set(own,(ownerTotals.get(own)||ethers.BigNumber.from(0)).add(amt));
    const rem = Number(unlocks[i])-now; if(rem>0){ sumRem+=rem; cnt++; }
  }
  const avgDays = cnt ? (sumRem/cnt)/86400 : 0;
  return { dec, total, burned, totalLocked, avgDays, ownerTotals };
}

/* ================== Scoring ================== */
function sLockedPct(p){ const cap = Math.min(p,50); return +(W_LOCKED*(cap/50)).toFixed(2); }
function sLockTime(days){ if(days>=180)return 10; if(days>=90)return 8; if(days>=30)return 6; if(days>=7)return 3; return 0; }
function sDev(creatorLocked){ return creatorLocked? W_DEV : 0; }
function sAge(days){ if(days>=90)return 10; if(days>=30)return 7; if(days>=7)return 4; return 1; }
function sDepth(reserve,p90v){ if(!p90v) return 0; const x=clamp01(reserve/p90v); return +(W_HEALTH_DEPTH*x).toFixed(2); }
function sVol(vol,res){ if(!res || vol<=0) return 0; const x=Math.min(1, Math.sqrt(vol/res)); return +(W_HEALTH_VOL*x).toFixed(2); }
function sVotes(v,max){ if(!max) return 0; return +(W_VOTES*(Math.min(v,max)/max)).toFixed(2); }
function sHold(top10){ if(top10==null || !isFinite(top10)) return 0; if(top10<=20) return 15; if(top10<=40) return 9; if(top10<=60) return 5; return 0; }

/* ================== State & leaders ================== */
let POOLS=[], CREATOR=new Map(), P90=0;
let ROWS_ALL=[];
let LEADERS={ score:0 };
function computeLeaders(){ LEADERS.score = Math.max(0, ...ROWS_ALL.map(r=>r.score)); }

/* ================== Progress ================== */
let START_TS=0, DONE=0, TOTAL=0;
function showOverlay(show){ $("overlay").style.display = show? 'grid':'none'; }
function updateProgress(){ const p = TOTAL? Math.min(100,Math.max(0,(DONE/TOTAL)*100)) : 0; $("count").textContent=`${DONE} / ${TOTAL}`; $("progressFill").style.width=p.toFixed(1)+"%"; $("elapsed").textContent=clock(Date.now()-START_TS); }

/* ================== Build ================== */
$("search").oninput=()=> render();
$("sorter").onchange=()=> render();
$("reload").onclick=()=> boot();

async function computeHoldersForRow(row){
  const holders = await fetchTopHolders(row.ca,10,10);
  const totalBI  = BigInt(row.totalBI);
  const burnedBI = BigInt(row.burnedBI);
  const lockedBI = BigInt(row.lockedBI);
  const denomAdj = totalBI>burnedBI ? (totalBI - burnedBI) : 0n;
  const denomCirc= denomAdj>lockedBI ? (denomAdj - lockedBI) : 0n;
  const top10Sum = holders.raw.slice(0,10).reduce((a,b)=>a+b.value,0n);
  const top10Share = denomCirc>0n ? Number(top10Sum*10000n/denomCirc)/100 : null;
  return { top10Share };
}

async function hydrateHoldersInBackground(){
  const targets = ROWS_ALL.filter(r=> r.top10Share == null);
  let idx=0; const CONC=3;
  async function runner(){
    while(idx < targets.length){
      const r = targets[idx++];
      try{
        const { top10Share } = await computeHoldersForRow(r);
        r.top10Share = top10Share; r.p_hold = sHold(top10Share);
        r.score = +(r.p_locked+r.p_time+r.p_dev+r.p_age+r.p_depth+r.p_vol+r.p_votes+r.p_hold).toFixed(2);
        computeLeaders(); render();
      }catch(e){ /* ignore per-token */ }
    }
  }
  await Promise.all(Array.from({length:CONC},()=>runner()));
}

async function boot(){
  try{
    showOverlay(true); START_TS=Date.now(); DONE=0; TOTAL=0; updateProgress();
    setStatus("Loading pools‚Ä¶"); POOLS = await loadPools(); TOTAL = POOLS.length; updateProgress();
    P90 = p90(POOLS.map(p=>Number(p.reserve_in_usd||0)));

    setStatus("Loading votes‚Ä¶");
    const votesArr = await loadVotes();
    const vmap = new Map(); let vmax=0;
    votesArr.forEach(v=>{ const ca=(v.contract||"").toLowerCase(); const n=Number(v.votes||0); vmap.set(ca,n); if(n>vmax)vmax=n; });

    setStatus("Loading creators‚Ä¶"); CREATOR = await loadCreators();

    setStatus("Scanning tokens‚Ä¶"); ROWS_ALL=[]; const MAX_CONC=4; let i=0; const FIRST_PAINT_COUNT=10; let firstPainted=false;

    async function worker(){
      while(i<POOLS.length){
        const pool = POOLS[i++], ca=(pool.address||"").toLowerCase();
        if(!ca){ DONE++; updateProgress(); continue; }
        try{
          const { dec,total,burned,totalLocked,avgDays,ownerTotals } = await getLocksAndSupply(ca);
          const totalN = Number(ethers.utils.formatUnits(total,dec));
          const burnedN= Number(ethers.utils.formatUnits(burned,dec));
          const lockedN= Number(ethers.utils.formatUnits(totalLocked,dec));
          const adjusted = Math.max(0, totalN - burnedN);
          const lockedPct = adjusted>0 ? (lockedN/adjusted*100) : 0;

          const cr = CREATOR.get(ca)||{minter:null,blockTimestamp:null};
          const ageDays = cr.blockTimestamp ? Math.floor((Date.now()/1000 - cr.blockTimestamp)/86400) : 0;
          let creatorLocked=false; if(cr.minter){ const tot = ownerTotals.get(cr.minter)||ethers.BigNumber.from(0); creatorLocked = tot.gt(0); }

          const v = vmap.get(ca)||0; const reserve = Number(pool.reserve_in_usd||0); const vol24 = Number(pool.volume_24h_usd||0);

          // eager holders only for first paint; rest background
          let top10Share=null; try{
            if(DONE < FIRST_PAINT_COUNT){
              const tmp = await computeHoldersForRow({ ca, totalBI: total.toString(), burnedBI: burned.toString(), lockedBI: totalLocked.toString() });
              top10Share = tmp.top10Share;
            }
          }catch(e){ top10Share=null; }

          const p_locked = sLockedPct(lockedPct);
          const p_time   = sLockTime(avgDays);
          const p_dev    = sDev(creatorLocked);
          const p_age    = sAge(ageDays);
          const p_depth  = sDepth(reserve,P90);
          const p_vol    = sVol(vol24,reserve);
          const p_votes  = sVotes(v,vmax);
          const p_hold   = sHold(top10Share);
          const score    = +(p_locked+p_time+p_dev+p_age+p_depth+p_vol+p_votes+p_hold).toFixed(2);

          ROWS_ALL.push({
            ca, pool, totalN, burnedN, lockedN, adjusted,
            lockedPct, avgDays, reserve, vol24, votes:v, votesMax:vmax,
            creator: cr.minter, ageDays, top10Share,
            p_locked,p_time,p_dev,p_age,p_depth,p_vol,p_votes:p_votes,p_hold,
            score, hasLock: lockedN>0,
            totalBI: total.toString(), burnedBI: burned.toString(), lockedBI: totalLocked.toString()
          });
        }catch(e){ /* ignore token */ }
        finally{
          DONE++; updateProgress();
          if(!firstPainted && DONE>=FIRST_PAINT_COUNT){ firstPainted=true; computeLeaders(); showOverlay(false); render(); }
        }
      }
    }
    await Promise.all(Array.from({length:MAX_CONC},()=>worker()));

    computeLeaders(); hydrateHoldersInBackground(); setStatus("Ready"); showOverlay(false); render();
  }catch(e){ console.error(e); setStatus("Error: "+(e.message||String(e))); showOverlay(false); }
}

/* ================== Visual metric helpers ================== */
function metricHTML({name, ico, ratio, state, title}){
  const w = Math.round(clamp01(ratio||0)*100);
  return `<div class="metric ${state}" title="${title||name}"><span class="ico">${ico}</span><div class="mbar"><i style="width:${w}%"></i></div><span class="name">${name}</span></div>`;
}
function stateLock(pct){ if(!isFinite(pct)||pct<=0) return 'bad'; if(pct<5) return 'bad'; if(pct<15) return 'warn'; return 'ok'; }
function stateBool(ok){ return ok? 'ok':'bad'; }
function stateAge(days){ if(days<7) return 'bad'; if(days<30) return 'warn'; return 'ok'; }
function stateHealth(r){ if(r<0.3) return 'bad'; if(r<0.6) return 'warn'; return 'ok'; }
function stateVotes(r){ if(r<0.1) return 'bad'; if(r<0.5) return 'warn'; return 'ok'; }
function stateHold(top10){ if(top10==null) return ''; if(top10>60) return 'bad'; if(top10>40) return 'warn'; return 'ok'; }

function render(){
  const q = $("search").value.trim().toLowerCase();
  let list = ROWS_ALL.slice();
  if(q){ list = list.filter(r=>{ const sym=(r.pool.symbol||"").toLowerCase(), name=(r.pool.name||"").toLowerCase(); return r.ca.includes(q) || sym.includes(q) || name.includes(q); }); }

  const how = $("sorter").value;
  if(how==='score') list.sort((a,b)=> b.score - a.score);
  if(how==='locked') list.sort((a,b)=> b.lockedPct - a.lockedPct);
  if(how==='mc') list.sort((a,b)=> Number(b.pool.market_cap||0)-Number(a.pool.market_cap||0));
  if(how==='liq') list.sort((a,b)=> b.reserve - a.reserve);
  if(how==='age') list.sort((a,b)=> b.ageDays - a.ageDays);

  const leaderScore = Math.max(0, ...list.map(r=>r.score));

  const cards = $("cards"); cards.innerHTML = "";
  list.forEach((r)=>{
    const link = `https://www.toshtech.xyz/toshdashboard.html?token=${r.ca}`;
    const sym = r.pool.symbol||""; const name= r.pool.name||""; const price = r.pool.price, mc=r.pool.market_cap;

    const total = r.totalN||0; const burnW = total>0 ? (r.burnedN/total*100) : 0; const lockW = total>0 ? (r.lockedN/total*100) : 0; const circW = Math.max(0, 100 - burnW - lockW);

    const scoreCls = scoreClass(r.score);
    const crown = (r.score>=leaderScore && leaderScore>0) ? ' üëë' : '';

    // Ratios for bars (no numbers in UI; only tooltips)
    const ratioLock   = clamp01((r.p_locked + r.p_time)/40);
    const ratioHealth = clamp01((r.p_depth + r.p_vol)/W_HEALTH);
    const ratioVotes  = clamp01((r.p_votes)/W_VOTES);
    const ratioHold   = (r.top10Share==null)? 0 : clamp01((60 - Math.min(60, r.top10Share))/60); // lower share = better

    const el = document.createElement('div');
    el.className="card";
    el.innerHTML = `
      <div class="token-head">
        <div class="token-title">
          <a class="sym" href="${link}" target="_blank">${sym || name || short(r.ca)}</a>
          <div class="sub">${name || sym} ‚Ä¢ <span class="mono">${short(r.ca)}</span></div>
          <div class="sub">Price: $${Number(price||0).toFixed(8)}</div>
        </div>
        <div class="score-badge ${scoreCls}" title="ToshScore">
          ${scoreRingSVG(r.score)}
          <div style="display:flex;flex-direction:column;align-items:center;z-index:1">
            <div class="score-num">${fmtScore(r.score)}${crown}</div>
            <div class="score-lbl">ToshScore</div>
          </div>
        </div>
      </div>

      <div class="rowchips">
        <span class="chip mono">${short(r.ca)}</span>
        <span class="chip">MC ${niceUSD(mc)}</span>
        <span class="chip">Liq ${niceUSD(r.reserve)}</span>
        <span class="chip">Age ${r.ageDays}d</span>
        ${!r.hasLock? `<span class="chip bad">No lock</span>` : ''}
      </div>

      <!-- Six visual metrics: Lock ‚Ä¢ Dev ‚Ä¢ Age ‚Ä¢ Health ‚Ä¢ Community ‚Ä¢ Distribution -->
      <div class="metrics">
        ${metricHTML({name:'Lock',  ico:'üîí', ratio:ratioLock,   state:stateLock(r.lockedPct),  title:`Locked ${pct(r.lockedPct)} ‚Ä¢ Time ${r.p_time}/10`})}
        ${metricHTML({name:'Dev',   ico:'üßë\u200düíª', ratio:r.p_dev?1:0, state:stateBool(!!r.p_dev), title:r.p_dev? 'Creator lock: yes' : 'Creator lock: no'})}
        ${metricHTML({name:'Age',   ico:'‚è≥', ratio:clamp01(r.p_age/W_AGE), state:stateAge(r.ageDays), title:`${r.ageDays} days`})}
        ${metricHTML({name:'Health',ico:'üíß', ratio:ratioHealth, state:stateHealth(ratioHealth), title:`Depth ${r.p_depth}/${W_HEALTH_DEPTH} ‚Ä¢ Turnover ${r.p_vol}/${W_HEALTH_VOL}`})}
        ${metricHTML({name:'Community',ico:'üó≥', ratio:ratioVotes, state:stateVotes(ratioVotes), title:`Votes ${(r.votes||0)}`})}
        ${metricHTML({name:'Distribution', ico:'üë•', ratio:ratioHold, state:stateHold(r.top10Share), title: (r.top10Share==null? 'Top-10: pending‚Ä¶' : `Top-10: ${r.top10Share.toFixed(2)}%`) })}
      </div>

      <details class="more">
        <summary>Details</summary>
        <div class="brow"><div>Locked %</div><div>${pct(r.lockedPct)} <span class="muted">(${(r.p_locked+r.p_time).toFixed(1)}/40)</span></div></div>
        <div class="bar" title="Burn / Locked / Circulating (of total)">
          <i class="seg-burn"   style="width:${burnW.toFixed(2)}%"></i>
          <i class="seg-locked" style="width:${lockW.toFixed(2)}%"></i>
          <i class="seg-circ"   style="width:${circW.toFixed(2)}%"></i>
        </div>
        <div class="brow" style="margin-top:6px"><div>Total</div><div>${niceNum(r.totalN)} ‚Ä¢ üî• ${niceNum(r.burnedN)} ‚Ä¢ üîí ${niceNum(r.lockedN)} ‚Ä¢ ‚úÖ ${niceNum(Math.max(0,r.totalN-r.burnedN-r.lockedN))}</div></div>
      </details>
    `;
    cards.appendChild(el);
  });
}

/* ============== Score ring ============== */
function scoreRingSVG(score){
  const s = Math.max(0,Math.min(100,score));
  const r = 40, c=2*Math.PI*r, o=c*(1-s/100);
  return `<svg class="ring" viewBox="0 0 120 120" aria-hidden="true">
    <circle cx="60" cy="60" r="40" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="10"/>
    <circle cx="60" cy="60" r="40" fill="none" stroke="url(#g)" stroke-width="10" stroke-linecap="round"
            stroke-dasharray="${c.toFixed(2)}" stroke-dashoffset="${o.toFixed(2)}"/>
    <defs>
      <linearGradient id="g" x1="0" x2="1">
        <stop offset="0%" stop-color="var(--accent)"/>
        <stop offset="100%" stop-color="var(--accent2)"/>
      </linearGradient>
    </defs>
  </svg>`;
}

/* ================== Run ================== */
showOverlay(false);
boot();
</script>
</body>
</html>
