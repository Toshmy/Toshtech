<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ToshLock ‚Äî Dashboard (Active Locks)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0c1222; --bg-2:#0b1226; --fg:#e8fff6; --muted:#a8ffd9;
      --accent:#00ffae; --accent-2:#00d99c; --card:rgba(255,255,255,.05);
      --border:rgba(0,255,174,.2); --shadow:0 0 30px rgba(0,255,174,.18);
    }
    html,body{margin:0;background:radial-gradient(circle at 20% 10%, #1a2238 0%, var(--bg) 70%);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    a{color:#93c5fd;text-decoration:none}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .glow-text{text-shadow:0 0 12px var(--accent),0 0 24px var(--accent)}
    .card{background:var(--card);border:1px solid var(--border);backdrop-filter:blur(6px);border-radius:14px;box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    .pill{display:inline-block;padding:.25rem .65rem;border-radius:999px;background:#081021;border:1px solid var(--border);color:#a8ffd9}
    .badge{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:#113327;border:1px solid var(--border);color:#00ffae}
    input,button{border-radius:12px;border:1px solid var(--border);background:#0f1730;color:#fff;padding:10px}
    input:focus,button:focus{outline:2px solid var(--accent)}
    .btn{cursor:pointer;background:linear-gradient(135deg, var(--accent), var(--accent-2));color:#00251b;border:0;font-weight:700}
    .btn.gray{background:linear-gradient(135deg,#64748b,#475569);color:#eef5ff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.12);font-size:13px;white-space:nowrap}
    th{text-align:left;background:var(--bg-2)}
    .table-scroll{overflow:auto;border-radius:12px}
    .section-title{margin:0 0 12px}
    .progress{height:8px;background:#0f1730;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}
    td:nth-child(1), th:nth-child(1){ white-space:nowrap; }
  </style>

  <!-- ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1 class="glow-text">üìä ToshLock ‚Äî Active Locks</h1>

    <!-- Token Status -->
    <section class="card" style="margin-bottom:18px">
      <h2 class="section-title">Token Status</h2>
      <div class="row">
        <input id="token" class="mono" placeholder="0x... token" style="flex:1 1 380px;min-width:240px">
        <button id="scan" class="btn">Load Active Locks</button>
        <span id="count" class="pill">‚Äî</span>
        <span id="total" class="pill">Total: ‚Äî</span>
      </div>

      <div id="rankWrap" style="margin-top:8px;display:none">
        <div class="row">
          <span id="rankSummary" class="pill">Rank signals: ‚Äî</span>
        </div>
        <div class="progress" style="margin-top:8px"><i id="totalFill"></i></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="exportCsv" class="btn gray">Download CSV</button>
        <button id="exportJson" class="btn gray">Download JSON</button>
        <span class="pill" title="Use URL like ?dev=0x... or &devs=0x..,0x.. to mark verified owners">Verified via URL</span>
      </div>

      <div class="table-scroll card" style="margin-top:12px;padding:0">
        <table>
          <thead>
            <tr>
              <th>Unlock</th><th style="text-align:right">Amount</th><th>Symbol</th>
              <th>Name</th><th>Owner</th><th>Lock ID</th><th>Proof</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <pre id="log" style="margin-top:12px;max-height:160px;overflow:auto;white-space:pre-wrap;word-break:break-word"></pre>
    </section>

    <!-- Wallet + Token view -->
    <section class="card">
      <h2 class="section-title">Wallet Locks (by Token)</h2>
      <div class="row">
        <input id="token2" class="mono" placeholder="0x... token" style="flex:1 1 300px;min-width:220px">
        <input id="wallet" class="mono" placeholder="0x... wallet" style="flex:1 1 300px;min-width:220px">
        <button id="scanWallet" class="btn gray">Load</button>
      </div>

      <div class="table-scroll card" style="margin-top:12px;padding:0">
        <table>
          <thead>
            <tr>
              <th>Unlock</th><th style="text-align:right">Amount</th><th>Symbol</th>
              <th>Name</th><th>Owner</th><th>Lock ID</th>
            </tr>
          </thead>
          <tbody id="rows2"></tbody>
        </table>
      </div>

      <pre id="log2" style="margin-top:12px;max-height:160px;overflow:auto;white-space:pre-wrap;word-break:break-word"></pre>
    </section>
  </div>

<script>
/* ===== Hardcoded env ===== */
const LOCKER   = "0x189ef775DcC7782802ca16b870Da7B5FaE3C8524";
const RPC      = "https://rpc-pepu-v2-testnet-vn4qxxp9og.t.conduit.xyz";

/* ===== ABIs ===== */
const ERC20 = [
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)"
];
const ERC20_EXTRA = [
  "function totalSupply() view returns (uint256)"
];
const LOCKER_ABI = [
  "function getActiveLocksByToken(address token,uint256 offset,uint256 limit) view returns (uint256[] lockIds,address[] owners,uint256[] amounts,uint256[] unlockTimes,string[] names)",
  "function getUserLockIds(address user,address token,uint256 offset,uint256 limit) view returns (uint256[] memory)",
  "function getLock(address token,uint256 lockId) view returns (address owner,uint256 amount,uint256 unlockTime,string name,bool active)"
];

const ro = new ethers.providers.JsonRpcProvider(RPC);
const lockerRO = new ethers.Contract(LOCKER, LOCKER_ABI, ro);

const $ = id=>document.getElementById(id);
const log = (...a)=>{ $("log").textContent += a.join(" ")+"\n"; };
const log2 = (...a)=>{ $("log2").textContent += a.join(" ")+"\n"; };

/* ===== Query params & helpers ===== */
const qs = new URLSearchParams(location.search);
const PARAM_TOKEN  = qs.get('token');
const PARAM_WALLET = qs.get('wallet');
const PARAM_DEV    = qs.get('dev');
const PARAM_DEVS   = (qs.get('devs')||"").split(',').filter(x=>/^0x[a-fA-F0-9]{40}$/.test(x));
const PepuExplorer = {
  address: (a) => `https://explorer-pepu-v2-testnet-vn4qxxp9og.t.conduit.xyz/address/${a}`,
  tx:      (h) => `https://explorer-pepu-v2-testnet-vn4qxxp9og.t.conduit.xyz/tx/${h}`,
};
function dl(filename, text) {
  const blob = new Blob([text], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}
function toCSV(rows) {
  if (!rows.length) return '';
  const head = Object.keys(rows[0]);
  const esc = v => `"${String(v).replace(/"/g,'""')}"`;
  return [head.join(','), ...rows.map(r => head.map(k=>esc(r[k]??'')).join(','))].join('\n');
}

/* ===== State ===== */
const state = { activeRows: [] };

/* ===== Token Status ===== */
$("scan").onclick = async () => {
  try{
    $("rows").innerHTML=""; $("count").textContent="Loading‚Ä¶"; $("total").textContent="Total: ‚Äî"; $("log").textContent="";
    $("rankWrap").style.display = "none"; state.activeRows = [];

    const token = $("token").value.trim();
    if(!/^0x[a-fA-F0-9]{40}$/.test(token)) throw new Error("Enter a valid token address");

    const erc = new ethers.Contract(token, ERC20, ro);
    const [sym, dec] = await Promise.all([erc.symbol().catch(()=>"?"), erc.decimals().catch(()=>18)]);

    const pageSize = 500, page = 0;
    const [ids, owners, amounts, unlockTimes, names] =
      await lockerRO.getActiveLocksByToken(token, page*pageSize, pageSize);

    const rows = $("rows");
    let total = ethers.BigNumber.from(0);
    const now = Math.floor(Date.now()/1000);
    const ownersCount = new Map(); // amount per owner

    for(let i=0;i<ids.length;i++){
      total = total.add(amounts[i]);
      const id    = ids[i];
      const owner = owners[i];
      const human = ethers.utils.formatUnits(amounts[i], dec);
      const date  = new Date(Number(unlockTimes[i])*1000).toLocaleString();
      const ownerDisp = owner.slice(0,6) + "‚Ä¶" + owner.slice(-4);

      const verified = (PARAM_DEV && owner.toLowerCase() === PARAM_DEV.toLowerCase())
                    || (PARAM_DEVS.length && PARAM_DEVS.map(x=>x.toLowerCase()).includes(owner.toLowerCase()));

      // export row
      state.activeRows.push({
        unlock: date,
        amount: human,
        symbol: sym,
        name: names[i] || "",
        owner,
        lockId: id.toString()
      });

      // track owner distribution
      ownersCount.set(owner, (ownersCount.get(owner)||ethers.BigNumber.from(0)).add(amounts[i]));

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${date} ${Number(unlockTimes[i])>now?'<span class="pill">‚è≥</span>':'<span class="pill">‚úÖ</span>'}</td>
        <td style="text-align:right">${Number(human).toLocaleString()}</td>
        <td>${sym}</td>
        <td>${names[i] || ""} ${verified? '<span class="badge" title="Verified dev">‚úÖ</span>':''}</td>
        <td class="mono" title="${owner}">
          <a href="${PepuExplorer.address(owner)}" target="_blank">${ownerDisp}</a>
        </td>
        <td>${id.toString()}</td>
        <td><button class="btn gray" data-proof="${id.toString()}">Proof</button></td>
      `;
      rows.appendChild(tr);
    }

    $("count").textContent = `Active: ${ids.length}`;
    $("total").textContent = `Total: ${ethers.utils.formatUnits(total, dec)} ${sym}`;

    // ToshRank: % locked vs totalSupply, avg remaining days, distribution
    let percentLocked = '‚Äî', avgDays = '‚Äî', dist = '‚Äî';
    try {
      const ercX = new ethers.Contract(token, ERC20.concat(ERC20_EXTRA), ro);
      const totalSupply = await ercX.totalSupply().catch(()=>null);
      if (totalSupply) {
        const totalHuman = Number(ethers.utils.formatUnits(total, dec));
        const supplyHuman = Number(ethers.utils.formatUnits(totalSupply, dec));
        if (supplyHuman > 0) {
          percentLocked = (totalHuman / supplyHuman * 100).toFixed(2) + '%';
          const pct = Math.min(100, Math.max(0, (totalHuman / supplyHuman * 100)));
          $("rankWrap").style.display = "";
          document.getElementById('totalFill').style.width = pct.toFixed(2)+'%';
        }
      }
      // avg remaining
      let sumSec = 0, cnt = 0;
      for (let i=0;i<ids.length;i++){
        const rem = Number(unlockTimes[i]) - now;
        if (rem > 0) { sumSec += rem; cnt++; }
      }
      if (cnt>0) avgDays = (sumSec / cnt / 86400).toFixed(1) + 'd';

      // distribution: top owner share
      let totals = Array.from(ownersCount.values());
      if (totals.length){
        // sort desc by numeric value
        totals.sort((a,b)=> (a.gt(b)? -1 : (b.gt(a)? 1 : 0))); // b then a ‚Äî adjust for desc properly
        const top = totals[0];
        const topPct = (Number(ethers.utils.formatUnits(top, dec)) / Number(ethers.utils.formatUnits(total, dec)) * 100).toFixed(1);
        dist = `${ownersCount.size} owners ‚Ä¢ top ${topPct}%`;
      }
    } catch {}
    $("rankSummary").textContent = `Locked: ${percentLocked} ‚Ä¢ Avg rem: ${avgDays} ‚Ä¢ Dist: ${dist}`;

    log("Done.");
  }catch(e){ log("‚ùå", e?.data?.message || e?.message || String(e)); }
};

/* ===== Proof button: open LiquidityLocked tx ===== */
document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('[data-proof]');
  if (!btn) return;
  btn.disabled = true; const lockId = btn.getAttribute('data-proof');
  try{
    const topic0 = ethers.utils.id("LiquidityLocked(address,address,uint256,uint256,uint256,string)");
    const topicLockId = ethers.utils.hexZeroPad(ethers.BigNumber.from(lockId).toHexString(), 32);
    const filter = { address: LOCKER, topics: [topic0, null, null, topicLockId], fromBlock: 0, toBlock: "latest" };
    const logs = await ro.getLogs(filter);
    if (!logs.length) { alert("No event found for this lockId"); btn.disabled=false; return; }
    const txh = logs[0].transactionHash;
    window.open(PepuExplorer.tx(txh), "_blank");
  }catch(err){ alert(err?.message || String(err)); }
  finally{ btn.disabled=false; }
});

/* ===== Export buttons ===== */
$("exportCsv").onclick = () => {
  if (!state.activeRows.length) return alert("Load a token first");
  const t = $("token").value.trim();
  dl(`active_locks_${t.slice(0,10)}.csv`, toCSV(state.activeRows));
};
$("exportJson").onclick = () => {
  if (!state.activeRows.length) return alert("Load a token first");
  const t = $("token").value.trim();
  dl(`active_locks_${t.slice(0,10)}.json`, JSON.stringify(state.activeRows, null, 2));
};

/* ===== Wallet + Token ===== */
$("scanWallet").onclick = async () => {
  try{
    $("rows2").innerHTML=""; $("log2").textContent="";
    const token = $("token2").value.trim();
    const wallet = $("wallet").value.trim();
    if(!/^0x[a-fA-F0-9]{40}$/.test(token)) throw new Error("Enter a valid token address");
    if(!/^0x[a-fA-F0-9]{40}$/.test(wallet)) throw new Error("Enter a valid wallet address");

    const erc = new ethers.Contract(token, ERC20, ro);
    const [sym, dec] = await Promise.all([erc.symbol().catch(()=>"?"), erc.decimals().catch(()=>18)]);

    const ids = await lockerRO.getUserLockIds(wallet, token, 0, 500);
    const details = await Promise.all(ids.map(id => lockerRO.getLock(token, id)));

    const rows = $("rows2");

    for(let i=0;i<ids.length;i++){
      const [owner, amount, unlockTime, name, active] = details[i];
      const human = ethers.utils.formatUnits(amount, dec);
      const date  = new Date(Number(unlockTime)*1000).toLocaleString();
      const ownerDisp = owner.slice(0,6) + "‚Ä¶" + owner.slice(-4);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${date}</td>
        <td style="text-align:right">${Number(human).toLocaleString()}</td>
        <td>${sym}</td>
        <td>${name || ""}</td>
        <td class="mono" title="${owner}">
          <a href="${PepuExplorer.address(owner)}" target="_blank">${ownerDisp}</a>
        </td>
        <td>${ids[i].toString()}</td>
      `;
      rows.appendChild(tr);
    }
    log2(`Locks loaded: ${ids.length}`);
  }catch(e){ log2("‚ùå", e?.data?.message || e?.message || String(e)); }
};

/* ===== Deep links ===== */
if (PARAM_TOKEN) {
  $("token").value = PARAM_TOKEN;
  $("scan").click();
}
if (PARAM_TOKEN && PARAM_WALLET) {
  $("token2").value = PARAM_TOKEN;
  $("wallet").value = PARAM_WALLET;
  $("scanWallet").click();
}
</script>
</body>
</html>
