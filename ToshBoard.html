<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>ToshBoard ‚Äî Mainnet ToshScore (Scorecards)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root{
    --bg:#0c1222; --bg2:#0b1226; --fg:#e8fff6; --muted:#a8ffd9;
    --accent:#00ffae; --accent2:#00d99c; --card:rgba(255,255,255,.05);
    --border:rgba(0,255,174,.2); --shadow:0 0 30px rgba(0,255,174,.18);
    --red:#ff6b6b; --green:#19f9a9; --blue:#49a8ff; --amber:#f6c945; --gray:#9aa3b2;
  }
  html,body{margin:0;background:radial-gradient(circle at 20% 10%, #1a2238 0%, var(--bg) 70%);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{max-width:1200px;margin:22px auto;padding:0 16px}
  .glow{ text-shadow:0 0 8px var(--accent), 0 0 18px var(--accent) }
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .between{justify-content:space-between}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:.25rem .6rem;border-radius:999px;background:#081021;border:1px solid var(--border);color:var(--muted);font-size:12px}
  input,button,select{border-radius:12px;border:1px solid var(--border);background:#0f1730;color:#fff;padding:10px}
  button{cursor:pointer}
  .btn{background:linear-gradient(135deg, var(--accent), var(--accent2));color:#00251b;border:0;font-weight:700}
  .btn.gray{background:linear-gradient(135deg,#64748b,#475569);color:#eef5ff}
  .muted{color:#bfeede}
  a{color:#93c5fd;text-decoration:none}
  .grid{display:grid;gap:12px}
  @media(min-width:700px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media(min-width:1024px){ .grid{grid-template-columns:repeat(3,1fr)} }

  .card{background:var(--card);border:1px solid var(--border);backdrop-filter:blur(6px);border-radius:16px;box-shadow:var(--shadow);padding:14px}
  .token-head{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
  .token-title{display:flex;flex-direction:column;gap:2px}
  .token-title .sym{font-weight:800;font-size:16px}
  .token-title .sub{font-size:12px;color:#bfeede}
  .score-badge{min-width:86px;min-height:86px;display:flex;align-items:center;justify-content:center;border-radius:12px;border:1px solid var(--border);background:#0b162f;position:relative}
  .score-num{font-size:22px;font-weight:900}
  .score-lbl{font-size:10px;color:#bfeede}
  .ring{position:absolute;inset:6px}
  .rowchips{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}
  .chip{border:1px solid var(--border);border-radius:999px;padding:.15rem .5rem;background:#0f1730;font-size:12px;white-space:nowrap}
  .chip.metric{display:inline-flex;align-items:center;gap:6px}
  .supply{margin-top:8px}
  .bar{height:10px;border-radius:999px;background:#0f1730;border:1px solid var(--border);display:flex;overflow:hidden}
  .seg-burn{background:var(--red)}
  .seg-locked{background:var(--blue)}
  .seg-circ{background:var(--green)}
  .breakdown{margin-top:10px;border-top:1px solid rgba(255,255,255,.08);padding-top:10px}
  .brow{display:flex;justify-content:space-between;gap:8px;font-size:12px;margin:4px 0}
  .bleft{color:#cfe}
  .bright{color:#cfe}
  .bad{color:var(--red)!important}
  .warn{color:var(--amber)!important}
  .ok{color:#86efac!important}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  .section-title{margin:16px 0 8px;font-weight:800}
  .footer-note{font-size:12px;color:#9fead1;margin-top:8px}

  /* Desktop inline metrics vs Mobile full scorecard */
  .metrics-line{display:none;gap:8px;flex-wrap:wrap;margin:8px 0}
  @media(min-width:1024px){
    .metrics-line{display:flex}
    .breakdown{display:none}
  }
  @media(max-width:1023px){
    .metrics-line{display:none}
    .breakdown{display:block}
  }

  /* Score badge coloring */
  .score-badge.good{box-shadow:0 0 0 1px rgba(34,197,94,.25), 0 0 22px rgba(34,197,94,.18)}
  .score-badge.ok{box-shadow:0 0 0 1px rgba(132,204,22,.25), 0 0 22px rgba(132,204,22,.18)}
  .score-badge.warn{box-shadow:0 0 0 1px rgba(245,158,11,.25), 0 0 22px rgba(245,158,11,.18)}
  .score-badge.bad{box-shadow:0 0 0 1px rgba(239,68,68,.25), 0 0 22px rgba(239,68,68,.18)}
  .score-badge.good .score-num{color:#34d399}
  .score-badge.ok .score-num{color:#a3e635}
  .score-badge.warn .score-num{color:#f59e0b}
  .score-badge.bad .score-num{color:#ef4444}

  /* loading overlay */
  .overlay{position:fixed;inset:0;background:rgba(6,10,24,.8);backdrop-filter:blur(3px);display:none;place-items:center;z-index:50}
  .overlay .panel{width:min(680px,92vw);background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
  .progress{height:12px;border-radius:999px;background:#0b1430;border:1px solid var(--border);overflow:hidden}
  .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2))}
</style>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
<div class="wrap">
  <header class="row between">
    <h1 class="glow" style="margin:0">üìä ToshBoard ‚Äî Mainnet ToshScore</h1>
    <div class="row">
      <input id="search" placeholder="Search name / symbol / 0x‚Ä¶" style="min-width:220px">
      <select id="sorter" title="Sort">
        <option value="score">Sort: Score (desc)</option>
        <option value="locked">Sort: Locked %</option>
        <option value="mc">Sort: Market Cap</option>
        <option value="liq">Sort: Liquidity</option>
        <option value="age">Sort: Age</option>
      </select>
      <button id="reload" class="btn gray">Reload</button>
      <span id="status" class="pill">Idle</span>
    </div>
  </header>

  <div id="cards" class="grid" style="margin-top:10px"></div>
  <div class="footer-note">Data: pools_cache.json (price/liquidity/24h vol), Launchpad subgraph (creator+age), Explorer via Worker (holders), HolderRadar via Worker (votes). P90 calculated across all pools‚Äô reserve_in_usd.</div>
</div>

<!-- Loading overlay with live progress (all tokens) -->
<div id="overlay" class="overlay">
  <div class="panel">
    <div class="row between" style="margin-bottom:8px">
      <div class="glow">Loading tokens‚Ä¶</div>
      <span id="count" class="pill">0 / 0</span>
    </div>
    <div class="progress" aria-label="overall loading progress"><i id="progressFill"></i></div>
    <div class="row between" style="margin-top:6px">
      <span class="muted" id="stage">Starting‚Ä¶</span>
      <span class="muted" id="elapsed">‚Äî</span>
    </div>
  </div>
</div>

<script>
/* ================== CONFIG (Mainnet only) ================== */
const RPC = "https://rpc-pepu-v2-mainnet-0.t.conduit.xyz";
const EXPLORER = "https://explorer-pepu-v2-mainnet-0.t.conduit.xyz";
const LOCKER = "0xCCEfe66507762370C2487dd198d7D1fEfc6dEF8F";
const WORKER = "https://odd-feather-f250.toshtech777.workers.dev/?url=";    // CORS relay
const POOLS_URL = "https://www.toshtech.xyz/pools_cache.json";                // local cache

const BURNS = [
  "0xa9fD599cd8857e90059c83e4885Dc09986039085",
  "0x000000000000000000000000000000000000dEaD"
];

const ERC20 = [
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function totalSupply() view returns (uint256)",
  "function balanceOf(address) view returns (uint256)"
];
const LOCKER_ABI = [
  "function getActiveLocksByToken(address token,uint256 offset,uint256 limit) view returns (uint256[] lockIds,address[] owners,uint256[] amounts,uint256[] unlockTimes,string[] names)"
];

const ro = new ethers.providers.JsonRpcProvider(RPC);

/* ================== Weights ================== */
const W_LOCKED = 30;     // Locked % (cap 50%)
const W_TIME   = 10;     // Avg remaining lock time
const W_DEV    = 10;     // Only ‚Äúcreator locked?‚Äù
const W_AGE    = 10;     // Age from GQL
// Responsive health: Depth 7 + Volume 8 (sqrt turnover)
const W_HEALTH_DEPTH = 7;
const W_HEALTH_VOL   = 8;
const W_HEALTH = W_HEALTH_DEPTH + W_HEALTH_VOL; // 15
const W_VOTES  = 10;
const W_HOLD   = 15;

/* ================== Utils ================== */
const $ = id => document.getElementById(id);
const setStatus = t => { $("status").textContent = t; $("stage").textContent = t; };
const niceUSD = v => (v==null||isNaN(v)) ? "‚Äî" : new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:2}).format(+v);
const niceNum = v => (v==null||isNaN(v)) ? "‚Äî" : new Intl.NumberFormat('en-US').format(+v);
const short = a => a.slice(0,6)+"‚Ä¶"+a.slice(-4);
const pct = v => isFinite(v) ? v.toFixed(2)+"%" : "‚Äî";
function p90(arr){
  const xs = arr.filter(v=>isFinite(v)&&v>0).sort((a,b)=>a-b);
  if(!xs.length) return 0;
  const idx = Math.ceil(xs.length*0.9)-1;
  return xs[Math.max(0,Math.min(xs.length-1,idx))];
}
function clock(ms){ const s=Math.floor(ms/1000); const m=Math.floor(s/60); const rs=s%60; return (m?m+"m ":"")+rs+"s"; }
function crown(show){ return show? " üëë":""; }
function bracketClass(v, a, b){ // return bad/warn/ok based on thresholds
  if(v<=a) return 'bad'; if(v<=b) return 'warn'; return 'ok';
}
function scoreClass(s){ if(s>=75) return 'good'; if(s>=60) return 'ok'; if(s>=40) return 'warn'; return 'bad'; }

/* ================== Fetchers ================== */
async function loadPools(){
  const r = await fetch(POOLS_URL,{cache:'no-cache'}); if(!r.ok) throw new Error('pools '+r.status);
  const js = await r.json(); return js?.data || [];
}
async function loadVotes(){
  try{
    const u = WORKER + encodeURIComponent("https://holderradar.com/api/votes/ranking?period=30d&limit=100");
    const r = await fetch(u,{cache:'no-cache'}); if(!r.ok) throw new Error('votes '+r.status);
    return await r.json();
  }catch(e){ console.warn("votes failed", e); return []; }
}
async function loadCreators(){
  const url = "https://pepu-mainnet2-pumppad.0sum.io/subgraphs/name/launchpad";
  const query = `
    query Q { presales(orderBy:blockTimestamp, orderDirection:desc, first:1000){
      token minter blockTimestamp
    } }`;
  try{
    const r = await fetch(url,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({query})});
    if(!r.ok) throw new Error('gql '+r.status);
    const js = await r.json();
    const map = new Map();
    (js?.data?.presales||[]).forEach(p=>{
      const key = (p.token||"").toLowerCase();
      const ts  = Number(p.blockTimestamp||0);
      const prev= map.get(key);
      if(!prev || ts>prev.blockTimestamp) map.set(key,{minter:(p.minter||"").toLowerCase(),blockTimestamp:ts});
    });
    return map;
  }catch(e){ console.warn("gql creators failed", e); return new Map(); }
}
async function fetchJsonRelay(url){
  const r = await fetch(WORKER+encodeURIComponent(url),{cache:'no-cache'}); if(!r.ok) throw new Error('relay '+r.status);
  return r.json();
}

// Fetch top holders (EOA only), paginate until we have N (or out of pages)
async function fetchTopHolders(token, N=10, maxPages=10){
  const base = `${EXPLORER}/api/v2/tokens/${token}/holders`;
  let js = await fetchJsonRelay(base);
  if(!js?.items) return { raw: [], top: [] };
  const burnSet = new Set(BURNS.map(a=>a.toLowerCase()));

  let eoa = (js.items||[])
    .map(it=>({ address:(it.address?.hash)||"", is_contract:!!(it.address?.is_contract), value:BigInt(it.value||"0") }))
    .filter(it=> it.address && !burnSet.has(it.address.toLowerCase()) && !it.is_contract && it.value>0n);

  let next = js.next_page_params; let page = 1;
  while(eoa.length < N && next && page < maxPages){
    const qp = new URLSearchParams(); for(const k in next) qp.set(k,String(next[k]));
    js = await fetchJsonRelay(base+"?"+qp.toString());
    const more = (js.items||[])
      .map(it=>({ address:(it.address?.hash)||"", is_contract:!!(it.address?.is_contract), value:BigInt(it.value||"0") }))
      .filter(it=> it.address && !burnSet.has(it.address.toLowerCase()) && !it.is_contract && it.value>0n);
    eoa = eoa.concat(more);
    next = js.next_page_params; page++;
  }
  eoa.sort((a,b)=> (a.value<b.value?1:-1));
  return { raw: eoa, top: eoa.slice(0,N) };
}

/* ================== Onchain helpers ================== */
async function getLocksAndSupply(token){
  const erc = new ethers.Contract(token, ERC20, ro);
  const [dec, total, ...burns] = await Promise.all([
    erc.decimals().catch(()=>18),
    erc.totalSupply().catch(()=>ethers.BigNumber.from(0)),
    ...BURNS.map(a=>erc.balanceOf(a).catch(()=>ethers.BigNumber.from(0)))
  ]);
  let burned = ethers.BigNumber.from(0); for(const b of burns) burned=burned.add(b);
  const locker = new ethers.Contract(LOCKER, LOCKER_ABI, ro);
  const [ids, owners, amounts, unlocks] = await locker.getActiveLocksByToken(token,0,1000).catch(()=>[[],[],[],[]]);

  const now = Math.floor(Date.now()/1000);
  let totalLocked = ethers.BigNumber.from(0), sumRem=0, cnt=0;
  const ownerTotals = new Map();
  for(let i=0;i<amounts.length;i++){
    const amt = amounts[i]; totalLocked=totalLocked.add(amt);
    const own = owners[i].toLowerCase();
    ownerTotals.set(own,(ownerTotals.get(own)||ethers.BigNumber.from(0)).add(amt));
    const rem = Number(unlocks[i])-now; if(rem>0){ sumRem+=rem; cnt++; }
  }
  const avgDays = cnt ? (sumRem/cnt)/86400 : 0;
  return { dec, total, burned, totalLocked, avgDays, ownerTotals };
}

/* ================== Scoring (continuous activity) ================== */
function sLockedPct(p){ const cap = Math.min(p,50); return +(W_LOCKED*(cap/50)).toFixed(2); }
function sLockTime(days){ if(days>=180)return 10; if(days>=90)return 8; if(days>=30)return 6; if(days>=7)return 3; return 0; }
function sDev(creatorLocked){ return creatorLocked? W_DEV : 0; }
function sAge(days){ if(days>=90)return 10; if(days>=30)return 7; if(days>=7)return 4; return 1; }
function sDepth(reserve,p90v){ if(!p90v) return 0; const x=Math.max(0,Math.min(1,reserve/p90v)); return +(W_HEALTH_DEPTH*x).toFixed(2); }
function sVol(vol,res){
  if(!res || vol<=0) return 0;
  const r = vol/res;              // 1.0 = full turnover per day
  const x = Math.min(1, Math.sqrt(r)); // diminishing returns
  return +(W_HEALTH_VOL * x).toFixed(2);
}
function sVotes(v,max){ if(!max) return 0; return +(W_VOTES*(Math.min(v,max)/max)).toFixed(2); }
function sHold(top10){
  if(top10==null || !isFinite(top10)) return 0;
  if(top10<=20) return 15;
  if(top10<=40) return 9;
  if(top10<=60) return 5;
  return 0;
}

/* ================== State & leaders ================== */
let POOLS=[], CREATOR=new Map(), P90=0;
let ROWS_ALL=[];
let LEADERS={ lock:0, time:0, dev:0, age:0, depth:0, vol:0, votes:0, hold:0, score:0 };

function computeLeaders(){
  LEADERS.lock = Math.max(0, ...ROWS_ALL.map(r=>r.p_locked));
  LEADERS.time = Math.max(0, ...ROWS_ALL.map(r=>r.p_time));
  LEADERS.dev  = Math.max(0, ...ROWS_ALL.map(r=>r.p_dev));
  LEADERS.age  = Math.max(0, ...ROWS_ALL.map(r=>r.p_age));
  LEADERS.depth= Math.max(0, ...ROWS_ALL.map(r=>r.p_depth));
  LEADERS.vol  = Math.max(0, ...ROWS_ALL.map(r=>r.p_vol));
  LEADERS.votes= Math.max(0, ...ROWS_ALL.map(r=>r.p_votes));
  LEADERS.hold = Math.max(0, ...ROWS_ALL.map(r=>r.p_hold));
  LEADERS.score= Math.max(0, ...ROWS_ALL.map(r=>r.score));
}
function isLeader(val, key, eps=0.01){ return Math.abs(val - (LEADERS[key]||0)) <= eps && val>0; }

/* ================== Progress ================== */
let START_TS=0, DONE=0, TOTAL=0;
function showOverlay(show){ $("overlay").style.display = show? 'grid':'none'; }
function updateProgress(){
  const pct = TOTAL? Math.min(100,Math.max(0, (DONE/TOTAL)*100)) : 0;
  $("count").textContent = `${DONE} / ${TOTAL}`;
  $("progressFill").style.width = pct.toFixed(1)+"%";
  $("elapsed").textContent = clock(Date.now()-START_TS);
}

/* ================== Build ================== */
$("search").oninput=()=> render();
$("sorter").onchange=()=> render();
$("reload").onclick=()=> boot();

async function computeHoldersForRow(row){
  const holders = await fetchTopHolders(row.ca,10,10);
  const totalBI  = BigInt(row.totalBI);
  const burnedBI = BigInt(row.burnedBI);
  const lockedBI = BigInt(row.lockedBI);
  const denomAdj = totalBI>burnedBI ? (totalBI - burnedBI) : 0n;
  const denomCirc= denomAdj>lockedBI ? (denomAdj - lockedBI) : 0n;
  const top10Sum = holders.raw.slice(0,10).reduce((a,b)=>a+b.value,0n);
  const top10Share = denomCirc>0n ? Number(top10Sum*10000n/denomCirc)/100 : null;
  const topHolders = holders.top.map(h=>({
    address: h.address,
    pctAdj:  denomAdj>0n  ? Number(h.value*10000n/denomAdj)/100  : 0,
    pctTotal: totalBI>0n  ? Number(h.value*10000n/totalBI)/100   : 0,
    pctCirc:  denomCirc>0n? Number(h.value*10000n/denomCirc)/100 : 0
  }));
  return { top10Share, topHolders };
}

async function hydrateHoldersInBackground(){
  const targets = ROWS_ALL.filter(r=> r.top10Share == null);
  let idx=0; const CONC=3;
  async function runner(){
    while(idx < targets.length){
      const r = targets[idx++];
      try{
        const { top10Share, topHolders } = await computeHoldersForRow(r);
        r.top10Share = top10Share; r.topHolders = topHolders; r.p_hold = sHold(top10Share);
        r.score = +(r.p_locked+r.p_time+r.p_dev+r.p_age+r.p_depth+r.p_vol+r.p_votes+r.p_hold).toFixed(2);
        computeLeaders();
        render();
      }catch(e){ /* ignore per-token */ }
    }
  }
  await Promise.all(Array.from({length:CONC},()=>runner()));
}

async function boot(){
  try{
    showOverlay(true); START_TS=Date.now(); DONE=0; TOTAL=0; updateProgress();
    setStatus("Loading pools‚Ä¶");
    POOLS = await loadPools(); TOTAL = POOLS.length; updateProgress();
    P90 = p90(POOLS.map(p=>Number(p.reserve_in_usd||0)));

    setStatus("Loading votes‚Ä¶");
    const votesArr = await loadVotes();
    const vmap = new Map(); let vmax=0;
    votesArr.forEach(v=>{ const ca=(v.contract||"").toLowerCase(); const n=Number(v.votes||0); vmap.set(ca,n); if(n>vmax)vmax=n; });

    setStatus("Loading creators‚Ä¶");
    CREATOR = await loadCreators();

    setStatus("Scanning tokens‚Ä¶");
    ROWS_ALL=[];
    const MAX_CONC=4; let i=0;
    const FIRST_PAINT_COUNT = 10; let firstPainted=false;

    async function worker(){
      while(i<POOLS.length){
        const pool = POOLS[i++], ca=(pool.address||"").toLowerCase();
        if(!ca) { DONE++; updateProgress(); continue; }
        try{
          const { dec,total,burned,totalLocked,avgDays,ownerTotals } = await getLocksAndSupply(ca);
          const totalN = Number(ethers.utils.formatUnits(total,dec));
          const burnedN= Number(ethers.utils.formatUnits(burned,dec));
          const lockedN= Number(ethers.utils.formatUnits(totalLocked,dec));
          const adjusted = Math.max(0, totalN - burnedN);
          const lockedPct = adjusted>0 ? (lockedN/adjusted*100) : 0;

          const cr = CREATOR.get(ca)||{minter:null,blockTimestamp:null};
          const ageDays = cr.blockTimestamp ? Math.floor((Date.now()/1000 - cr.blockTimestamp)/86400) : 0;

          let creatorLocked=false;
          if(cr.minter){
            const tot = ownerTotals.get(cr.minter)||ethers.BigNumber.from(0);
            creatorLocked = tot.gt(0);
          }

          const v = vmap.get(ca)||0;
          const reserve = Number(pool.reserve_in_usd||0);
          const vol24   = Number(pool.volume_24h_usd||0);

          // early holders for first paint items only (rest hydrated bg)
          let top10Share=null, topHolders=[];
          try{
            if(DONE < FIRST_PAINT_COUNT){
              const { top10Share:ts, topHolders:th } = await computeHoldersForRow({
                ca,
                totalBI: total.toString(), burnedBI: burned.toString(), lockedBI: totalLocked.toString()
              });
              top10Share = ts; topHolders = th;
            }
          }catch(e){ top10Share=null; topHolders=[]; }

          const p_locked = sLockedPct(lockedPct);
          const p_time   = sLockTime(avgDays);
          const p_dev    = sDev(creatorLocked);
          const p_age    = sAge(ageDays);
          const p_depth  = sDepth(reserve,P90);
          const p_vol    = sVol(vol24,reserve);
          const p_votes  = sVotes(v,vmax);
          const p_hold   = sHold(top10Share);
          const score    = +(p_locked+p_time+p_dev+p_age+p_depth+p_vol+p_votes+p_hold).toFixed(2);

          const row = {
            ca, pool, totalN, burnedN, lockedN, adjusted,
            lockedPct, avgDays, reserve, vol24, votes:v, votesMax:vmax,
            creator: cr.minter, ageDays, top10Share,
            topHolders,
            p_locked,p_time,p_dev,p_age,p_depth,p_vol,p_votes:p_votes,p_hold,
            score, hasLock: lockedN>0,
            totalBI: total.toString(), burnedBI: burned.toString(), lockedBI: totalLocked.toString()
          };
          ROWS_ALL.push(row);
        }catch(e){ /* ignore one token */ }
        finally{
          DONE++; updateProgress();
          if(!firstPainted && DONE>=FIRST_PAINT_COUNT){ firstPainted=true; computeLeaders(); showOverlay(false); render(); }
        }
      }
    }
    await Promise.all(Array.from({length:MAX_CONC},()=>worker()));

    // Finalize
    computeLeaders();
    hydrateHoldersInBackground();
    setStatus("Ready");
    showOverlay(false);
    render();
  }catch(e){
    console.error(e);
    setStatus("Error: "+(e.message||String(e)));
    showOverlay(false);
  }
}

/* ============== Helpers: category mini-bars & score ring ============== */
function catBarHTML(val, max){
  const pct = max? Math.max(0,Math.min(100,(val/max)*100)) : 0;
  return `<div class="chip metric"><span class="muted">${(val||0).toFixed(1)}</span>/<span class="muted">${max}</span></div>`;
}
function scoreRingSVG(score){
  const s = Math.max(0,Math.min(100,score));
  const r = 36, c=2*Math.PI*r, o=c*(1-s/100);
  return `<svg class="ring" viewBox="0 0 100 100" aria-hidden="true">
    <circle cx="50" cy="50" r="36" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="8"/>
    <circle cx="50" cy="50" r="36" fill="none" stroke="url(#g)" stroke-width="8" stroke-linecap="round"
            stroke-dasharray="${c.toFixed(2)}" stroke-dashoffset="${o.toFixed(2)}"/>
    <defs>
      <linearGradient id="g" x1="0" x2="1">
        <stop offset="0%" stop-color="var(--accent)"/>
        <stop offset="100%" stop-color="var(--accent2)"/>
      </linearGradient>
    </defs>
  </svg>`;
}

/* ================== Render ================== */
function render(){
  const q = $("search").value.trim().toLowerCase();
  let list = ROWS_ALL.slice();

  if(q){
    list = list.filter(r=>{
      const sym=(r.pool.symbol||"").toLowerCase(), name=(r.pool.name||"").toLowerCase();
      return r.ca.includes(q) || sym.includes(q) || name.includes(q);
    });
  }

  const how = $("sorter").value;
  if(how==='score') list.sort((a,b)=> b.score - a.score);
  if(how==='locked') list.sort((a,b)=> b.lockedPct - a.lockedPct);
  if(how==='mc') list.sort((a,b)=> Number(b.pool.market_cap||0)-Number(a.pool.market_cap||0));
  if(how==='liq') list.sort((a,b)=> b.reserve - a.reserve);
  if(how==='age') list.sort((a,b)=> b.ageDays - a.ageDays);

  cards.innerHTML = "";
  list.forEach((r)=>{
    const link = `https://www.toshtech.xyz/toshdashboard.html?token=${r.ca}`;
    const sym = r.pool.symbol||"";
    const name= r.pool.name||"";
    const price = r.pool.price, mc=r.pool.market_cap;

    const total = r.totalN||0;
    const burnW = total>0 ? (r.burnedN/total*100) : 0;
    const lockW = total>0 ? (r.lockedN/total*100) : 0;
    const circW = Math.max(0, 100 - burnW - lockW);

    const scoreCls = scoreClass(r.score);

    const el = document.createElement('div');
    el.className="card";
    el.innerHTML = `
      <div class="token-head">
        <div class="token-title">
          <a class="sym" href="${link}" target="_blank">${sym || name || short(r.ca)}</a>
          <div class="sub">${name || sym} ‚Ä¢ <span class="mono">${short(r.ca)}</span></div>
          <div class="sub">Price: $${Number(price||0).toFixed(8)}</div>
        </div>
        <div class="score-badge ${scoreCls}" title="ToshScore">
          ${scoreRingSVG(r.score)}
          <div style="display:flex;flex-direction:column;align-items:center;z-index:1">
            <div class="score-num">${r.score.toFixed(0)}${crown(isLeader(r.score,'score'))}</div>
            <div class="score-lbl">ToshScore</div>
          </div>
        </div>
      </div>

      <div class="rowchips">
        <span class="chip mono">${short(r.ca)}</span>
        <span class="chip">MC ${niceUSD(mc)}</span>
        <span class="chip">Liq ${niceUSD(r.reserve)}</span>
        <span class="chip">24h Vol ${niceUSD(r.vol24)}</span>
        <span class="chip">Age ${r.ageDays}d</span>
        ${!r.hasLock? `<span class="chip bad">No lock</span>` : ''}
      </div>

      <!-- Desktop inline metrics -->
      <div class="metrics-line">
        <span class="chip metric ${bracketClass(r.lockedPct,5,15)}">üîí ${pct(r.lockedPct)}${crown(isLeader(r.p_locked,'lock')||isLeader(r.p_time,'time'))}</span>
        <span class="chip metric ${bracketClass(r.p_depth, W_HEALTH_DEPTH*0.3, W_HEALTH_DEPTH*0.6)}">üíß ${(r.p_depth).toFixed(1)}/${W_HEALTH_DEPTH}${crown(isLeader(r.p_depth,'depth'))}</span>
        <span class="chip metric ${bracketClass(r.p_vol, W_HEALTH_VOL*0.3, W_HEALTH_VOL*0.6)}">üîÑ ${(r.p_vol).toFixed(1)}/${W_HEALTH_VOL}${crown(isLeader(r.p_vol,'vol'))}</span>
        <span class="chip metric ${r.p_dev? 'ok':'bad'}">üßë‚Äçüíª ${r.p_dev? 'Dev lock‚úÖ':'Dev lock‚ùå'}${crown(isLeader(r.p_dev,'dev'))}</span>
        <span class="chip metric ${bracketClass(r.ageDays,7,30).replace('ok','ok')}">‚è≥ ${r.ageDays}d${crown(isLeader(r.p_age,'age'))}</span>
        <span class="chip metric ${r.top10Share==null? '' : (r.top10Share>60?'bad':(r.top10Share>40?'warn':'ok'))}">üë• ${r.top10Share==null ? 'Holders‚Ä¶' : r.top10Share.toFixed(1)+'%'}${crown(isLeader(r.p_hold,'hold'))}</span>
        <span class="chip metric ${bracketClass(r.p_votes,1,5)}">üó≥ ${(r.p_votes).toFixed(1)}/${W_VOTES}${crown(isLeader(r.p_votes,'votes'))}</span>
      </div>

      <!-- Mobile detailed scorecard -->
      <div class="breakdown">
        <div class="brow"><div class="bleft"><strong>Liquidity Lock</strong></div><div class="bright">${(r.p_locked+r.p_time).toFixed(1)}/40</div></div>
        <div class="brow"><div class="bleft">‚Ä¢ Locked % (cap 50%)</div><div class="bright ${bracketClass(r.lockedPct,5,15)}">${r.p_locked.toFixed(1)}/${W_LOCKED}${crown(isLeader(r.p_locked,'lock'))}</div></div>
        <div class="brow"><div class="bleft">‚Ä¢ Time safety (avg ${r.avgDays.toFixed(1)}d)</div><div class="bright ${r.p_time>=8?'ok':(r.p_time>=3?'warn':'bad')}">${r.p_time}/${W_TIME}${crown(isLeader(r.p_time,'time'))}</div></div>

        <div class="brow"><div class="bleft"><strong>Dev Transparency</strong></div><div class="bright ${r.p_dev? 'ok':'bad'}">${r.p_dev}/${W_DEV}${crown(isLeader(r.p_dev,'dev'))}</div></div>
        <div class="brow"><div class="bleft">‚Ä¢ Creator locked?</div><div class="bright ${r.p_dev? 'ok':'bad'}">${r.p_dev? 'yes':'no'}</div></div>

        <div class="brow"><div class="bleft"><strong>Age & Consistency</strong></div><div class="bright">${r.p_age}/${W_AGE}${crown(isLeader(r.p_age,'age'))}</div></div>
        <div class="brow"><div class="bleft">‚Ä¢ Age days</div><div class="bright ${r.ageDays<7?'bad':(r.ageDays<30?'warn':'ok')}">${r.ageDays}</div></div>

        <div class="brow"><div class="bleft"><strong>On-chain health</strong></div><div class="bright">${(r.p_depth+r.p_vol).toFixed(1)}/${W_HEALTH}</div></div>
        <div class="brow"><div class="bleft">‚Ä¢ Depth vs P90</div><div class="bright ${bracketClass(r.p_depth, W_HEALTH_DEPTH*0.3, W_HEALTH_DEPTH*0.6)}">${r.p_depth.toFixed(1)}/${W_HEALTH_DEPTH}${crown(isLeader(r.p_depth,'depth'))}</div></div>
        <div class="brow"><div class="bleft">‚Ä¢ 24h turnover</div><div class="bright ${bracketClass(r.p_vol, W_HEALTH_VOL*0.3, W_HEALTH_VOL*0.6)}">${r.p_vol.toFixed(1)}/${W_HEALTH_VOL}${crown(isLeader(r.p_vol,'vol'))}</div></div>

        <div class="brow"><div class="bleft"><strong>Community</strong></div><div class="bright ${bracketClass(r.p_votes,1,5)}">${r.p_votes}/${W_VOTES}${crown(isLeader(r.p_votes,'votes'))}</div></div>
        <div class="brow"><div class="bleft">‚Ä¢ Votes 30d</div><div class="bright">${niceNum(r.votes)}</div></div>

        <div class="brow"><div class="bleft"><strong>Holders Quality</strong></div><div class="bright ${r.top10Share==null? '' : (r.top10Share>60?'bad':(r.top10Share>40?'warn':'ok'))}">${r.p_hold}/${W_HOLD}${crown(isLeader(r.p_hold,'hold'))}</div></div>
        <div class="brow"><div class="bleft">‚Ä¢ Top-10 share (excl. contracts, vs circulating)</div><div class="bright ${r.top10Share==null? '': (r.top10Share>60?'bad':(r.top10Share>40?'warn':'ok'))}">${r.top10Share==null ? 'Pending‚Ä¶' : r.top10Share.toFixed(2)+'%'}</div></div>

        <details class="holders">
          <summary>Top holders (percent of circulating, excludes burns & contracts)</summary>
          <div class="holders-list">
            ${r.topHolders && r.topHolders.length ? r.topHolders.map((h,i)=>`<div><span>#${i+1} <span class="mono">${short(h.address)}</span></span><span>${Number(h.pctCirc ?? 0).toFixed(2)}%</span></div>`).join("") : '<div class="muted">Fetching‚Ä¶</div>'}
          </div>
        </details>
      </div>

      <div class="supply">
        <div class="bar" title="Burn / Locked / Circulating (of total)">
          <i class="seg-burn"   style="width:${burnW.toFixed(2)}%"></i>
          <i class="seg-locked" style="width:${lockW.toFixed(2)}%"></i>
          <i class="seg-circ"   style="width:${circW.toFixed(2)}%"></i>
        </div>
        <div class="sub" style="margin-top:6px">
          Total: ${niceNum(r.totalN)} ‚Ä¢ üî• ${niceNum(r.burnedN)} ‚Ä¢ üîí ${niceNum(r.lockedN)} ‚Ä¢ ‚úÖ ${niceNum(Math.max(0,r.totalN-r.burnedN-r.lockedN))}
        </div>
      </div>
    `;
    cards.appendChild(el);
  });
}

/* ================== Run ================== */
showOverlay(false);
boot();
</script>
</body>
</html>
