<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ToshLock ‚Äî Dashboard (Active Locks)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0c1222;--fg:#fff;--card:rgba(255,255,255,.06);--border:rgba(255,255,255,.12)}
    body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0}
    .wrap{max-width:1100px;margin:32px auto;padding:0 18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid var(--border);font-size:13px}
    th{text-align:left;background:#0b1226}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    input,button{border-radius:10px;padding:8px 10px;border:1px solid var(--border);background:#0f1730;color:#fff}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  </style>

  <!-- ethers v5 (read-only usage here) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>üìä ToshLock ‚Äî Active Locks (Global)</h1>

  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <div class="row">
          <button id="scan">Scan</button>
          <span id="count" style="opacity:.85;font-size:12px">‚Äî</span>
        </div>
        <div class="row" style="margin-top:6px">
          <label class="row" style="gap:6px">From Block <input id="from" class="mono" style="width:120px"></label>
          <label class="row" style="gap:6px">To Block <input id="to" class="mono" style="width:120px" placeholder="latest"></label>
        </div>
      </div>
      <div style="opacity:.85;font-size:12px">
        Contract: <span class="mono">0xdAaf‚Ä¶9c01</span> ‚Ä¢ Chain: <span class="mono">97741</span>
      </div>
    </div>

    <div class="card" style="margin-top:12px;padding:0">
      <table>
        <thead>
          <tr>
            <th>Lock ID</th><th>Token</th><th>Name</th>
            <th>Owner</th><th style="text-align:right">Amount</th>
            <th>Symbol</th><th>Unlock</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <pre id="log" class="card" style="margin-top:12px;height:180px;overflow:auto"></pre>
  </section>
</div>

<script>
/* ===== Hardcoded env ===== */
const LOCKER = "0xdAafaf8fC73C6D4dfE27B2494Bdc864D0f7C9c01";
const RPC    = "https://rpc-pepu-v2-testnet-vn4qxxp9og.t.conduit.xyz";
const DEFAULT_FROM = 97740;

/* ===== ABIs ===== */
const ERC20 = [
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)"
];
const LOCKER_ABI = [
  "event LiquidityLocked(address indexed token,address indexed user,uint256 indexed lockId,uint256 amount,uint256 unlockTime,string name)",
  "function getLock(address token,address user,uint256 lockId) view returns (uint256 amount,uint256 unlockTime,string name)"
];

const ro = new ethers.providers.JsonRpcProvider(RPC);
const iface = new ethers.utils.Interface(LOCKER_ABI);
const $ = id=>document.getElementById(id);
const log = (...a)=>{ $("log").textContent += a.join(" ")+"\n"; };

$("from").value = DEFAULT_FROM;

$("scan").onclick = async () => {
  try{
    $("rows").innerHTML=""; $("count").textContent="Scanning‚Ä¶"; $("log").textContent="";
    const from = Number($("from").value||DEFAULT_FROM);
    const toIn = $("to").value.trim();
    const latest = await ro.getBlockNumber();
    const to = toIn ? Number(toIn) : latest;

    const topic = iface.getEventTopic("LiquidityLocked");
    const CHUNK=50_000; let logs=[];
    for(let start=from; start<=to; start+=CHUNK){
      const end = Math.min(start+CHUNK-1, to);
      const part = await ro.getLogs({address:LOCKER, fromBlock:start, toBlock:end, topics:[topic]});
      logs = logs.concat(part);
    }
    log("events:", logs.length);

    const metaCache = new Map();
    const tokenMeta = async (addr)=>{
      const k=addr.toLowerCase(); if(metaCache.has(k)) return metaCache.get(k);
      try{
        const t = new ethers.Contract(addr, ERC20, ro);
        const [sym,dec] = await Promise.all([t.symbol().catch(()=>"?"), t.decimals().catch(()=>18)]);
        const v={sym,dec:Number(dec)}; metaCache.set(k,v); return v;
      }catch{ return {sym:"?",dec:18}; }
    };

    const now = Math.floor(Date.now()/1000); let count=0;
    for(const lg of logs){
      let ev; try{ ev = iface.parseLog(lg); }catch{ continue; }
      const { token, user, lockId, amount, unlockTime, name } = ev.args;

      // Check current lock (amount may have changed)
      let cur; try{ cur = await new ethers.Contract(LOCKER, LOCKER_ABI, ro).getLock(token, user, lockId); }catch{ continue; }
      const amt = cur.amount ?? cur[0];
      const ut  = cur.unlockTime ?? cur[1];
      const nm  = cur.name ?? cur[2];

      if (!amt || amt.toString()==="0") continue; // already unlocked
      if (ut.toNumber() <= now) continue;         // not active

      const meta = await tokenMeta(token);
      const human = ethers.utils.formatUnits(amt, meta.dec);
      const date  = new Date(ut.toNumber()*1000).toLocaleString();

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${lockId.toString()}</td>
        <td class="mono" title="${token}">${token.slice(0,6)}‚Ä¶${token.slice(-4)}</td>
        <td>${nm || ""}</td>
        <td class="mono" title="${user}">${user.slice(0,6)}‚Ä¶${user.slice(-4)}</td>
        <td style="text-align:right">${Number(human).toLocaleString()}</td>
        <td>${meta.sym}</td>
        <td>${date}</td>
      `;
      $("rows").appendChild(tr);
      count++;
    }
    $("count").textContent = `Active locks: ${count}`;
    log("Done.");
  }catch(e){ log("‚ùå", e?.data?.message || e?.message || String(e)); }
};
</script>
</body>
</html>
