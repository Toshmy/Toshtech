<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ToshLock ‚Äî Projects with Active Locks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0c1222; --bg-2:#0b1226; --fg:#e8fff6; --muted:#a8ffd9;
      --accent:#00ffae; --accent-2:#00d99c; --card:rgba(255,255,255,.05);
      --border:rgba(0,255,174,.2); --shadow:0 0 30px rgba(0,255,255,.18);
      --green:#00ffae; --red:#ff6b6b;
    }
    html,body{margin:0;background:radial-gradient(circle at 20% 10%, #1a2238 0%, var(--bg) 70%);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    a{color:#93c5fd;text-decoration:none}
    .wrap{max-width:1150px;margin:24px auto;padding:0 16px}
    .glow-text{text-shadow:0 0 12px var(--accent),0 0 24px var(--accent)}
    .card{background:var(--card);border:1px solid var(--border);backdrop-filter:blur(6px);border-radius:14px;box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-block;padding:.25rem .6rem;border-radius:999px;background:#081021;border:1px solid var(--border);color:#a8ffd9}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.12);font-size:13px;white-space:nowrap}
    th{text-align:left;background:var(--bg-2);position:sticky;top:0}
    .table-scroll{overflow:auto;border-radius:12px}
    .progress{height:8px;background:#0f1730;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent), var(--accent-2));width:0%}
    .supplybar{height:10px;background:#0f1730;border:1px solid var(--border);border-radius:6px;display:flex;overflow:hidden}
    .supplybar .circ{background:var(--green);height:100%}
    .supplybar .burn{background:var(--red);height:100%}
    .muted{color:var(--muted);opacity:.92}
    .small{font-size:12px;color:#bfeede}
    .center{display:flex;align-items:center;justify-content:center;padding:18px;color:#bfeede}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    th.sortable{cursor:pointer}
    th.sortable .dir{opacity:.75;font-size:12px;margin-left:4px}

    /* NEW: make the supply cell more compact & mobile-friendly */
    td.supply-cell{min-width:180px;white-space:normal}
    @media (max-width: 640px){
      td.supply-cell{min-width:140px}
      td.supply-cell .small{font-size:11px;line-height:1.25}
      /* allow token cell to wrap CA nicely on small screens */
      td.token-cell{white-space:normal}
      td.token-cell .mono{word-break:break-all}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="row" style="justify-content:space-between;margin-bottom:10px">
      <h1 class="glow-text" style="margin:0">üèÜ ToshLock ‚Äî Projects with Active Locks</h1>
      <span id="status" class="pill">Loading‚Ä¶</span>
    </header>

    <section class="table-scroll card" style="padding:0">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Token</th>
            <th>Event Date</th>
            <th>Locked %</th>
            <th>Unlock Date</th>
            <th id="thTVL" class="sortable">TVL<span class="dir" id="dirTVL"></span></th>
            <th>Supply (Adjusted)</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
      <div id="empty" class="center" style="display:none">No active locks found.</div>
    </section>

    <pre id="log" class="card muted" style="margin-top:12px;display:none"></pre>
  </div>

<script>
/* ============== CONFIG (Testnet default) ============== */
const CONFIG = {
    LOCKER: "0xCCEfe66507762370C2487dd198d7D1fEfc6dEF8F",
    RPC:    "https://rpc-pepu-v2-mainnet-0.t.conduit.xyz",
    EXPLORER: "https://explorer-pepu-v2-mainnet-0.t.conduit.xyz"
};
/* pools cache file */
const POOLS_JSON_URL = "pools_cache.json";
/* burn addresses */
const BURN_ADDRS = [
  "0xa9fD599cd8857e90059c83e4885Dc09986039085",
  "0x000000000000000000000000000000000000dEaD"
];
/* ABIs */
const ERC20 = [
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function totalSupply() view returns (uint256)",
  "function balanceOf(address) view returns (uint256)"
];
const LOCKER_ABI = [
  "event LiquidityLocked(address indexed token,address indexed user,uint256 indexed lockId,uint256 amount,uint256 unlockTime,string name)",
  "function getActiveLocksByToken(address token,uint256 offset,uint256 limit) view returns (uint256[] lockIds,address[] owners,uint256[] amounts,uint256[] unlockTimes,string[] names)"
];

/* ============== HELPERS ============== */
const $ = id => document.getElementById(id);
const log = (...a)=>{ const el=$("log"); el.style.display='block'; el.textContent += a.join(" ")+"\n"; };
function shortAddr(a){ return a.slice(0,6)+"‚Ä¶"+a.slice(-4); }
function fmtNum(n){ return Number(n).toLocaleString(); }
function bnToNum(bn, decimals){ try{ return Number(ethers.utils.formatUnits(bn, decimals)); }catch{ return 0; } }
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;"," >":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
function toLower(a){ try{ return ethers.utils.getAddress(a).toLowerCase(); }catch{ return (a||"").toLowerCase(); } }

/* time formatters */
function timeAgo(ts){
  if (!ts) return "‚Äî";
  const s = Math.max(1, Math.floor((Date.now()/1000 - ts)));
  const m = Math.floor(s/60), h=Math.floor(m/60), d=Math.floor(h/24), mo=Math.floor(d/30);
  if (mo>=1) return `${mo} month${mo>1?'s':''} ago`;
  if (d>=1)  return `${d} day${d>1?'s':''} ago`;
  if (h>=1)  return `${h} hour${h>1?'s':''} ago`;
  if (m>=1)  return `${m} min${m>1?'s':''} ago`;
  return `${s} sec ago`;
}
/* NEW: symmetric formatter for future/past (so Unlock Date matches Event Date style) */
function timeFromNow(ts){
  if (!ts) return "‚Äî";
  const now = Math.floor(Date.now()/1000);
  const diff = ts - now;
  const abs = Math.abs(diff);
  const m = Math.floor(abs/60), h=Math.floor(m/60), d=Math.floor(h/24), mo=Math.floor(d/30);
  const unit = mo>=1 ? [mo,"month"] : d>=1 ? [d,"day"] : h>=1 ? [h,"hour"] : m>=1 ? [m,"min"] : [abs,"sec"];
  const [val, label] = unit;
  return diff >= 0 ? `in ${val} ${label}${val>1?'s':''}` : `${val} ${label}${val>1?'s':''} ago`;
}

/* ============== Providers/Contracts ============== */
const ro = new ethers.providers.JsonRpcProvider(CONFIG.RPC);
const locker = new ethers.Contract(CONFIG.LOCKER, LOCKER_ABI, ro);

/* ============== Load market caps ============== */
let marketCaps = new Map(); // address-> {mc, name, symbol}
async function loadMarketCaps(){
  marketCaps.clear();
  try{
    const r = await fetch(POOLS_JSON_URL, { cache: "no-cache" });
    if (!r.ok) return;
    const js = await r.json();
    const rows = Array.isArray(js) ? js : (js.data || []);
    for (const row of rows){
      const addr = (row.address || "").toLowerCase();
      if(/^0x[a-fA-F0-9]{40}$/.test(addr)){
        marketCaps.set(addr, {
          mc: Number(row.market_cap || 0),
          name: row.name || "",
          symbol: row.symbol || ""
        });
      }
    }
  }catch(e){ /* silent if file missing */ }
}

/* ============== Discover tokens with active locks ============== */
async function discoverLockedTokens(){
  const topic0 = ethers.utils.id("LiquidityLocked(address,address,uint256,uint256,uint256,string)");
  const latest = await ro.getBlockNumber();
  const fromBlock = Math.max(0, latest - 800_000); // window
  const logs = await ro.getLogs({ address: locker.address, topics: [topic0], fromBlock, toBlock: "latest" });
  const tokens = new Set();
  for (const lg of logs){
    const token = "0x" + lg.topics[1].slice(26);
    tokens.add(token.toLowerCase());
  }
  return Array.from(tokens);
}

/* ============== Token meta / supply / locks ============== */
async function getTokenMetaAndSupply(token){
  const t = new ethers.Contract(token, ERC20, ro);
  const [name, symbol, decimals, total, ...burns] = await Promise.all([
    t.name().catch(()=>""), t.symbol().catch(()=>""), t.decimals().catch(()=>18),
    t.totalSupply().catch(()=>ethers.BigNumber.from(0)),
    ...BURN_ADDRS.map(a => t.balanceOf(a).catch(()=>ethers.BigNumber.from(0)))
  ]);
  let burned = ethers.BigNumber.from(0);
  for (const b of burns) burned = burned.add(b);
  const adjusted = total.sub(burned);
  return { name, symbol, decimals:Number(decimals), total, burned, adjusted };
}

async function getLocksSummary(token){
  const [ids, owners, amounts, unlockTimes] =
    await locker.getActiveLocksByToken(token, 0, 1000).catch(()=>[[],[],[],[]]);

  let sum = ethers.BigNumber.from(0);
  let earliestUnlock = null;
  for (let i=0;i<ids.length;i++){
    sum = sum.add(amounts[i]);
    const ut = Number(unlockTimes[i]);
    if (!earliestUnlock || ut < earliestUnlock) earliestUnlock = ut;
  }

  // Latest lock event timestamp for this token
  let latestTs = null;
  try{
    const topic0 = ethers.utils.id("LiquidityLocked(address,address,uint256,uint256,uint256,string)");
    const tokenTopic = ethers.utils.hexZeroPad(token, 32);
    const logs = await ro.getLogs({
      address: locker.address,
      topics: [topic0, tokenTopic],
      fromBlock: Math.max(0, (await ro.getBlockNumber()) - 300_000),
      toBlock: "latest"
    });
    if (logs.length){
      const last = logs.reduce((a,b)=> a.blockNumber > b.blockNumber ? a : b);
      const blk = await ro.getBlock(last.blockNumber);
      latestTs = blk?.timestamp || null;
    }
  }catch{}

  return { sumLocked: sum, earliestUnlock: earliestUnlock || null, latestEvent: latestTs || null };
}

/* small concurrency control */
function pLimit(max){
  let running=0, queue=[];
  const next=()=>{ running--; if(queue.length) queue.shift()(); };
  return fn=>new Promise((res,rej)=>{
    const run=()=>{ running++; Promise.resolve().then(fn).then(v=>{res(v);next();},e=>{rej(e);next();}); };
    if(running<max) run(); else queue.push(run);
  });
}

/* ============== Render ============== */
let DATA = []; // rows to render
let tvlSortDir = -1; // -1 desc, 1 asc

function tokenCellHTML(p){
  const explorerLink = `${CONFIG.EXPLORER}/address/${p.address}`;
  const nameLine = `<div class="small">${escapeHtml(p.name||'')}</div>`;
  const caLine = `
    <div class="small mono">
      <a href="${explorerLink}" target="_blank" rel="noopener noreferrer" title="${p.address}">
        ${p.address}
      </a>
    </div>`;
  return `
    <a href="https://www.toshtech.xyz/tdbv8.html?token=${p.address}" class="mono" target="_blank">${escapeHtml(p.symbol||'')}</a>
    ${nameLine}
    ${caLine}
  `;
}

function render(){
  const rowsEl = $("rows");
  rowsEl.innerHTML = "";
  if (!DATA.length){ $("empty").style.display=""; return; }
  $("empty").style.display="none";

  // default order by Locked % desc
  const byLocked = [...DATA].sort((a,b)=> b.lockedPct - a.lockedPct);

  byLocked.forEach((p,i)=>{
    const latest = p.latestEvent ? timeAgo(p.latestEvent) : "‚Äî";
    const nextU  = p.nextUnlock ? timeFromNow(p.nextUnlock) : "‚Äî";
    const lockedPctClamped = isFinite(p.lockedPct) ? Math.max(0, Math.min(100, p.lockedPct)) : 0;

    const totalHuman  = p.totalHuman;
    const burnedHuman = p.burnedHuman;
    const circHuman   = Math.max(0, totalHuman - burnedHuman);
    const totalForBar = totalHuman > 0 ? totalHuman : (circHuman + burnedHuman || 1);
    const circPct = Math.max(0, Math.min(100, (circHuman / totalForBar) * 100));
    const burnPct = Math.max(0, Math.min(100, (burnedHuman / totalForBar) * 100));

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td class="token-cell">
        ${tokenCellHTML(p)}
      </td>
      <td>${latest}</td>
      <td style="min-width:160px">
        <div class="progress"><i style="width:${lockedPctClamped.toFixed(2)}%"></i></div>
        <div class="small">${lockedPctClamped.toFixed(2)}%</div>
      </td>
      <td>${nextU}</td>
      <td data-tvl="${p.tvl}" style="text-align:right">$${fmtNum((p.tvl||0).toFixed(2))}</td>
      <td class="supply-cell">
        <div class="supplybar">
          <div class="circ" style="width:${circPct.toFixed(2)}%"></div>
          <div class="burn" style="width:${burnPct.toFixed(2)}%"></div>
        </div>
        <div class="small">
          Circulating: ${fmtNum(circHuman)} ‚Ä¢ Burned: ${fmtNum(burnedHuman)} ‚Ä¢ Total: ${fmtNum(totalHuman)}
        </div>
      </td>
    `;
    rowsEl.appendChild(tr);
  });

  $("status").textContent = `Projects: ${byLocked.length}`;
}

function resortByTVL(){
  const dir = tvlSortDir; // -1 desc, 1 asc
  DATA.sort((a,b)=> dir * ((b.tvl||0) - (a.tvl||0)));
  const arrow = dir === -1 ? "‚ñº" : "‚ñ≤";
  $("dirTVL").textContent = arrow;

  const rowsEl = $("rows");
  rowsEl.innerHTML = "";
  if (!DATA.length){ $("empty").style.display=""; return; }
  $("empty").style.display="none";

  DATA.forEach((p,i)=>{
    const latest = p.latestEvent ? timeAgo(p.latestEvent) : "‚Äî";
    const nextU  = p.nextUnlock ? timeFromNow(p.nextUnlock) : "‚Äî";
    const lockedPctClamped = isFinite(p.lockedPct) ? Math.max(0, Math.min(100, p.lockedPct)) : 0;

    const totalHuman  = p.totalHuman;
    const burnedHuman = p.burnedHuman;
    const circHuman   = Math.max(0, totalHuman - burnedHuman);
    const totalForBar = totalHuman > 0 ? totalHuman : (circHuman + burnedHuman || 1);
    const circPct = Math.max(0, Math.min(100, (circHuman / totalForBar) * 100));
    const burnPct = Math.max(0, Math.min(100, (burnedHuman / totalForBar) * 100));

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td class="token-cell">
        ${tokenCellHTML(p)}
      </td>
      <td>${latest}</td>
      <td style="min-width:160px">
        <div class="progress"><i style="width:${lockedPctClamped.toFixed(2)}%"></i></div>
        <div class="small">${lockedPctClamped.toFixed(2)}%</div>
      </td>
      <td>${nextU}</td>
      <td style="text-align:right">$${fmtNum((p.tvl||0).toFixed(2))}</td>
      <td class="supply-cell">
        <div class="supplybar">
          <div class="circ" style="width:${circPct.toFixed(2)}%"></div>
          <div class="burn" style="width:${burnPct.toFixed(2)}%"></div>
        </div>
        <div class="small">
          Circulating: ${fmtNum(circHuman)} ‚Ä¢ Burned: ${fmtNum(burnedHuman)} ‚Ä¢ Total: ${fmtNum(totalHuman)}
        </div>
      </td>
    `;
    rowsEl.appendChild(tr);
  });
}

/* ============== Load + Build ============== */
async function build(){
  $("status").textContent = "Loading‚Ä¶";
  await loadMarketCaps();

  const tokenList = await discoverLockedTokens();
  if (!tokenList.length){ $("empty").style.display=""; $("status").textContent="No active locks"; return; }

  const limit = pLimit(5);
  const results = (await Promise.all(tokenList.map(addr => limit(async ()=>{
    try{
      const { sumLocked, earliestUnlock, latestEvent } = await getLocksSummary(addr);
      if (!sumLocked || sumLocked.isZero()) return null;

      const meta  = await getTokenMetaAndSupply(addr);
      const lockedHuman = bnToNum(sumLocked, meta.decimals);
      if (lockedHuman <= 0) return null;

      const totalHuman    = bnToNum(meta.total, meta.decimals);
      const burnedHuman   = bnToNum(meta.burned, meta.decimals);
      const adjustedHuman = Math.max(0, totalHuman - burnedHuman);
      const lockedPct     = adjustedHuman > 0 ? (lockedHuman / adjustedHuman * 100) : 0;

      const m = marketCaps.get(addr.toLowerCase());
      const tvl = m?.mc || 0; // TVL from market_cap in pools_chache.json
      const name = meta.name || m?.name || "";
      const symbol = meta.symbol || m?.symbol || "";

      return {
        address: addr.toLowerCase(),
        name, symbol,
        totalHuman, burnedHuman, adjustedHuman,
        lockedHuman, lockedPct,
        latestEvent, nextUnlock: earliestUnlock,
        tvl
      };
    }catch(e){
      return null;
    }
  })))).filter(Boolean);

  DATA = results;
  render();
}

/* ============== Events ============== */
document.getElementById("thTVL").addEventListener("click", ()=>{
  tvlSortDir *= -1;
  resortByTVL();
});

/* ============== Init ============== */
document.addEventListener("DOMContentLoaded", build);
</script>
</body>
</html>
