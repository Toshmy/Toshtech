<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ToshLock ‚Äî Projects with Active Locks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0c1222; --bg-2:#0b1226; --fg:#e8fff6; --muted:#a8ffd9;
      --accent:#00ffae; --accent-2:#00d99c; --card:rgba(255,255,255,.05);
      --border:rgba(0,255,174,.2); --shadow:0 0 30px rgba(0,255,255,.18);
      --green:#00ffae; --red:#ff6b6b;
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;background:radial-gradient(circle at 20% 10%, #1a2238 0%, var(--bg) 70%);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    a{color:#93c5fd;text-decoration:none}
    .wrap{max-width:1150px;margin:24px auto;padding:0 16px}
    .glow-text{text-shadow:0 0 12px var(--accent),0 0 24px var(--accent)}
    .card{background:var(--card);border:1px solid var(--border);backdrop-filter:blur(6px);border-radius:14px;box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-block;padding:.25rem .6rem;border-radius:999px;background:#081021;border:1px solid var(--border);color:#a8ffd9}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.12);font-size:13px;white-space:nowrap}
    th{text-align:left;background:var(--bg-2);position:sticky;top:0}
    .table-scroll{overflow:auto;border-radius:12px}

    .progress{height:8px;background:#0f1730;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent), var(--accent-2));width:0%}

    .supplybar{height:10px;background:#0f1730;border:1px solid var(--border);border-radius:6px;display:flex;overflow:hidden}
    .supplybar .circ{background:var(--green);height:100%}
    .supplybar .burn{background:var(--red);height:100%}

    .muted{color:#98f5d3}
    .small{font-size:12px;color:#bfeede}
    .center{display:flex;align-items:center;justify-content:center;padding:18px;color:#bfeede}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

    td.token-cell{white-space:normal}
    .token-head{display:flex;align-items:center;gap:12px;justify-content:space-between}
    .token-left{display:flex;align-items:center;gap:10px;min-width:0;flex:1}
    .token-logo{width:36px;height:36px;border-radius:8px;object-fit:cover;border:1px solid var(--border);background:#0b1226;flex:0 0 36px}
    .token-name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
    .token-ca a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:inline-block;max-width:100%}

    .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:.22rem .6rem;background:#081021}
    .chip .emoji{font-size:12px;opacity:.9}
    .token-links{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

    td.supply-cell{min-width:220px;white-space:normal}

    @media (max-width: 640px){
      .table-scroll{ overflow:visible }
      thead{ display:none }
      table, tbody, tr, td{ display:block; width:100% }
      tr{
        margin:12px 0; border:1px solid var(--border); border-radius:12px;
        background:var(--card); box-shadow:var(--shadow); padding:10px
      }
      tr .row-index{ display:none }
      td.token-cell{ padding-bottom:8px }
      td.token-cell::before{ content:none !important }

      .token-head{flex-wrap:wrap;gap:10px}
      .token-actions{flex:1 0 100%;display:flex;justify-content:flex-start}
      .token-links{width:100%;justify-content:flex-start}
      .chip{ font-size:11px; padding:.22rem .55rem; max-width:100% }

      td[data-label]{
        display:flex; justify-content:space-between; align-items:flex-start; gap:10px; padding:8px 4px
      }
      td[data-label]::before{
        content:attr(data-label);
        flex:0 0 42%;
        max-width:220px;
        font-size:11px; color:#bfeede; opacity:.8; text-transform:uppercase; letter-spacing:.03em;
        padding-top:3px;
      }
      .cell-val{
        flex:1; min-width:0; text-align:right; display:flex; flex-direction:column; align-items:flex-end; gap:4px;
        overflow-wrap:anywhere;
      }
      .cell-val .progress{ width:100% }
      td.supply-cell{ min-width:auto }
      .mono{ word-break:normal }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="row" style="justify-content:space-between;margin-bottom:10px">
      <h1 class="glow-text" style="margin:0">üèÜ ToshLock ‚Äî Projects with Active Locks</h1>
      <span id="status" class="pill">Loading‚Ä¶</span>
    </header>

    <section class="table-scroll card" style="padding:0">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Token</th>
            <th>Locked %</th>
            <th>Unlock Date</th>
            <th>TVL / Metrics</th>
            <th>Supply (Adjusted)</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
      <div id="empty" class="center" style="display:none">No active locks found.</div>
    </section>

    <pre id="log" class="card muted" style="margin-top:12px;display:none"></pre>
  </div>

<script>
/* ===== CONFIG ===== */
const CONFIG = {
  LOCKER: "0xCCEfe66507762370C2487dd198d7D1fEfc6dEF8F",
  RPC: "https://rpc-pepu-v2-mainnet-0.t.conduit.xyz",
  EXPLORER: "https://explorer-pepu-v2-mainnet-0.t.conduit.xyz",
  GQL_URL: "https://pepu-mainnet2-pumppad.0sum.io/subgraphs/name/launchpad"
};

const GQL_QUERY = `query PresalesLogos { presales(first: 1000) { data token } }`;
const POOLS_JSON_URL = "pools_cache.json";
const BURN_ADDRS = [
  "0xa9fD599cd8857e90059c83e4885Dc09986039085",
  "0x000000000000000000000000000000000000dEaD"
];
const ERC20 = [
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function totalSupply() view returns (uint256)",
  "function balanceOf(address) view returns (uint256)"
];
const LOCKER_ABI = [
  "event LiquidityLocked(address indexed token,address indexed user,uint256 indexed lockId,uint256 amount,uint256 unlockTime,string name)",
  "function getActiveLocksByToken(address token,uint256 offset,uint256 limit) view returns (uint256[] lockIds,address[] owners,uint256[] amounts,uint256[] unlockTimes,string[] names)"
];

/* ===== HELPERS ===== */
const $ = id => document.getElementById(id);
function fmtNum(n){ return Number(n).toLocaleString(); }
function shortAddr(a){ return a ? a.slice(0,6)+"‚Ä¶"+a.slice(-4) : ""; }
function bnToNum(bn, decimals){ try{ return Number(ethers.utils.formatUnits(bn, decimals)); }catch{ return 0; } }
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function timeFromNow(ts){
  if (!ts) return "‚Äî";
  const now = Math.floor(Date.now()/1000);
  const diff = ts - now;
  const abs = Math.abs(diff);
  const m = Math.floor(abs/60), h=Math.floor(m/60), d=Math.floor(h/24), mo=Math.floor(d/30);
  const unit = mo>=1 ? [mo,"month"] : d>=1 ? [d,"day"] : h>=1 ? [h,"hour"] : m>=1 ? [m,"min"] : [abs,"sec"];
  const [val, label] = unit;
  return diff >= 0 ? `in ${val} ${label}${val>1?'s':''}` : `${val} ${label}${val>1?'s':''} ago`;
}
function tsToUTC(ts){ try{ return new Date(ts*1000).toISOString().replace('T',' ').replace('Z',' UTC'); } catch{ return "‚Äî"; } }
function pLimit(max){
  let running=0, queue=[];
  const next=()=>{ running--; if(queue.length) queue.shift()(); };
  return fn => new Promise((res,rej)=>{
    const run=()=>{ running++; Promise.resolve().then(fn).then(v=>{res(v);next();},e=>{rej(e);next();}); };
    if(running<max) run(); else queue.push(run);
  });
}

/* ===== Providers/Contracts ===== */
const ro = new ethers.providers.JsonRpcProvider(CONFIG.RPC);
const locker = new ethers.Contract(CONFIG.LOCKER, LOCKER_ABI, ro);

/* ===== External caches ===== */
let poolInfoByToken = new Map(); // tokenCA -> { price, reserveUSD, pools: Set<poolCA>, name, symbol }
let tokenMetaFromGQL = new Map();

/* Load price/reserve and LP pool addresses from pools_cache.json (same-origin) */
async function loadPoolsJson(){
  poolInfoByToken.clear();
  try{
    const r = await fetch(POOLS_JSON_URL, { cache: "no-cache" });
    if (!r.ok) return;
    const js = await r.json();
    const rows = Array.isArray(js) ? js : (js.data || []);
    for (const row of rows){
      const token = (row.address || "").toLowerCase();
      const pool  = (row.pool_address || "").toLowerCase();
      if(!/^0x[a-fA-F0-9]{40}$/.test(token)) continue;
      if(!poolInfoByToken.has(token)){
        poolInfoByToken.set(token, {
          price: Number(row.price || 0),
          reserveUSD: Number(row.reserve_in_usd || 0),
          pools: new Set(),
          name: row.name || "",
          symbol: row.symbol || ""
        });
      }
      if(/^0x[a-fA-F0-9]{40}$/.test(pool)){
        poolInfoByToken.get(token).pools.add(pool);
      }
    }
  }catch(e){ console.warn("pools_cache load error:", e); }
}

/* Logos / socials via GQL ‚Äî direct (no Worker) */
async function loadTokenLogos(){
  tokenMetaFromGQL.clear();
  try{
    const r = await fetch(CONFIG.GQL_URL, {
      method: "POST",
      headers: { "content-type": "application/json", "accept": "application/json" },
      body: JSON.stringify({ query: GQL_QUERY })
    });
    if (!r.ok) { console.warn("GQL fetch failed:", r.status); return; }
    const js = await r.json();
    const presales = js?.data?.presales || [];
    for (const p of presales){
      const addr = (p.token || "").toLowerCase();
      if(!/^0x[a-fA-F0-9]{40}$/.test(addr)) continue;
      let parsed = {};
      try{ parsed = JSON.parse(p.data || "{}"); }catch{}
      const iconUrl = parsed.iconUrl || "";
      const websiteUrl = parsed.websiteUrl || "";
      const xUrl = parsed.xUrl || parsed.twitterUrl || "";
      const telegramUrl = parsed.telegramUrl || ""
      tokenMetaFromGQL.set(addr, { iconUrl, websiteUrl, xUrl, telegramUrl });
    }
  }catch(e){ console.warn("GQL error:", e); }
}

/* Find tokens that have active locks (via events) */
async function discoverLockedTokens(){
  const topic0 = ethers.utils.id("LiquidityLocked(address,address,uint256,uint256,uint256,string)");
  const latest = await ro.getBlockNumber();
  const fromBlock = Math.max(0, latest - 800_000);
  const logs = await ro.getLogs({ address: CONFIG.LOCKER, topics: [topic0], fromBlock, toBlock: "latest" });
  const tokens = new Set();
  for (const lg of logs){
    const token = "0x" + lg.topics[1].slice(26);
    tokens.add(token.toLowerCase());
  }
  return Array.from(tokens);
}

/* Sum of active locked amounts + unlock stats */
async function getLocksSummary(token){
  const [ids, , amounts, unlockTimes] = await locker.getActiveLocksByToken(token, 0, 1000).catch(()=>[[],[],[],[]]);
  let sum = ethers.BigNumber.from(0);
  let sumWeighted = ethers.BigNumber.from(0);
  let earliestUnlock = null;
  for (let i=0;i<ids.length;i++){
    const amt = amounts[i];
    const ut  = Number(unlockTimes[i]) || 0;
    sum = sum.add(amt);
    sumWeighted = sumWeighted.add(amt.mul(ut));
    if (!earliestUnlock || ut < earliestUnlock) earliestUnlock = ut;
  }
  let avgUnlock = null;
  if (!sum.isZero()) {
    const avgBN = sumWeighted.div(sum);
    avgUnlock = avgBN.toNumber();
  }
  return { sumLocked: sum, earliestUnlock: earliestUnlock || null, avgUnlock: avgUnlock || null };
}

/* Liquidity = sum of token.balanceOf(pool_address) across all pools in pools_cache.json */
async function getLiquidityFromPools(token, decimals){
  const info = poolInfoByToken.get(token);
  if (!info || !info.pools || info.pools.size === 0) return 0;
  const erc = new ethers.Contract(token, ERC20, ro);
  const limit = pLimit(5);
  const amounts = await Promise.all(
    Array.from(info.pools).map(pool =>
      limit(()=> erc.balanceOf(pool).catch(()=>ethers.BigNumber.from(0)))
    )
  );
  let total = ethers.BigNumber.from(0);
  for (const a of amounts) total = total.add(a);
  return bnToNum(total, decimals);
}

/* =========== UI helpers =========== */
function tokenCellHTML(p){
  const explorerLink = `${CONFIG.EXPLORER}/address/${p.address}`;
  const detailsLink  = `https://www.toshtech.xyz/toshdashboard.html?token=${p.address}`;
  const meta = tokenMetaFromGQL.get(p.address) || {};
  const logo = meta.iconUrl || "";
  const web = meta.websiteUrl || "";
  const x   = meta.xUrl || "";
  const tg  = meta.telegramUrl || "";
  return `
    <div class="token-head">
      <div class="token-left">
        ${logo ? `<img class="token-logo" src="${logo}" alt="" onerror="this.style.display='none'">` : `<div class="token-logo"></div>`}
        <div style="min-width:0">
          <div class="token-name">${escapeHtml(p.name || p.symbol || '')}</div>
          <div class="small mono token-ca">
            <a href="${explorerLink}" target="_blank" rel="noopener" title="${p.address}">
              ${shortAddr(p.address)}
            </a>
          </div>
        </div>
      </div>
      <div class="token-actions">
        <a class="chip" href="${detailsLink}" target="_blank" rel="noopener"><span class="emoji">üîí</span> Active Locks</a>
      </div>
    </div>
    <div class="token-links">
      ${web ? `<a class="chip" href="${web}" target="_blank" rel="noopener">üï∏Ô∏è Website</a>` : ""}
      ${x   ? `<a class="chip" href="${x}"   target="_blank" rel="noopener">ùïè X</a>` : ""}
      ${tg  ? `<a class="chip" href="${tg}"  target="_blank" rel="noopener">üí¨ Telegram</a>` : ""}
    </div>
  `;
}

/* =========== Render =========== */
let DATA = [];

function render(){
  const rowsEl = $("rows");
  rowsEl.innerHTML = "";
  if (!DATA.length){ $("empty").style.display=""; return; }
  $("empty").style.display="none";

  // ‚úÖ Sort by TVL (descending) instead of locked %
  const byTVL = [...DATA].sort((a,b)=> (b.tvl || 0) - (a.tvl || 0));
  let totalTVL = 0;

  byTVL.forEach((p,i)=>{
    totalTVL += (p.tvl || 0);
    const nextU  = p.nextUnlock ? timeFromNow(p.nextUnlock) : "‚Äî";
    const avgU   = p.avgUnlock  ? timeFromNow(p.avgUnlock)  : "‚Äî";
    const nextTitle = p.nextUnlock ? tsToUTC(p.nextUnlock) : "-";
    const avgTitle  = p.avgUnlock  ? tsToUTC(p.avgUnlock)  : "-";

    const lockedPctClamped = isFinite(p.lockedPct) ? Math.max(0, Math.min(100, p.lockedPct)) : 0;

    const totalHuman  = p.totalHuman;
    const burnedHuman = p.burnedHuman;
    const liqHuman    = p.liqHuman;
    const circHuman   = p.circHuman;

    const denomForPct = Math.max(1e-18, totalHuman - burnedHuman);
    const circPct = Math.max(0, Math.min(100, (circHuman / denomForPct) * 100));
    const burnPct = Math.max(0, Math.min(100, (burnedHuman / Math.max(1e-18,totalHuman)) * 100));

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td data-label="#" class="row-index">${i+1}</td>

      <td class="token-cell">
        ${tokenCellHTML(p)}
      </td>

      <td data-label="Locked %">
        <div class="cell-val">
          <div class="progress"><i style="width:${lockedPctClamped.toFixed(2)}%"></i></div>
          <div class="small">${lockedPctClamped.toFixed(2)}%</div>
        </div>
      </td>

      <td data-label="Unlock Date">
        <div class="cell-val" title="Next: ${nextTitle} | Avg: ${avgTitle}">
          <div class="small">‚è≥ next ${nextU}</div>
          <div>üóìÔ∏è avg ${avgU}</div>
        </div>
      </td>

      <td data-label="TVL / Metrics">
        <div class="cell-val">
          <div class="small">üí∏ Price: $${(p.price||0).toFixed(8)}</div>
          <div class="small">üìä MC: $${fmtNum((p.mc||0).toFixed(2))}</div>
          <div class="small">üåê FDV: $${fmtNum((p.fdv||0).toFixed(2))}</div>
          <div>üí∞ TVL: $${fmtNum((p.tvl||0).toFixed(2))}</div>
        </div>
      </td>

      <td data-label="Supply (Adjusted)" class="supply-cell">
        <div class="cell-val">
          <div class="supplybar" title="Circulating % (green) vs Burned % (red)">
            <div class="circ" style="width:${circPct.toFixed(2)}%"></div>
            <div class="burn" style="width:${burnPct.toFixed(2)}%"></div>
          </div>
          <div class="small">
            üì¶ Total: ${fmtNum(totalHuman)}<br>
            üîí Locked: ${fmtNum(p.lockedHuman.toFixed(0))}<br>
            üíß Liquidity: ${fmtNum(liqHuman.toFixed(0))}<br>
            üî• Burned: ${fmtNum(burnedHuman.toFixed(0))}<br>
          </div>
          <div>
            ‚úÖ Circulating: ${fmtNum(circHuman.toFixed(0))}
          </div>
        </div>
      </td>
    `;
    rowsEl.appendChild(tr);
  });

  $("status").textContent = `Projects: ${byTVL.length} ‚Ä¢ Total TVL: $${fmtNum(totalTVL.toFixed(2))}`;
}

/* =========== Build =========== */
async function build(){
  $("status").textContent = "Loading‚Ä¶";

  await Promise.all([loadPoolsJson(), loadTokenLogos()]);

  const tokenList = await discoverLockedTokens();
  if (!tokenList.length){ $("empty").style.display=""; $("status").textContent="No active locks"; return; }

  const limit = pLimit(3); // be gentle with RPC

  const results = (await Promise.all(tokenList.map(addr => limit(async ()=>{
    try{
      const ca = addr.toLowerCase();

      // Locks summary
      const { sumLocked, earliestUnlock, avgUnlock } = await getLocksSummary(ca);
      if (!sumLocked || sumLocked.isZero()) return null;

      // ERC20 basics + burns
      const t = new ethers.Contract(ca, ERC20, ro);
      const [name, symbol, decimals, total, ...burns] = await Promise.all([
        t.name().catch(()=>""), t.symbol().catch(()=>""), t.decimals().catch(()=>18),
        t.totalSupply().catch(()=>ethers.BigNumber.from(0)),
        ...BURN_ADDRS.map(a => t.balanceOf(a).catch(()=>ethers.BigNumber.from(0)))
      ]);
      let burnedBN = ethers.BigNumber.from(0); for (const b of burns) burnedBN = burnedBN.add(b);

      const dec = Number(decimals);
      const totalHuman   = bnToNum(total, dec);
      const burnedHuman  = bnToNum(burnedBN, dec);
      const lockedHuman  = bnToNum(sumLocked, dec);

      // Price from pools_cache.json
      const poolInfo = poolInfoByToken.get(ca) || {};
      const price = Number(poolInfo.price || 0);

      // Liquidity by directly summing token.balanceOf(pool_address) across all pools
      const liqHuman = await getLiquidityFromPools(ca, dec);

      // Metrics
      const circHuman = Math.max(0, totalHuman - lockedHuman - liqHuman - burnedHuman);
      const tvl = lockedHuman * price;
      const fdv = totalHuman * price;
      const mc  = circHuman * price;
      const lockedPct = (totalHuman - burnedHuman > 0) ? (lockedHuman / (totalHuman - burnedHuman) * 100) : 0;

      return {
        address: ca,
        name: name || poolInfo.name || "",
        symbol: symbol || poolInfo.symbol || "",
        totalHuman, burnedHuman, lockedHuman, lockedPct,
        nextUnlock: earliestUnlock, avgUnlock,
        price, mc, fdv, tvl,
        circHuman, liqHuman
      };
    }catch(e){
      console.warn("token build error", addr, e);
      return null;
    }
  })))).filter(Boolean);

  DATA = results;
  render();
}

document.addEventListener("DOMContentLoaded", build);
</script>
</body>
</html>
