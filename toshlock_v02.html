<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ToshLock — Lock & Manage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ======= Brand / Theme ======= */
    :root{
      --bg:#0c1222;
      --bg-2:#0b1226;
      --fg:#e8fff6;
      --muted:#a8ffd9;
      --accent:#00ffae;
      --accent-2:#00d99c;
      --card:rgba(255,255,255,.05);
      --border:rgba(0,255,174,.2);
      --shadow:0 0 30px rgba(0,255,174,.18);
    }
    html,body{margin:0;background:radial-gradient(circle at 20% 10%, #1a2238 0%, var(--bg) 70%);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    a{color:#93c5fd;text-decoration:none}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .glow-text{text-shadow:0 0 12px var(--accent),0 0 24px var(--accent)}
    /* ======= Cards / layout ======= */
    .card{background:var(--card);border:1px solid var(--border);backdrop-filter:blur(6px);border-radius:14px;box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .between{justify-content:space-between}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    .muted{color:var(--muted);opacity:.9;font-size:12px}
    /* ======= Inputs / Buttons ======= */
    input,button,select{border-radius:12px;border:1px solid var(--border);background:#0f1730;color:#fff;padding:12px}
    input:focus,button:focus{outline:2px solid var(--accent);}
    .btn{cursor:pointer;background:linear-gradient(135deg, var(--accent), var(--accent-2));color:#00251b;border:0;font-weight:700}
    .btn.blue{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#eef5ff}
    .btn.gray{background:linear-gradient(135deg,#64748b,#475569);color:#eef5ff}
    .pill{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:#081021;border:1px solid var(--border);color:var(--muted)}
    /* ======= Tables ======= */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.12);font-size:13px}
    th{background:var(--bg-2);text-align:left}
    .table-scroll{overflow:auto;border-radius:12px}
    /* ======= Responsive grids ======= */
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.grid-2{grid-template-columns:1fr}}
    /* align the date/amount inputs nicely on desktop */
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.form-row{grid-template-columns:1fr}}
    /* Logs */
    pre{background:#0f1730;border:1px dashed var(--border);border-radius:12px;padding:12px;max-height:180px;overflow:auto}
  </style>

  <!-- ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- self-hosted WalletConnect bundle -->
  <script src="assets/walletconnect.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="row between">
      <h1 class="glow-text" style="margin:0">🔒 ToshLock — Lock & Manage</h1>
      <div class="row">
        <button id="mm" class="btn">Connect MetaMask</button>
        <button id="wc" class="btn blue">WalletConnect</button>
        <button id="disc" class="btn gray" disabled>Disconnect</button>
      </div>
    </header>
    <div id="status" class="muted" style="margin:6px 0 18px">Not connected</div>

    <!-- Create Lock -->
    <section class="card" style="margin-bottom:16px">
      <h2 style="margin:0 0 8px">Create a lock</h2>

      <div>
        <div class="muted" style="margin-bottom:6px">Token address</div>
        <input id="token" class="mono" placeholder="0x... token" style="width:100%">
        <div id="tokenMeta" class="muted">—</div>
      </div>

      <div class="form-row" style="margin-top:12px">
        <div>
          <div class="muted" style="margin-bottom:6px">Amount (human)</div>
          <input id="amount" type="number" step="any" placeholder="e.g. 1000" style="width:100%">
          <div id="amountHint" class="muted">—</div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px">Lock until (local date & time)</div>
          <input id="when" type="datetime-local" style="width:100%">
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="muted" style="margin-bottom:6px">Lock name (optional)</div>
        <input id="lname" placeholder="Liquidity Round #1" style="width:100%">
      </div>

      <div class="row" style="margin-top:14px">
        <button id="approveLock" class="btn">Approve & Lock</button>
        <span class="pill">Fee ~3% → owner • remainder locked</span>
      </div>
      <pre id="txlog" style="margin-top:12px"></pre>
    </section>

    <!-- My Locks -->
    <section class="card">
      <div class="row between">
        <h2 style="margin:0">My Locks (by Token)</h2>
        <div class="row">
          <input id="myToken" class="mono" placeholder="0x... token" style="width:min(360px, 70vw)">
          <button id="scan" class="btn gray">Load</button>
        </div>
      </div>

      <div class="grid-2" style="margin-top:12px">
        <div>
          <h3 style="margin-top:0">Active</h3>
          <div class="table-scroll card" style="padding:0">
            <table>
              <thead>
                <tr>
                  <th>Lock ID</th><th>Token</th><th>Name</th>
                  <th style="text-align:right">Amount</th><th>Symbol</th><th>Unlock</th>
                </tr>
              </thead>
              <tbody id="activeRows"></tbody>
            </table>
          </div>
        </div>
        <div>
          <h3 style="margin-top:0">Unlockable</h3>
          <div class="table-scroll card" style="padding:0">
            <table>
              <thead>
                <tr>
                  <th>Lock ID</th><th>Token</th><th>Name</th>
                  <th style="text-align:right">Amount</th><th>Symbol</th><th>Unlock</th><th>Action</th>
                </tr>
              </thead>
              <tbody id="unlockableRows"></tbody>
            </table>
          </div>
        </div>
      </div>

      <pre id="scanlog" style="margin-top:12px"></pre>
    </section>
  </div>

<script>
/* ========= Hardcoded env ========= */
const LOCKER = "0x189ef775DcC7782802ca16b870Da7B5FaE3C8524";
const RPC    = "https://rpc-pepu-v2-testnet-vn4qxxp9og.t.conduit.xyz";
const CHAIN  = 97741;
const WC_PID = "6e2df48125e4f633b093361ba0a87c81";

/* ========= ABIs ========= */
const ERC20 = [
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function approve(address spender,uint256 amount) returns (bool)"
];
const LOCKER_ABI = [
  "event LiquidityLocked(address indexed token,address indexed user,uint256 indexed lockId,uint256 amount,uint256 unlockTime,string name)",
  "event LiquidityUnlocked(address indexed token,address indexed user,uint256 indexed lockId,uint256 amount)",
  "function lockLiquidity(address token,uint256 amount,uint256 unlockTime)",
  "function lockLiquidityWithName(address token,uint256 amount,uint256 unlockTime,string name)",
  "function getLock(address token,uint256 lockId) view returns (address owner,uint256 amount,uint256 unlockTime,string name,bool active)",
  "function getUserLockIds(address user,address token,uint256 offset,uint256 limit) view returns (uint256[] memory)",
  "function unlockLiquidity(address token,uint256 lockId)"
];

/* ========= Utils ========= */
const $ = id => document.getElementById(id);
const logTx = (...a)=>{ $("txlog").textContent += a.join(" ")+"\n"; };
const logScan = (...a)=>{ $("scanlog").textContent += a.join(" ")+"\n"; };
const setStatus = s => { $("status").textContent = s; };

let providerType = null; // 'mm' | 'wc'
let wcProvider, ethersProvider, signer;
const roProvider = new ethers.providers.JsonRpcProvider(RPC);

/* ========= Connect ========= */
$("mm").onclick = async () => {
  try{
    if (!window.ethereum) throw new Error("MetaMask not found");
    providerType='mm';
    ethersProvider = new ethers.providers.Web3Provider(window.ethereum,'any');
    await ethersProvider.send('eth_requestAccounts',[]);
    signer = ethersProvider.getSigner();
    const a = await signer.getAddress(); const n = await ethersProvider.getNetwork();
    setStatus(`Connected (MM): ${a.slice(0,6)}…${a.slice(-4)} on chain ${n.chainId}`);
    $("disc").disabled=false;
  }catch(e){ setStatus(e.message||String(e)); }
};
$("wc").onclick = async () => {
  try{
    if (!window.WalletConnectEthereumProvider) throw new Error("walletconnect.min.js missing");
    providerType='wc';
    wcProvider = await window.WalletConnectEthereumProvider.init({
      projectId: WC_PID, showQrModal:true,
      chains:[CHAIN], optionalChains:[CHAIN],
      rpcMap:{ [CHAIN]: RPC },
      metadata:{ name:"ToshLock", description:"Pepu L2 Liquidity Locking", url:location.origin, icons:["https://walletconnect.com/walletconnect-logo.png"] }
    });
    await wcProvider.enable();
    ethersProvider = new ethers.providers.Web3Provider(wcProvider,'any');
    signer = ethersProvider.getSigner();
    const a = await signer.getAddress(); const n = await ethersProvider.getNetwork();
    setStatus(`Connected (WC): ${a.slice(0,6)}…${a.slice(-4)} on chain ${n.chainId}`);
    $("disc").disabled=false;
    wcProvider.on('disconnect', ()=> setDisconnectedUI());
  }catch(e){ setStatus(e.message||String(e)); }
};
$("disc").onclick = async () => {
  try{ if (providerType==='wc' && wcProvider?.disconnect) await wcProvider.disconnect(); }catch{}
  setDisconnectedUI();
};
function setDisconnectedUI(){ providerType=null; wcProvider=ethersProvider=signer=undefined; setStatus("Not connected"); $("disc").disabled=true; }

/* ========= Token meta ========= */
let tokenDecimals=null, tokenSymbol="", tokenName="";
async function refreshTokenMeta(){
  const addr = $("token").value.trim();
  if(!/^0x[a-fA-F0-9]{40}$/.test(addr)){ $("tokenMeta").textContent="—"; $("amountHint").textContent="—"; tokenDecimals=null; return; }
  try{
    const t = new ethers.Contract(addr, ERC20, roProvider);
    const [name,symbol,dec] = await Promise.all([t.name(), t.symbol(), t.decimals()]);
    tokenName=name; tokenSymbol=symbol; tokenDecimals=Number(dec);
    $("tokenMeta").textContent = `${name} (${symbol}), decimals=${tokenDecimals}`;
    const human = $("amount").value || "0";
    $("amountHint").textContent = `= ${ethers.utils.parseUnits(human, tokenDecimals).toString()} base units`;
  }catch{ $("tokenMeta").textContent="⚠️ cannot read token"; tokenDecimals=null; }
}
$("token").addEventListener("change", refreshTokenMeta);
$("token").addEventListener("blur", refreshTokenMeta);
$("amount").addEventListener("input", ()=>{
  if(tokenDecimals==null){ $("amountHint").textContent="enter a valid token first"; return; }
  try{ $("amountHint").textContent = `= ${ethers.utils.parseUnits($("amount").value||"0", tokenDecimals).toString()} base units`; }catch{ $("amountHint").textContent="—"; }
});

/* ========= Approve & Lock ========= */
$("approveLock").onclick = async () => {
  try{
    if(!signer) throw new Error("Connect wallet first");
    if(tokenDecimals==null) await refreshTokenMeta();

    const tokenAddr = ethers.utils.getAddress($("token").value.trim());
    const amtHuman  = $("amount").value || "0";
    const amount    = ethers.utils.parseUnits(amtHuman, tokenDecimals||18);

    const v = $("when").value; if(!v) throw new Error("Pick a future lock date/time");
    const unlockTs = Math.floor(Date.parse(v)/1000);
    if(!unlockTs || unlockTs <= Math.floor(Date.now()/1000)) throw new Error("Lock time must be in the future");

    const name = $("lname").value || "";

    const erc = new ethers.Contract(tokenAddr, ERC20, signer);
    const tx1 = await erc.approve(LOCKER, amount);
    logTx("Approval:", tx1.hash); await tx1.wait(); logTx("✅ Approval confirmed");

    const locker = new ethers.Contract(LOCKER, LOCKER_ABI, signer);
    const tx2 = await locker.lockLiquidityWithName(tokenAddr, amount, unlockTs, name);
    logTx("Lock:", tx2.hash); await tx2.wait(); logTx("🔒 Lock confirmed");

    $("myToken").value = tokenAddr;
    scanMyLocks();
  }catch(e){ logTx("❌", e?.data?.message || e?.message || String(e)); }
};

/* ========= My Locks ========= */
const activeRows = $("activeRows"), unlockableRows = $("unlockableRows");
$("scan").onclick = scanMyLocks;

async function scanMyLocks(){
  try{
    if(!signer) throw new Error("Connect wallet first");
    $("scanlog").textContent=""; logScan("Loading…");
    activeRows.innerHTML=""; unlockableRows.innerHTML="";

    const tokenAddr = $("myToken").value.trim();
    if(!/^0x[a-fA-F0-9]{40}$/.test(tokenAddr)) throw new Error("Enter a valid token address");

    const user = await signer.getAddress();
    const lockerRO = new ethers.Contract(LOCKER, LOCKER_ABI, roProvider);
    const ids = await lockerRO.getUserLockIds(user, tokenAddr, 0, 500);

    const ercRO = new ethers.Contract(tokenAddr, ERC20, roProvider);
    const [sym, dec] = await Promise.all([ercRO.symbol().catch(()=>"?"), ercRO.decimals().catch(()=>18)]);
    const detail = await Promise.all(ids.map(id => lockerRO.getLock(tokenAddr, id)));
    const now = Math.floor(Date.now()/1000);

    for (let i=0;i<ids.length;i++){
      const id = ids[i];
      const [owner, amount, unlockTime, lname, active] = detail[i];
      if (!amount || amount.toString()==="0") continue;
      const human = ethers.utils.formatUnits(amount, dec);
      const date  = new Date(Number(unlockTime)*1000).toLocaleString();

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${id.toString()}</td>
        <td class="mono">${tokenAddr.slice(0,6)}…${tokenAddr.slice(-4)}</td>
        <td>${lname||""}</td>
        <td style="text-align:right">${Number(human).toLocaleString()}</td>
        <td>${sym}</td>
        <td>${date}</td>
      `;

      if (Number(unlockTime) > now) {
        activeRows.appendChild(tr);
      } else if (active && Number(unlockTime) <= now) {
        const td = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent="Unlock"; btn.className="btn";
        btn.onclick = async ()=>{
          try{
            const locker = new ethers.Contract(LOCKER, LOCKER_ABI, signer);
            btn.disabled=true; btn.textContent="Unlocking…";
            const tx = await locker.unlockLiquidity(tokenAddr, id);
            logScan("Unlock:", tx.hash);
            await tx.wait();
            logScan("✅ Unlocked", id.toString());
            scanMyLocks();
          }catch(e){ logScan("❌", e?.data?.message || e?.message || String(e)); btn.disabled=false; btn.textContent="Unlock"; }
        };
        td.appendChild(btn); tr.appendChild(td);
        unlockableRows.appendChild(tr);
      }
    }
    logScan("Done.");
  }catch(e){ logScan("❌", e?.data?.message || e?.message || String(e)); }
}
</script>
</body>
</html>
