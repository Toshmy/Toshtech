<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ToshLock ‚Äî Lock & Manage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Flatpickr (calendar/time picker) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    :root{
      --bg:#0c1222; --bg-2:#0b1226; --fg:#e8fff6; --muted:#a8ffd9;
      --accent:#00ffae; --accent-2:#00d99c; --card:rgba(255,255,255,.05);
      --border:rgba(0,255,174,.2); --shadow:0 0 30px rgba(0,255,174,.18);
    }
    html,body{margin:0;background:radial-gradient(circle at 20% 10%, #1a2238 0%, var(--bg) 70%);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    a{color:#93c5fd;text-decoration:none}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .glow-text{text-shadow:0 0 12px var(--accent),0 0 24px var(--accent)}
    .card{background:var(--card);border:1px solid var(--border);backdrop-filter:blur(6px);border-radius:14px;box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .between{justify-content:space-between}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    .muted{color:var(--muted);opacity:.9;font-size:12px}
    *{box-sizing:border-box}
    label{display:block;margin-bottom:6px;font-size:12px;color:var(--muted)}
    input,button,select{width:100%;border-radius:12px;border:1px solid var(--border);background:#0f1730;color:#fff;padding:12px}
    input:focus,button:focus{outline:2px solid var(--accent);}
    .btn{cursor:pointer;background:linear-gradient(135deg, var(--accent), var(--accent-2));color:#00251b;border:0;font-weight:700;width:auto}
    .btn.blue{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#eef5ff}
    .btn.gray{background:linear-gradient(135deg,#64748b,#475569);color:#eef5ff}
    .pill{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:#081021;border:1px solid var(--border);color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.12);font-size:13px;white-space:nowrap}
    th{text-align:left;background:var(--bg-2)}
    .table-scroll{overflow:auto;border-radius:12px}
    pre{background:#0f1730;border:1px dashed var(--border);border-radius:12px;padding:12px;max-height:180px;overflow:auto;white-space:pre-wrap;word-break:break-word}
    td:nth-child(1), th:nth-child(1){ white-space:nowrap; }
    #amountHint{margin-top:6px;min-height:16px}
    .flatpickr-calendar{background:#0f1730;border:1px solid var(--border);box-shadow:var(--shadow)}
    /* Autocomplete */
    .ac-wrap{position:relative}
    .ac-list{
      position:absolute; left:0; right:0; top:calc(100% + 4px);
      background:#0f1730; border:1px solid rgba(0,255,174,.2); border-radius:12px;
      box-shadow:0 10px 24px rgba(0,0,0,.35); z-index:50; max-height:280px; overflow:auto; display:none;
    }
    .ac-item{
      display:flex; gap:8px; align-items:center; padding:10px 12px; cursor:pointer;
      border-bottom:1px solid rgba(255,255,255,.06); font-size:13px;
    }
    .ac-item:last-child{border-bottom:0}
    .ac-item:hover{background:#0b1329}
    .ac-name{font-weight:600}
    .ac-sym{color:#a8ffd9}
    .ac-addr{margin-left:auto; font-family:ui-monospace,monospace; color:#9fb; opacity:.85}
    .ac-empty{padding:10px 12px; color:#a8ffd9; font-size:12px}
  </style>

  <!-- ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- WalletConnect (self-hosted UMD you built) -->
  <script src="assets/walletconnect.min.js"></script>
  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>
  <div class="wrap">
    <header class="row between">
      <h1 class="glow-text" style="margin:0">üîí ToshLock ‚Äî Lock & Manage</h1>
      <div class="row">
        <button id="mm" class="btn">Connect MetaMask</button>
        <button id="wc" class="btn blue">WalletConnect</button>
        <button id="disc" class="btn gray" disabled>Disconnect</button>
      </div>
    </header>
    <div id="status" class="muted" style="margin:6px 0 18px">Not connected</div>

    <!-- Create Lock -->
    <section class="card" style="margin-bottom:16px">
      <h2 style="margin:0 0 8px">Create a lock</h2>

      <div>
        <label for="token">Token address</label>
        <div class="ac-wrap">
          <input id="token" class="mono" placeholder="Search by symbol / name / 0x..." autocomplete="off">
          <div id="ac-token" class="ac-list"></div>
        </div>
        <div id="tokenMeta" class="muted">‚Äî</div>
      </div>

      <div style="margin-top:12px">
        <label for="amount">Amount (human)</label>
        <input id="amount" type="number" step="any" placeholder="e.g. 1000">
        <div id="amountHint" class="muted">‚Äî</div>
      </div>

      <div style="margin-top:12px">
        <label for="when">Lock until (local date & time)</label>
        <input id="when" placeholder="Select date & time">
      </div>

      <div style="margin-top:12px">
        <label for="lname">Lock name (optional)</label>
        <input id="lname" placeholder="Liquidity Round #1">
      </div>

      <div class="row" style="margin-top:14px">
        <button id="approveLock" class="btn">Approve & Lock</button>
        <span class="pill">Fee ~3% ‚Üí owner ‚Ä¢ remainder locked</span>
      </div>
      <pre id="txlog" style="margin-top:12px"></pre>
    </section>

    <!-- My Locks -->
    <section class="card">
      <div class="row between">
        <h2 style="margin:0">My Locks (by Token)</h2>
        <div class="row" style="gap:8px;width:min(360px, 70vw)">
          <div class="ac-wrap" style="width:100%">
            <input id="myToken" class="mono" placeholder="Search by symbol / name / 0x..." autocomplete="off">
            <div id="ac-myToken" class="ac-list"></div>
          </div>
          <button id="scan" class="btn gray">Load</button>
        </div>
      </div>

      <div class="row" style="margin-top:12px;gap:14px">
        <div style="flex:1 1 480px">
          <h3 style="margin-top:0">Active</h3>
          <div class="table-scroll card" style="padding:0">
            <table>
              <thead>
                <tr>
                  <th>Unlock</th><th style="text-align:right">Amount</th><th>Symbol</th>
                  <th>Name</th><th>Owner</th><th>Lock ID</th>
                </tr>
              </thead>
              <tbody id="activeRows"></tbody>
            </table>
          </div>
        </div>
        <div style="flex:1 1 480px">
          <h3 style="margin-top:0">Unlockable</h3>
          <div class="table-scroll card" style="padding:0">
            <table>
              <thead>
                <tr>
                  <th>Unlock</th><th style="text-align:right">Amount</th><th>Symbol</th>
                  <th>Name</th><th>Owner</th><th>Lock ID</th><th>Action</th>
                </tr>
              </thead>
              <tbody id="unlockableRows"></tbody>
            </table>
          </div>
        </div>
      </div>

      <pre id="scanlog" style="margin-top:12px"></pre>
    </section>
  </div>

<script>
/* ========= Hardcoded env ========= */
const LOCKER = "0x0c42901e39f8b88e67a4a93dc4fc84f4e8f1193c"; // ToshLockV4
const RPC    = "https://rpc-pepu-v2-testnet-vn4qxxp9og.t.conduit.xyz";
const CHAIN  = 97741;
const WC_PID = "6e2df48125e4f633b093361ba0a87c81";
const EXPLORER_BASE = "https://explorer-pepu-v2-testnet-vn4qxxp9og.t.conduit.xyz";

// Cloudflare Worker relay (for explorer APIs / search)
const RELAY_PATH = "https://odd-feather-f250.toshtech777.workers.dev/?url=";

/* ========= ABIs ========= */
const ERC20 = [
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function approve(address spender,uint256 amount) returns (bool)"
];
const LOCKER_ABI = [
  "event LiquidityLocked(address indexed token,address indexed user,uint256 indexed lockId,uint256 amount,uint256 unlockTime,string name)",
  "event LiquidityUnlocked(address indexed token,address indexed user,uint256 indexed lockId,uint256 amount)",
  "function lockLiquidity(address token,uint256 amount,uint256 unlockTime)",
  "function lockLiquidityWithName(address token,uint256 amount,uint256 unlockTime,string name)",
  "function getLock(address token,uint256 lockId) view returns (address owner,uint256 amount,uint256 unlockTime,string name,bool active)",
  "function getUserLockIds(address user,address token,uint256 offset,uint256 limit) view returns (uint256[] memory)",
  "function unlockLiquidity(address token,uint256 lockId)"
];

/* ========= Helpers ========= */
const $ = id => document.getElementById(id);
const logTx = (...a)=>{ $("txlog").textContent += a.join(" ")+"\n"; };
const logScan = (...a)=>{ $("scanlog").textContent += a.join(" ")+"\n"; };
const setStatus = s => { $("status").textContent = s; };
const PepuExplorer = {
  tx: (h) => `${EXPLORER_BASE}/tx/${h}`,
  address: (a) => `${EXPLORER_BASE}/address/${a}`
};
async function fetchJsonCORS(url) {
  const r = await fetch(RELAY_PATH + encodeURIComponent(url), { cache: "no-cache" });
  if (!r.ok) throw new Error(`Relay HTTP ${r.status}`);
  return r.json();
}

let providerType = null; // 'mm' | 'wc'
let wcProvider, ethersProvider, signer;
const roProvider = new ethers.providers.JsonRpcProvider(RPC);

/* ========= Flatpickr init ========= */
let whenPicker;
document.addEventListener('DOMContentLoaded', () => {
  whenPicker = flatpickr("#when", {
    enableTime: true,
    dateFormat: "Y-m-d H:i",
    time_24hr: true,
    minuteIncrement: 1,
    altInput: true,
    altFormat: "M j, Y ‚Äî H:i",
    defaultDate: new Date(Date.now() + 3600 * 1000), // +1h
    minDate: "today"
  });
});

/* ========= Connect ========= */
$("mm").onclick = async () => {
  try{
    if (!window.ethereum) throw new Error("MetaMask not found");
    providerType='mm';
    ethersProvider = new ethers.providers.Web3Provider(window.ethereum,'any');
    await ethersProvider.send('eth_requestAccounts',[]);
    signer = ethersProvider.getSigner();
    const a = await signer.getAddress(); const n = await ethersProvider.getNetwork();
    setStatus(`Connected (MM): ${a.slice(0,6)}‚Ä¶${a.slice(-4)} on chain ${n.chainId}`);
    $("disc").disabled=false;
  }catch(e){ setStatus(e.message||String(e)); }
};
$("wc").onclick = async () => {
  try{
    if (!window.WalletConnectEthereumProvider) throw new Error("walletconnect.min.js missing");
    providerType='wc';
    wcProvider = await window.WalletConnectEthereumProvider.init({
      projectId: WC_PID, showQrModal:true,
      chains:[CHAIN], optionalChains:[CHAIN],
      rpcMap:{ [CHAIN]: RPC },
      metadata:{ name:"ToshLock", description:"Pepu L2 Liquidity Locking", url:location.origin, icons:["https://walletconnect.com/walletconnect-logo.png"] }
    });
    await wcProvider.enable();
    ethersProvider = new ethers.providers.Web3Provider(wcProvider,'any');
    signer = ethersProvider.getSigner();
    const a = await signer.getAddress(); const n = await ethersProvider.getNetwork();
    setStatus(`Connected (WC): ${a.slice(0,6)}‚Ä¶${a.slice(-4)} on chain ${n.chainId}`);
    $("disc").disabled=false;
    wcProvider.on('disconnect', ()=> setDisconnectedUI());
  }catch(e){ setStatus(e.message||String(e)); }
};
$("disc").onclick = async () => {
  try{ if (providerType==='wc' && wcProvider?.disconnect) await wcProvider.disconnect(); }catch{}
  setDisconnectedUI();
};
function setDisconnectedUI(){ providerType=null; wcProvider=ethersProvider=signer=undefined; setStatus("Not connected"); $("disc").disabled=true; }

/* ========= Token meta ========= */
let tokenDecimals=null, tokenSymbol="", tokenName="";
async function refreshTokenMeta(){
  const addr = $("token").value.trim();
  if(!/^0x[a-fA-F0-9]{40}$/.test(addr)){ $("tokenMeta").textContent="‚Äî"; $("amountHint").textContent="‚Äî"; tokenDecimals=null; return; }
  try{
    const t = new ethers.Contract(addr, ERC20, roProvider);
    const [name,symbol,dec] = await Promise.all([t.name(), t.symbol(), t.decimals()]);
    tokenName=name; tokenSymbol=symbol; tokenDecimals=Number(dec);
    $("tokenMeta").textContent = `${name} (${symbol}), decimals=${tokenDecimals}`;
    const human = $("amount").value || "0";
    $("amountHint").textContent = `= ${ethers.utils.parseUnits(human, tokenDecimals).toString()} base units`;
  }catch{
    // fallback: try remote search to at least show name/symbol (decimals unknown)
    try{
      const meta = await searchBestMatchByAddress(addr);
      tokenName = meta?.name || ""; tokenSymbol = meta?.symbol || ""; tokenDecimals = null;
      $("tokenMeta").textContent = `${tokenName || "?"} (${tokenSymbol || "?"})`;
    }catch{
      $("tokenMeta").textContent="‚ö†Ô∏è cannot read token"; tokenDecimals=null;
    }
  }
}
$("token").addEventListener("change", refreshTokenMeta);
$("token").addEventListener("blur", refreshTokenMeta);
$("amount").addEventListener("input", ()=>{
  if(tokenDecimals==null){ $("amountHint").textContent="enter a valid token first"; return; }
  try{ $("amountHint").textContent = `= ${ethers.utils.parseUnits($("amount").value||"0", tokenDecimals).toString()} base units`; }catch{ $("amountHint").textContent="‚Äî"; }
});

/* ========= Approve & Lock ========= */
$("approveLock").onclick = async () => {
  try{
    if(!signer) throw new Error("Connect wallet first");
    if(tokenDecimals==null) await refreshTokenMeta();

    const tokenAddr = ethers.utils.getAddress($("token").value.trim());
    const amtHuman  = $("amount").value || "0";
    const amount    = ethers.utils.parseUnits(amtHuman, tokenDecimals||18);

    const selectedDate = whenPicker && whenPicker.selectedDates[0];
    if(!selectedDate) throw new Error("Pick a future lock date/time");
    const unlockTs = Math.floor(selectedDate.getTime()/1000);
    if(unlockTs <= Math.floor(Date.now()/1000)) throw new Error("Lock time must be in the future");

    const name = $("lname").value || "";

    const erc = new ethers.Contract(tokenAddr, ERC20, signer);
    const tx1 = await erc.approve(LOCKER, amount);
    logTx(`Approval: ${tx1.hash} ‚Äî ${PepuExplorer.tx(tx1.hash)}`); await tx1.wait(); logTx("‚úÖ Approval confirmed");

    const locker = new ethers.Contract(LOCKER, LOCKER_ABI, signer);
    const tx2 = await locker.lockLiquidityWithName(tokenAddr, amount, unlockTs, name);
    logTx(`Lock: ${tx2.hash} ‚Äî ${PepuExplorer.tx(tx2.hash)}`); await tx2.wait(); logTx("üîí Lock confirmed");

    $("myToken").value = tokenAddr;
    scanMyLocks();
  }catch(e){ logTx("‚ùå", e?.data?.message || e?.message || String(e)); }
};

/* ========= My Locks ========= */
const activeRows = $("activeRows"), unlockableRows = $("unlockableRows");
$("scan").onclick = scanMyLocks;

async function scanMyLocks(){
  try{
    if(!signer) throw new Error("Connect wallet first");
    $("scanlog").textContent=""; logScan("Loading‚Ä¶");
    activeRows.innerHTML=""; unlockableRows.innerHTML="";

    const tokenAddr = $("myToken").value.trim();
    if(!/^0x[a-fA-F0-9]{40}$/.test(tokenAddr)) throw new Error("Enter a valid token address");

    const user = await signer.getAddress();
    const lockerRO = new ethers.Contract(LOCKER, LOCKER_ABI, roProvider);
    const ids = await lockerRO.getUserLockIds(user, tokenAddr, 0, 500);

    const ercRO = new ethers.Contract(tokenAddr, ERC20, roProvider);
    const [sym, dec] = await Promise.all([ercRO.symbol().catch(()=>"?"), ercRO.decimals().catch(()=>18)]);
    const detail = await Promise.all(ids.map(id => lockerRO.getLock(tokenAddr, id)));
    const now = Math.floor(Date.now()/1000);

    for (let i=0;i<ids.length;i++){
      const id = ids[i];
      const [owner, amount, unlockTime, lname, active] = detail[i];
      if (!amount || amount.toString()==="0") continue;
      const human = ethers.utils.formatUnits(amount, dec);
      const date  = new Date(Number(unlockTime)*1000).toLocaleString();
      const ownerDisp = user.slice(0,6)+"‚Ä¶"+user.slice(-4);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${date}</td>
        <td style="text-align:right">${Number(human).toLocaleString()}</td>
        <td>${sym}</td>
        <td>${lname||""}</td>
        <td class="mono" title="${user}">${ownerDisp}</td>
        <td>${id.toString()}</td>
      `;

      if (Number(unlockTime) > now) {
        activeRows.appendChild(tr);
      } else if (active && Number(unlockTime) <= now) {
        const td = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent="Unlock"; btn.className="btn";
        btn.onclick = async ()=>{
          try{
            const locker = new ethers.Contract(LOCKER, LOCKER_ABI, signer);
            btn.disabled=true; btn.textContent="Unlocking‚Ä¶";
            const tx = await locker.unlockLiquidity(tokenAddr, id);
            logScan(`Unlock: ${tx.hash} ‚Äî ${PepuExplorer.tx(tx.hash)}`);
            await tx.wait();
            logScan("‚úÖ Unlocked", id.toString());
            scanMyLocks();
          }catch(e){ logScan("‚ùå", e?.data?.message || e?.message || String(e)); btn.disabled=false; btn.textContent="Unlock"; }
        };
        td.appendChild(btn); tr.appendChild(td);
        unlockableRows.appendChild(tr);
      }
    }
    logScan("Done.");
  }catch(e){ logScan("‚ùå", e?.data?.message || e?.message || String(e)); }
}

/* ========= Explorer SEARCH via your Worker (no tokens.json) ========= */
async function pepuSearchRemote(q) {
  if (!q || (q = q.trim()).length < 2) return [];
  if (/^0x[a-fA-F0-9]{40}$/.test(q)) return [{ address: q, name: "", symbol: "" }];

  const url = `${EXPLORER_BASE}/api/v2/search?q=${encodeURIComponent(q)}`;
  try {
    const js = await fetchJsonCORS(url);
    const items = js.items || [];
    return items
      .filter(it => it.type === 'token' || it.token_type === 'ERC-20' || it.address)
      .map(it => ({
        address: (it.address || it.address_hash || "").toLowerCase(),
        name: it.name || "",
        symbol: it.symbol || ""
      }))
      .filter((it, i, arr) => it.address && arr.findIndex(x => x.address === it.address) === i)
      .slice(0, 20);
  } catch (e) {
    console.warn("search failed", e);
    return [];
  }
}

// Helper: when user pastes an address, try to pull one matching search item for name/symbol
async function searchBestMatchByAddress(addr){
  try{
    const res = await pepuSearchRemote(addr);
    return res.find(x => x.address.toLowerCase()===addr.toLowerCase()) || res[0] || null;
  }catch{ return null; }
}

function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn(...a), ms); }; }

function attachTokenAutocomplete(inputId, listId){
  const inp = document.getElementById(inputId);
  const list = document.getElementById(listId);
  if(!inp || !list) return;
  function hide(){ list.style.display="none"; }
  function show(){ list.style.display="block"; }
  hide();
  const esc = s => String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
  const render = (items)=>{
    if(items.length===0){
      list.innerHTML = `<div class="ac-empty">No matches</div>`; show(); return;
    }
    list.innerHTML = items.map(it=>{
      const name = it.name ? `<span class="ac-name">${esc(it.name)}</span>` : '';
      const sym  = it.symbol ? `<span class="ac-sym">(${esc(it.symbol)})</span>` : '';
      const short = it.address.slice(0,8)+"‚Ä¶"+it.address.slice(-6);
      return `<div class="ac-item" data-addr="${it.address}">
        ${name} ${sym}
        <span class="ac-addr">${short}</span>
      </div>`;
    }).join("");
    show();
  };
  const onType = debounce(async ()=>{
    const q = inp.value.trim();
    if(!q){ hide(); return; }
    if(/^0x[a-fA-F0-9]{40}$/.test(q)){ render([{address:q.toLowerCase(), name:"", symbol:""}]); return; }
    const items = await pepuSearchRemote(q); render(items);
  }, 220);
  inp.addEventListener('input', onType);
  inp.addEventListener('focus', ()=>{ if(list.innerHTML) show(); });
  document.addEventListener('click', (e)=>{ if(!list.contains(e.target) && e.target!==inp) hide(); });
  list.addEventListener('click', (e)=>{
    const item = e.target.closest('.ac-item'); if(!item) return;
    const addr = item.getAttribute('data-addr');
    inp.value = addr; hide();
    inp.dispatchEvent(new Event('change')); inp.dispatchEvent(new Event('blur'));
  });
}

document.addEventListener('DOMContentLoaded', ()=>{
  attachTokenAutocomplete('token','ac-token');
  attachTokenAutocomplete('myToken','ac-myToken');
});
</script>
</body>
</html>
