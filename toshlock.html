<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ToshLock â€“ Approve & Lock</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <!-- ethers v5 UMD (works in plain HTML) -->
  <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- WalletConnect v2 UMD -->
  <script src="https://unpkg.com/@walletconnect/ethereum-provider@2.11.2/dist/index.umd.js"></script>
</head>
<body class="min-h-screen bg-gray-900 text-white">
  <div class="max-w-2xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-6">ðŸ”’ ToshLock â€” Approve & Lock</h1>

    <!-- Connect row -->
    <div class="flex gap-3 mb-6">
      <button id="connect-metamask" class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700">Connect MetaMask</button>
      <button id="connect-wc" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700">WalletConnect</button>
      <span id="connStatus" class="text-sm text-gray-300"></span>
    </div>

    <!-- Form -->
    <div class="space-y-4 bg-white bg-opacity-5 p-4 rounded-xl border border-white border-opacity-10">
      <div>
        <label class="block text-sm text-gray-300 mb-1">Token address</label>
        <input id="token" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="0x... token"/>
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-1">Locker address (ToshLock/LiquidityProof)</label>
        <input id="locker" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="0x... locker"/>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-gray-300 mb-1">Amount (human)</label>
          <input id="amount" type="number" min="0" step="any" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="1000"/>
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-1">Lock until (local time)</label>
          <input id="locktime" type="datetime-local" class="w-full p-2 rounded bg-gray-800 border border-gray-700"/>
        </div>
      </div>

      <div class="flex flex-wrap gap-3 pt-2">
        <button id="readToken" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600">Read token</button>
        <button id="approve" class="px-4 py-2 rounded-lg bg-yellow-600 hover:bg-yellow-700">Approve</button>
        <button id="lock" class="px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700">Lock</button>
        <button id="approveLock" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700">Approve & Lock</button>
      </div>

      <div class="text-sm text-gray-300">
        Fee note: contract pulls <b>full amount</b>, sends <b>3%</b> to owner, locks the remaining <b>97%</b>.
      </div>
    </div>

    <pre id="log" class="mt-6 p-3 bg-black rounded-lg text-xs overflow-x-auto h-64"></pre>
  </div>

<script>
/** ========= CONFIG ========= **/
const WC_PROJECT_ID   = "YOUR_WALLETCONNECT_PROJECT_ID"; // <-- set this
const DEFAULT_CHAIN_ID = 11155111; // example: Sepolia. Replace with your L2 chain id.
const DEFAULT_LOCKER   = "";       // <-- put your deployed ToshLock/LiquidityProof
const DEFAULT_TOKEN    = "";       // optional: your test token address

/** ====== Minimal ABIs ====== **/
const ERC20_ABI = [
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function approve(address spender, uint256 value) returns (bool)"
];
const LOCKER_ABI = [
  "function lockLiquidity(address token, uint256 amount, uint256 lockTime)"
];

/** ====== UI refs ====== **/
const $ = (id) => document.getElementById(id);
$("token").value  = DEFAULT_TOKEN;
$("locker").value = DEFAULT_LOCKER;

/** ====== State ====== **/
let wcProvider = null;       // WalletConnect provider (raw)
let web3Provider = null;     // ethers.providers.Web3Provider (v5)
let signer = null;
let account = null;
let chainId = null;

/** ====== Helpers ====== **/
function log(...args){ $("log").textContent += args.join(" ") + "\n"; }
function ensureAddr(a){ return ethers.utils.getAddress(a); }
function toUnits(human, decimals){ return ethers.utils.parseUnits(human || "0", decimals); }
function toTimestampLocal(inputEl){
  const v = inputEl.value;
  if(!v) throw new Error("pick a future lock date/time");
  const ms = Date.parse(v);
  if(Number.isNaN(ms)) throw new Error("invalid date");
  const s = Math.floor(ms/1000);
  if(s <= Math.floor(Date.now()/1000)) throw new Error("lock time must be in the future");
  return s;
}

/** ====== Connect: MetaMask ====== **/
$("connect-metamask").onclick = async () => {
  try{
    if(!window.ethereum) throw new Error("MetaMask not found");
    web3Provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    await web3Provider.send("eth_requestAccounts", []);
    const net = await web3Provider.getNetwork();
    signer = web3Provider.getSigner();
    account = await signer.getAddress();
    chainId = net.chainId;
    $("connStatus").textContent = `Connected MM: ${account.slice(0,6)}â€¦${account.slice(-4)} on chain ${chainId}`;
    log("Connected MetaMask", account, "chain", chainId);
  }catch(e){ log("MetaMask connect error:", e.message || e); }
};

/** ====== Connect: WalletConnect (QR) ====== **/
$("connect-wc").onclick = async () => {
  try{
    if(!WC_PROJECT_ID) throw new Error("Set WC_PROJECT_ID");
    wcProvider = await window.EthereumProvider.init({
      projectId: WC_PROJECT_ID,
      chains: [DEFAULT_CHAIN_ID],         // required chain(s)
      optionalChains: [DEFAULT_CHAIN_ID],
      methods: ["eth_sendTransaction","personal_sign","eth_signTypedData","eth_signTypedData_v4"],
      optionalMethods: ["eth_sign","eth_accounts"],
      showQrModal: true
    });
    await wcProvider.enable(); // opens QR modal
    web3Provider = new ethers.providers.Web3Provider(wcProvider, "any");
    signer = web3Provider.getSigner();
    account = await signer.getAddress();
    const net = await web3Provider.getNetwork();
    chainId = net.chainId;
    $("connStatus").textContent = `Connected WC: ${account.slice(0,6)}â€¦${account.slice(-4)} on chain ${chainId}`;
    log("Connected WalletConnect", account, "chain", chainId);

    // keep UI fresh on events
    wcProvider.on("accountsChanged", async (accs)=> {
      account = accs[0];
      $("connStatus").textContent = `Connected WC: ${account.slice(0,6)}â€¦${account.slice(-4)} on chain ${chainId}`;
      log("accountsChanged", account);
    });
    wcProvider.on("chainChanged", async (cid)=> {
      const net = await web3Provider.getNetwork();
      chainId = net.chainId;
      $("connStatus").textContent = `Connected WC: ${account.slice(0,6)}â€¦${account.slice(-4)} on chain ${chainId}`;
      log("chainChanged", chainId);
    });
  }catch(e){ log("WalletConnect error:", e.message || e); }
};

/** ====== core actions ====== **/
$("readToken").onclick = async () => {
  try{
    if(!signer) throw new Error("connect a wallet first");
    const token = new ethers.Contract(ensureAddr($("token").value), ERC20_ABI, signer);
    const [name, symbol, decimals] = await Promise.all([token.name(), token.symbol(), token.decimals()]);
    log(`Token: ${name} (${symbol}), decimals=${decimals}`);
  }catch(e){ log("Read token error:", e.message || e); }
};

$("approve").onclick = async () => {
  try{
    if(!signer) throw new Error("connect a wallet first");
    const tokenAddr  = ensureAddr($("token").value);
    const lockerAddr = ensureAddr($("locker").value);
    const token = new ethers.Contract(tokenAddr, ERC20_ABI, signer);
    const decimals = await token.decimals();
    const amount = toUnits($("amount").value, decimals);
    const tx = await token.approve(lockerAddr, amount);
    log("Approval sent:", tx.hash);
    await tx.wait();
    log("âœ… Approval confirmed");
  }catch(e){ log("Approve error:", e.data?.message || e.message || e); }
};

$("lock").onclick = async () => {
  try{
    if(!signer) throw new Error("connect a wallet first");
    const tokenAddr  = ensureAddr($("token").value);
    const lockerAddr = ensureAddr($("locker").value);
    const token = new ethers.Contract(tokenAddr, ERC20_ABI, signer);
    const locker = new ethers.Contract(lockerAddr, LOCKER_ABI, signer);
    const decimals = await token.decimals();
    const amount = toUnits($("amount").value, decimals);
    const when = toTimestampLocal($("locktime"));

    const allowance = await token.allowance(account, lockerAddr);
    if(allowance.lt(amount)) throw new Error("Insufficient allowance; approve the full amount first");

    const tx = await locker.lockLiquidity(tokenAddr, amount, when);
    log("Lock sent:", tx.hash);
    await tx.wait();
    log("ðŸ”’ Lock confirmed");
  }catch(e){ log("Lock error:", e.data?.message || e.message || e); }
};

$("approveLock").onclick = async () => {
  try{
    if(!signer) throw new Error("connect a wallet first");
    const tokenAddr  = ensureAddr($("token").value);
    const lockerAddr = ensureAddr($("locker").value);
    const token = new ethers.Contract(tokenAddr, ERC20_ABI, signer);
    const locker = new ethers.Contract(lockerAddr, LOCKER_ABI, signer);
    const decimals = await token.decimals();
    const amount = toUnits($("amount").value, decimals);
    const when = toTimestampLocal($("locktime"));

    const tx1 = await token.approve(lockerAddr, amount);
    log("Approval sent:", tx1.hash);
    await tx1.wait();
    log("âœ… Approval confirmed");

    const tx2 = await locker.lockLiquidity(tokenAddr, amount, when);
    log("Lock sent:", tx2.hash);
    await tx2.wait();
    log("ðŸ”’ Lock confirmed");
  }catch(e){ log("Approve+Lock error:", e.data?.message || e.message || e); }
};
</script>
</body>
</html>
