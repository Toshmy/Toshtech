<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ToshLock â€“ Approve & Lock</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- ethers v5 UMD -->
  <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- WalletConnect Ethereum Provider v2 UMD -->

  <script src="https://unpkg.com/@walletconnect/ethereum-provider@2.11.1/dist/umd/index.min.js"></script>

</head>
<body class="min-h-screen bg-gray-900 text-white">
  <div class="max-w-2xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-6">ðŸ”’ ToshLock â€” Approve & Lock</h1>

    <!-- Connect -->
    <div class="flex gap-3 mb-6">
      <button id="connect-metamask" class="px-4 py-2 rounded bg-green-600 hover:bg-green-700">Connect MetaMask</button>
      <button id="connect-wc" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700">WalletConnect</button>
      <span id="connStatus" class="text-sm text-gray-300"></span>
    </div>

    <!-- Form -->
    <div class="space-y-4 bg-white bg-opacity-5 p-4 rounded-xl border border-white border-opacity-10">
      <div>
        <label class="block text-sm text-gray-300 mb-1">Token address</label>
        <input id="token" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="0x... token"/>
        <p id="tokenMeta" class="text-xs text-gray-400 mt-1">â€”</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
        <div>
          <label class="block text-sm text-gray-300 mb-1">Amount (human)</label>
          <input id="amount" type="number" min="0" step="any" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="1000"/>
          <p id="amountHint" class="text-xs text-gray-400 mt-1">â€”</p>
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-1">Lock until (local time)</label>
          <input id="locktime" type="datetime-local" class="w-full p-2 rounded bg-gray-800 border border-gray-700"/>
        </div>
      </div>

      <div>
        <label class="block text-sm text-gray-300 mb-1">Lock name (optional)</label>
        <input id="lockname" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="Liquidity Round #1"/>
      </div>

      <div class="flex flex-wrap gap-3 pt-2">
        <button id="approve"     class="px-4 py-2 rounded bg-yellow-600 hover:bg-yellow-700">Approve</button>
        <button id="approveLock" class="px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-700">Approve & Lock</button>
      </div>

      <div class="text-sm text-gray-300">
        Fee note: contract pulls <b>full amount</b>, sends <b>3%</b> to owner, locks the remaining <b>97%</b>.
      </div>
    </div>

    <pre id="log" class="mt-6 p-3 bg-black rounded-lg text-xs overflow-x-auto h-64"></pre>
  </div>

<script>
/** ====== HARDcoded config ====== **/
const LOCKER_ADDR   = "0xdAafaf8fC73C6D4dfE27B2494Bdc864D0f7C9c01";
const WC_PROJECT_ID = "6e2df48125e4f633b093361ba0a87c81";
const RPC_URL       = "https://rpc-pepu-v2-testnet-vn4qxxp9og.t.conduit.xyz";
const CHAIN_ID      = 97741; // change if your testnet uses a different id

/** ====== ABIs ====== **/
const ERC20_ABI = [
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function approve(address spender, uint256 value) returns (bool)"
];
const LOCKER_ABI = [
  "function lockLiquidity(address token, uint256 amount, uint256 lockTime)",
  "function lockLiquidityWithName(address token, uint256 amount, uint256 lockTime, string name)"
];

/** ====== Helpers ====== **/
const $ = (id) => document.getElementById(id);
function log(...args){ $("log").textContent += args.join(" ") + "\n"; }
function ensureAddr(a){ return ethers.utils.getAddress(a); }
function toUnits(human, decimals){ return ethers.utils.parseUnits(human || "0", decimals); }
function tsFromInput(el){
  const v = el.value;
  if(!v) throw new Error("pick a future lock date/time");
  const s = Math.floor(Date.parse(v)/1000);
  if(!s) throw new Error("invalid date");
  if(s <= Math.floor(Date.now()/1000)) throw new Error("lock time must be in the future");
  return s;
}
function getWcEthereumProviderUMD(){
  return window.WalletConnectEthereumProvider || null;
}

/** ====== State ====== **/
let provider, signer, account, chainId, wcProvider;
let tokenDecimals = null, tokenSymbol = "", tokenName = "";

/** ====== Read-only provider (for token meta) ====== **/
const roProvider = new ethers.providers.JsonRpcProvider(RPC_URL);

/** ====== Connect: MetaMask ====== **/
$("connect-metamask").onclick = async () => {
  try{
    if(!window.ethereum) throw new Error("MetaMask not found");
    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    await provider.send("eth_requestAccounts", []);
    const net = await provider.getNetwork();
    signer = provider.getSigner();
    account = await signer.getAddress();
    chainId = net.chainId;
    $("connStatus").textContent = `Connected MM: ${account.slice(0,6)}â€¦${account.slice(-4)} on chain ${chainId}`;
    log("Connected MetaMask", account, "chain", chainId);
  }catch(e){ log("MetaMask connect error:", e.message || e); }
};

/** ====== Connect: WalletConnect (QR) ====== **/
$("connect-wc").onclick = async () => {
  try{
    const WcEP = getWcEthereumProviderUMD();
    if(!WcEP) throw new Error("WalletConnect UMD not found (check the <script> tag)");
    wcProvider = await WcEP.init({
      projectId: WC_PROJECT_ID,
      showQrModal: true,
      optionalChains: [CHAIN_ID],
      rpcMap: { [CHAIN_ID]: RPC_URL },
      metadata: {
        name: "ToshLock",
        description: "Lock tokens with ToshLock",
        url: location.origin,
        icons: ["https://walletconnect.com/walletconnect-logo.png"]
      }
    });
    await wcProvider.enable();

    provider = new ethers.providers.Web3Provider(wcProvider, "any");
    signer   = provider.getSigner();
    account  = await signer.getAddress();
    const net= await provider.getNetwork();
    chainId  = net.chainId;

    $("connStatus").textContent = `Connected WC: ${account.slice(0,6)}â€¦${account.slice(-4)} on chain ${chainId}`;
    log("Connected WalletConnect", account, "chain", chainId);
  }catch(e){ log("WalletConnect error:", e.message || e); }
};

/** ====== Auto-read token meta on input ====== **/
async function refreshTokenMeta() {
  const addr = $("token").value.trim();
  if(!addr || !addr.startsWith("0x") || addr.length !== 42){
    $("tokenMeta").textContent = "â€”";
    $("amountHint").textContent = "â€”";
    tokenDecimals = null; tokenSymbol = ""; tokenName = "";
    return;
  }
  try{
    const token = new ethers.Contract(ensureAddr(addr), ERC20_ABI, roProvider);
    const [name, symbol, decimals] = await Promise.all([token.name(), token.symbol(), token.decimals()]);
    tokenName = name; tokenSymbol = symbol; tokenDecimals = decimals;
    $("tokenMeta").textContent = `${name} (${symbol}), decimals=${decimals}`;
    const human = $("amount").value || "0";
    if(human && tokenDecimals !== null){
      const units = ethers.utils.parseUnits(human, tokenDecimals);
      $("amountHint").textContent = `= ${units.toString()} base units`;
    }
  }catch(e){
    $("tokenMeta").textContent = "âš ï¸ failed to read token metadata";
    tokenDecimals = null; tokenSymbol = ""; tokenName = "";
  }
}
$("token").addEventListener("change", refreshTokenMeta);
$("token").addEventListener("blur", refreshTokenMeta);
$("amount").addEventListener("input", () => {
  if(tokenDecimals === null){ $("amountHint").textContent = "enter a valid token first"; return; }
  try{
    const units = ethers.utils.parseUnits($("amount").value || "0", tokenDecimals);
    $("amountHint").textContent = `= ${units.toString()} base units`;
  }catch{ $("amountHint").textContent = "â€”"; }
});

/** ====== Approve / Lock ====== **/
$("approve").onclick = async () => {
  try{
    if(!signer) throw new Error("connect a wallet first");
    if(tokenDecimals === null) await refreshTokenMeta();

    const tokenAddr  = ensureAddr($("token").value);
    const token      = new ethers.Contract(tokenAddr, ERC20_ABI, signer);
    const amount     = ethers.utils.parseUnits($("amount").value || "0", tokenDecimals || 18);
    if(amount.lte(0)) throw new Error("amount must be > 0");

    const tx = await token.approve(LOCKER_ADDR, amount);
    log("Approval sent:", tx.hash);
    await tx.wait();
    log("âœ… Approval confirmed");
  }catch(e){ log("Approve error:", e.data?.message || e.message || e); }
};

$("approveLock").onclick = async () => {
  try{
    if(!signer) throw new Error("connect a wallet first");
    if(tokenDecimals === null) await refreshTokenMeta();

    const tokenAddr  = ensureAddr($("token").value);
    const token      = new ethers.Contract(tokenAddr, ERC20_ABI, signer);
    const locker     = new ethers.Contract(LOCKER_ADDR, LOCKER_ABI, signer);

    const amount = ethers.utils.parseUnits($("amount").value || "0", tokenDecimals || 18);
    if(amount.lte(0)) throw new Error("amount must be > 0");
    const when   = tsFromInput($("locktime"));
    const name   = $("lockname").value || "";

    // 1) approve
    const tx1 = await token.approve(LOCKER_ADDR, amount);
    log("Approval sent:", tx1.hash);
    await tx1.wait();
    log("âœ… Approval confirmed");

    // 2) lock (prefer named function if present)
    let tx2;
    if (locker.interface.functions["lockLiquidityWithName(address,uint256,uint256,string)"]) {
      tx2 = await locker.lockLiquidityWithName(tokenAddr, amount, when, name);
    } else {
      tx2 = await locker.lockLiquidity(tokenAddr, amount, when);
    }
    log("Lock sent:", tx2.hash);
    await tx2.wait();
    log("ðŸ”’ Lock confirmed");
  }catch(e){ log("Approve+Lock error:", e.data?.message || e.message || e); }
};
</script>
</body>
</html>
