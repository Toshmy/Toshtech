<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ToshRank ‚Äî Projects with Active Locks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0c1222; --bg-2:#0b1226; --fg:#e8fff6; --muted:#a8ffd9;
      --accent:#00ffae; --accent-2:#00d99c; --card:rgba(255,255,255,.05);
      --border:rgba(0,255,174,.2); --shadow:0 0 30px rgba(0,255,255,.18);
      --green:#00ffae; --red:#ff6b6b;
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;background:radial-gradient(circle at 20% 10%, #1a2238 0%, var(--bg) 70%);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    a{color:#93c5fd;text-decoration:none}
    .wrap{max-width:1150px;margin:24px auto;padding:0 16px}
    .glow-text{text-shadow:0 0 12px var(--accent),0 0 24px var(--accent)}
    .card{background:var(--card);border:1px solid var(--border);backdrop-filter:blur(6px);border-radius:14px;box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-block;padding:.25rem .6rem;border-radius:999px;background:#081021;border:1px solid var(--border);color:#a8ffd9}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.12);font-size:13px;white-space:nowrap}
    th{text-align:left;background:var(--bg-2);position:sticky;top:0}
    .table-scroll{overflow:auto;border-radius:12px}

    .progress{height:8px;background:#0f1730;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent), var(--accent-2));width:0%}

    .supplybar{height:10px;background:#0f1730;border:1px solid var(--border);border-radius:6px;display:flex;overflow:hidden}
    .supplybar .circ{background:var(--green);height:100%}
    .supplybar .burn{background:var(--red);height:100%}

    .muted{color:var(--muted);opacity:.92}
    .small{font-size:12px;color:#bfeede}
    .center{display:flex;align-items:center;justify-content:center;padding:18px;color:#bfeede}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    th.sortable{cursor:pointer}
    th.sortable .dir{opacity:.75;font-size:12px;margin-left:4px}

    td.token-cell{white-space:normal}
    .token-head{display:flex;align-items:center;gap:12px;justify-content:space-between}
    .token-left{display:flex;align-items:center;gap:10px;min-width:0;flex:1}
    .token-logo{width:36px;height:36px;border-radius:8px;object-fit:cover;border:1px solid var(--border);background:#0b1226;flex:0 0 36px}
    .token-name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
    .token-ca a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:inline-block;max-width:100%}

    .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:.22rem .6rem;background:#081021}
    .chip .emoji{font-size:12px;opacity:.9}
    .token-links{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

    td.supply-cell{min-width:200px;white-space:normal}

    .mobile-toolbar{display:none; gap:8px; align-items:center; margin:8px 0 0;}
    .btn{cursor:pointer; border:1px solid var(--border); background:#081021; color:#a8ffd9; border-radius:999px; padding:.4rem .8rem; font-size:12px;}
    .btn:active{transform:translateY(1px)}

    @media (max-width: 640px){
      thead{display:none}
      table, tbody, tr, td{display:block;width:100%}
      tr{margin:12px 0; border:1px solid var(--border); border-radius:12px;background:var(--card); box-shadow:var(--shadow); padding:10px}
      .mobile-toolbar{display:flex}
      tr .row-index{display:none}
      td[data-label]{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;padding:8px 4px}
      td[data-label]::before{content:attr(data-label);flex:0 0 42%;font-size:11px;color:#bfeede;opacity:.8;text-transform:uppercase}
      .cell-val{flex:1;text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:4px}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="row" style="justify-content:space-between;margin-bottom:10px">
      <h1 class="glow-text" style="margin:0">üèÜ ToshRank ‚Äî Projects with Active Locks</h1>
      <span id="status" class="pill">Loading‚Ä¶</span>
    </header>

    <div class="mobile-toolbar">
      <button id="btnSortTVL" class="btn">Sort by TVL</button>
      <span class="small" id="sortHint"></span>
    </div>

    <section class="table-scroll card" style="padding:0">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Token</th>
            <th>Locked %</th>
            <th>Unlock Date</th>
            <th id="thTVL" class="sortable">TVL<span class="dir" id="dirTVL"></span></th>
            <th>Supply / MC / FDV</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
      <div id="empty" class="center" style="display:none">No active locks found.</div>
    </section>
  </div>

<script>
/* ===== CONFIG ===== */
const CONFIG = {
  LOCKER: "0xCCEfe66507762370C2487dd198d7D1fEfc6dEF8F",
  RPC: "https://rpc-pepu-v2-mainnet-0.t.conduit.xyz",
  EXPLORER: "https://explorer-pepu-v2-mainnet-0.t.conduit.xyz"
};
const POOLS_JSON_URL = "pools_cache.json";
const BURN_ADDRS = [
  "0xa9fD599cd8857e90059c83e4885Dc09986039085",
  "0x000000000000000000000000000000000000dEaD"
];
const ERC20 = [
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function totalSupply() view returns (uint256)",
  "function balanceOf(address) view returns (uint256)"
];
const LOCKER_ABI = [
  "function getActiveLocksByToken(address token,uint256 offset,uint256 limit) view returns (uint256[] lockIds,address[] owners,uint256[] amounts,uint256[] unlockTimes,string[] names)"
];

/* ===== Helpers ===== */
const $ = id => document.getElementById(id);
function shortAddr(a){ return a ? a.slice(0,6)+"‚Ä¶"+a.slice(-4) : ""; }
function fmtNum(n){ return Number(n).toLocaleString(undefined,{maximumFractionDigits:4}); }
function bnToNum(bn,dec){ try{return Number(ethers.utils.formatUnits(bn,dec))}catch{return 0;} }
function timeFromNow(ts){const now=Math.floor(Date.now()/1000),diff=ts-now,abs=Math.abs(diff);const m=Math.floor(abs/60),h=Math.floor(m/60),d=Math.floor(h/24);const u=d?["day",d]:h?["hour",h]:m?["min",m]:["sec",abs];return diff>=0?`in ${u[1]} ${u[0]}${u[1]>1?"s":""}`:`${u[1]} ${u[0]}${u[1]>1?"s":""} ago`;}

/* ===== Providers ===== */
const ro = new ethers.providers.JsonRpcProvider(CONFIG.RPC);
const locker = new ethers.Contract(CONFIG.LOCKER, LOCKER_ABI, ro);

let marketCaps = new Map();
let DATA = [];
let tvlSortDir = -1;

/* ===== Load pools_cache.json ===== */
async function loadMarketCaps(){
  const r=await fetch(POOLS_JSON_URL); if(!r.ok) return;
  const js=await r.json();
  js.forEach(row=>{
    const addr=(row.address||"").toLowerCase();
    if(/^0x[a-fA-F0-9]{40}$/.test(addr)){
      marketCaps.set(addr,{
        price: Number(row.price||0),
        mc: Number(row.market_cap||0),
        reserve: Number(row.reserve_in_usd||0),
        symbol: row.symbol||"",
        name: row.name||""
      });
    }
  });
}

/* ===== Locks summary ===== */
async function getLocksSummary(token){
  const [ids,owners,amts,uts]=await locker.getActiveLocksByToken(token,0,1000).catch(()=>[[],[],[],[]]);
  let sum=ethers.BigNumber.from(0),earliest=null;
  ids.forEach((id,i)=>{sum=sum.add(amts[i]);const ut=Number(uts[i]);if(!earliest||ut<earliest)earliest=ut;});
  return {sumLocked:sum,earliestUnlock:earliest};
}

/* ===== Fetch one token ===== */
async function fetchToken(addr){
  try{
    const {sumLocked,earliestUnlock}=await getLocksSummary(addr);
    if(!sumLocked||sumLocked.isZero())return null;
    const t=new ethers.Contract(addr,ERC20,ro);
    const [name,sym,dec,total,...burns]=await Promise.all([
      t.name().catch(()=>""),t.symbol().catch(()=>""),t.decimals().catch(()=>18),
      t.totalSupply().catch(()=>ethers.BigNumber.from(0)),
      ...BURN_ADDRS.map(a=>t.balanceOf(a).catch(()=>ethers.BigNumber.from(0)))
    ]);
    let burned=ethers.BigNumber.from(0);burns.forEach(b=>burned=burned.add(b));
    const locked=bnToNum(sumLocked,dec),tot=bnToNum(total,dec),burn=bnToNum(burned,dec);
    const circ=Math.max(0,tot-burn);
    const lockedPct=circ>0?(locked/circ*100):0;

    const m=marketCaps.get(addr.toLowerCase())||{};
    const price=m.price||0;
    const mc=circ*price;
    const fdv=tot*price;
    const tvl=locked*price;

    return {address:addr,name:name||m.name,symbol:sym||m.symbol,total:tot,circ,locked,lockedPct,burn,price,mc,fdv,tvl,nextUnlock:earliestUnlock};
  }catch{return null;}
}

/* ===== Append row ===== */
function appendRow(p,i){
  const rows=$("rows");
  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td>${i}</td>
    <td class="token-cell"><div class="token-head"><div class="token-left"><div class="token-name">${p.name||p.symbol}</div><div class="small mono"><a href="${CONFIG.EXPLORER}/address/${p.address}" target="_blank">${shortAddr(p.address)}</a></div></div></div></td>
    <td><div class="progress"><i style="width:${p.lockedPct.toFixed(2)}%"></i></div><div class="small">${p.lockedPct.toFixed(2)}%</div></td>
    <td>${p.nextUnlock?timeFromNow(p.nextUnlock):"‚Äî"}</td>
    <td>$${fmtNum(p.tvl)}</td>
    <td class="supply-cell">
      <div class="small">Price: $${fmtNum(p.price)}</div>
      <div class="small">Circ: ${fmtNum(p.circ)}</div>
      <div class="small">MC: $${fmtNum(p.mc)}</div>
      <div class="small">FDV: $${fmtNum(p.fdv)}</div>
    </td>
  `;
  rows.appendChild(tr);
}

/* ===== Build ===== */
async function build(){
  $("status").textContent="Loading‚Ä¶";
  await loadMarketCaps();

  // Discover tokens by scanning logs
  const topic0=ethers.utils.id("LiquidityLocked(address,address,uint256,uint256,uint256,string)");
  const latest=await ro.getBlockNumber();
  const from=Math.max(0,latest-600000);
  const logs=await ro.getLogs({address:locker.address,topics:[topic0],fromBlock:from,toBlock:"latest"});
  const tokens=[...new Set(logs.map(l=>"0x"+l.topics[1].slice(26)).map(a=>a.toLowerCase()))];

  DATA=[];
  let i=0;
  for(const addr of tokens){
    const row=await fetchToken(addr);
    if(row){DATA.push(row);appendRow(row,++i);}
    $("status").textContent=`Loaded ${i}/${tokens.length}`;
  }
  $("status").textContent=`Projects: ${i}`;
}

/* ===== Events ===== */
document.getElementById("thTVL").addEventListener("click",()=>{tvlSortDir*=-1;DATA.sort((a,b)=>tvlSortDir*((b.tvl||0)-(a.tvl||0)));$("rows").innerHTML="";DATA.forEach((p,i)=>appendRow(p,i+1));});
document.getElementById("btnSortTVL").addEventListener("click",()=>{tvlSortDir*=-1;DATA.sort((a,b)=>tvlSortDir*((b.tvl||0)-(a.tvl||0)));$("rows").innerHTML="";DATA.forEach((p,i)=>appendRow(p,i+1));});

document.addEventListener("DOMContentLoaded",build);
</script>
</body>
</html>
