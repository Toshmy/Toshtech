<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ToshLock ‚Äî Dashboard (Active Locks)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0c1222;--fg:#fff;--card:rgba(255,255,255,.06);--border:rgba(255,255,255,.12)}
    body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0}
    .wrap{max-width:1100px;margin:32px auto;padding:0 18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid var(--border);font-size:13px}
    th{text-align:left;background:#0b1226}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    input,button{border-radius:10px;padding:8px 10px;border:1px solid var(--border);background:#0f1730;color:#fff}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-block;padding:.2rem .55rem;border-radius:999px;background:#1f2937;border:1px solid #374151}
  </style>

  <!-- ethers v5 (read-only usage here) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>üìä ToshLock ‚Äî Active Locks (Global)</h1>

  <!-- Token Status -->
  <section class="card" style="margin-bottom:18px">
    <h2 style="margin:0 0 12px">Token Status</h2>
    <div class="row">
      <input id="token" class="mono" placeholder="0x... token" style="flex:1 1 420px">
      <button id="scan">Load Active Locks</button>
      <span id="count" class="pill">‚Äî</span>
      <span id="total" class="pill">Total: ‚Äî</span>
    </div>

    <div class="card" style="margin-top:12px;padding:0">
      <table>
        <thead>
          <tr>
            <th>Lock ID</th><th>Owner</th><th>Name</th>
            <th style="text-align:right">Amount</th><th>Symbol</th><th>Unlock</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <pre id="log" class="card" style="margin-top:12px;height:160px;overflow:auto"></pre>
  </section>

  <!-- Wallet + Token view -->
  <section class="card">
    <h2 style="margin:0 0 12px">Wallet Locks (by Token)</h2>
    <div class="row">
      <input id="token2" class="mono" placeholder="0x... token" style="flex:1 1 360px">
      <input id="wallet" class="mono" placeholder="0x... wallet" style="flex:1 1 360px">
      <button id="scanWallet">Load Wallet Locks</button>
    </div>

    <div class="card" style="margin-top:12px;padding:0">
      <table>
        <thead>
          <tr>
            <th>Lock ID</th><th>Name</th><th style="text-align:right">Amount</th><th>Symbol</th><th>Unlock</th><th>Active</th>
          </tr>
        </thead>
        <tbody id="rows2"></tbody>
      </table>
    </div>

    <pre id="log2" class="card" style="margin-top:12px;height:160px;overflow:auto"></pre>
  </section>
</div>

<script>
/* ===== Hardcoded env ===== */
const LOCKER   = "0x189ef775DcC7782802ca16b870Da7B5FaE3C8524";
const RPC      = "https://rpc-pepu-v2-testnet-vn4qxxp9og.t.conduit.xyz";

/* ===== ABIs ===== */
const ERC20 = [
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)"
];
const LOCKER_ABI = [
  "function getActiveLocksByToken(address token,uint256 offset,uint256 limit) view returns (uint256[] lockIds,address[] owners,uint256[] amounts,uint256[] unlockTimes,string[] names)",
  "function getUserLockIds(address user,address token,uint256 offset,uint256 limit) view returns (uint256[] memory)",
  "function getLock(address token,uint256 lockId) view returns (address owner,uint256 amount,uint256 unlockTime,string name,bool active)"
];

const ro = new ethers.providers.JsonRpcProvider(RPC);
const lockerRO = new ethers.Contract(LOCKER, LOCKER_ABI, ro);

const $ = id=>document.getElementById(id);
const log = (...a)=>{ $("log").textContent += a.join(" ")+"\n"; };
const log2 = (...a)=>{ $("log2").textContent += a.join(" ")+"\n"; };

/* ===== Token Status ===== */
$("scan").onclick = async () => {
  try{
    $("rows").innerHTML=""; $("count").textContent="Loading‚Ä¶"; $("total").textContent="Total: ‚Äî"; $("log").textContent="";
    const token = $("token").value.trim();
    if(!/^0x[a-fA-F0-9]{40}$/.test(token)) throw new Error("Enter a valid token address");

    const erc = new ethers.Contract(token, ERC20, ro);
    const [sym, dec] = await Promise.all([erc.symbol().catch(()=>"?"), erc.decimals().catch(()=>18)]);

    const pageSize = 500, page = 0;
    const [ids, owners, amounts, unlockTimes, names] =
      await lockerRO.getActiveLocksByToken(token, page*pageSize, pageSize);

    const rows = $("rows");
    let total = ethers.BigNumber.from(0);
    const now = Math.floor(Date.now()/1000);

    for(let i=0;i<ids.length;i++){
      total = total.add(amounts[i]);
      const tr = document.createElement("tr");
      const human = ethers.utils.formatUnits(amounts[i], dec);
      const date  = new Date(Number(unlockTimes[i])*1000).toLocaleString();
      const owner = owners[i];
      tr.innerHTML = `
        <td>${ids[i].toString()}</td>
        <td class="mono" title="${owner}"><a href="https://explorer-pepu-v2-testnet-vn4qxxp9og.t.conduit.xyz/address/${owner}" target="_blank" style="color:#93c5fd;text-decoration:none">${owner.slice(0,6)}‚Ä¶${owner.slice(-4)}</a></td>
        <td>${names[i]||""}</td>
        <td style="text-align:right">${Number(human).toLocaleString()}</td>
        <td>${sym}</td>
        <td>${date} ${Number(unlockTimes[i])>now?'<span class="pill">‚è≥</span>':'<span class="pill">‚úÖ</span>'}</td>
      `;
      rows.appendChild(tr);
    }
    $("count").textContent = `Active: ${ids.length}`;
    $("total").textContent = `Total: ${ethers.utils.formatUnits(total, dec)} ${sym}`;
    log("Done.");
  }catch(e){ log("‚ùå", e?.data?.message || e?.message || String(e)); }
};

/* ===== Wallet + Token view ===== */
$("scanWallet").onclick = async () => {
  try{
    $("rows2").innerHTML=""; $("log2").textContent="";
    const token = $("token2").value.trim();
    const wallet = $("wallet").value.trim();
    if(!/^0x[a-fA-F0-9]{40}$/.test(token)) throw new Error("Enter a valid token address");
    if(!/^0x[a-fA-F0-9]{40}$/.test(wallet)) throw new Error("Enter a valid wallet address");

    const erc = new ethers.Contract(token, ERC20, ro);
    const [sym, dec] = await Promise.all([erc.symbol().catch(()=>"?"), erc.decimals().catch(()=>18)]);

    const ids = await lockerRO.getUserLockIds(wallet, token, 0, 500);
    const details = await Promise.all(ids.map(id => lockerRO.getLock(token, id)));

    const rows = $("rows2");
    const now = Math.floor(Date.now()/1000);

    for(let i=0;i<ids.length;i++){
      const [owner, amount, unlockTime, name, active] = details[i];
      const human = ethers.utils.formatUnits(amount, dec);
      const date  = new Date(Number(unlockTime)*1000).toLocaleString();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${ids[i].toString()}</td>
        <td>${name||""}</td>
        <td style="text-align:right">${Number(human).toLocaleString()}</td>
        <td>${sym}</td>
        <td>${date}</td>
        <td>${active ? (Number(unlockTime)>now?'<span class="pill">üîí</span>':'<span class="pill">‚è±</span>') : '<span class="pill">‚úÖ</span>'}</td>
      `;
      rows.appendChild(tr);
    }
    log2(`Locks loaded: ${ids.length}`);
  }catch(e){ log2("‚ùå", e?.data?.message || e?.message || String(e)); }
};
</script>
</body>
</html>
