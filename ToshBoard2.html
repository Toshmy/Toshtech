<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ToshBoard — ToshScore (Mainnet, CORS-fixed)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1221; --bg-2:#0b1426; --fg:#e8fff6; --muted:#a8ffd9;
      --accent:#00ffae; --accent-2:#00d99c; --card:rgba(255,255,255,.05);
      --border:rgba(0,255,174,.2); --shadow:0 0 30px rgba(0,255,174,.14);
      --red:#ff6b6b; --green:#2de3a1; --rowhi:rgba(255,255,255,.06);
      --warn:#ffb4b4; --ok:#7dffa8; --gray:#b6c4d1;
    }
    html,body{margin:0;background:radial-gradient(circle at 20% 10%, #1a2238 0%, var(--bg) 70%);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    a{color:#93c5fd;text-decoration:none}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .glow-text{text-shadow:0 0 12px var(--accent),0 0 24px var(--accent)}
    .card{background:var(--card);border:1px solid var(--border);backdrop-filter:blur(6px);border-radius:14px;box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    .muted{color:var(--muted);opacity:.9}
    input,button{border-radius:12px;border:1px solid var(--border);background:#0f1730;color:#fff;padding:10px}
    input:focus,button:focus{outline:2px solid var(--accent)}
    .btn{cursor:pointer;background:linear-gradient(135deg, var(--accent), var(--accent-2));color:#00251b;border:0;font-weight:700}
    .pill{display:inline-block;padding:.25rem .65rem;border-radius:999px;background:#081021;border:1px solid var(--border);color:#a8ffd9}
    .table-scroll{overflow:auto;border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.12);font-size:13px;vertical-align:middle}
    th{background:var(--bg-2);text-align:left;position:sticky;top:0;z-index:2}
    tr:hover{background:var(--rowhi)}
    .right{text-align:right}
    .small{font-size:12px}
    .gray{color:var(--gray)}
    .token-cell{display:flex;gap:10px;align-items:center}
    .score{font-weight:800;font-size:20px;padding:4px 10px;border-radius:10px;background:#0e1b2e;border:1px solid var(--border)}
    .score.good{color:#14d492} .score.mid{color:#ffd166} .score.bad{color:#ff6b6b}
    .supplybar{height:10px;border-radius:999px;background:#0f1730;border:1px solid var(--border);overflow:hidden}
    .supplybar i{display:block;height:100%}
    .supplybar .burn{background:linear-gradient(90deg,var(--red),#c94848)}
    .supplybar .circ{background:linear-gradient(90deg,var(--green),#14b97e)}
    .ac-wrap{position:relative;flex:1 1 340px;min-width:240px}
    .ac-list{position:absolute;left:0;right:0;top:calc(100% + 4px);background:#0f1730;border:1px solid rgba(0,255,174,.2);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.35);z-index:50;max-height:280px;overflow:auto;display:none}
    .ac-item{display:flex;gap:8px;align-items:center;padding:10px 12px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.06);font-size:13px}
    .ac-item:last-child{border-bottom:0}
    .ac-item:hover{background:#0b1329}
    .ac-name{font-weight:600}.ac-sym{color:#a8ffd9}.ac-addr{margin-left:auto;font-family:ui-monospace,monospace;color:#9fb;opacity:.85}
    .ac-empty{padding:10px 12px;color:#a8ffd9;font-size:12px}
    .sortable{cursor:pointer}
    details{background:#0f1730;border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:6px}
    summary{cursor:pointer;outline:none}
    .kvs{display:grid;grid-template-columns:170px 1fr;gap:6px 12px}
    .kvk{color:#a8ffd9}
  </style>

  <!-- ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="row" style="justify-content:space-between">
      <h1 class="glow-text" style="margin:0">📊 ToshBoard — ToshScore (Pepu L2 Mainnet)</h1>
      <div class="row">
        <span id="status" class="pill">Loading…</span>
      </div>
    </header>

    <section class="card" style="margin-top:12px">
      <div class="row" style="gap:8px;margin-bottom:8px">
        <div class="ac-wrap">
          <input id="q" placeholder="Search symbol / name / 0x..." autocomplete="off">
          <div id="ac" class="ac-list"></div>
        </div>
        <button id="reload" class="btn">Reload</button>
        <span class="pill">Mainnet • Only tokens with active ToshLock</span>
      </div>

      <div class="table-scroll card" style="padding:0;margin-top:8px">
        <table>
          <thead>
            <tr>
              <th style="min-width:340px">Token / ToshScore</th>
              <th>Event Date</th>
              <th class="right">Locked %</th>
              <th>Next Unlock</th>
              <th class="right sortable" id="sortTVL">TVL (Locked)</th>
              <th style="min-width:280px">Supply</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div id="log" class="small gray" style="margin-top:10px;white-space:pre-wrap"></div>
    </section>
  </div>

<script>
/* ====== MAINNET + CORS RELAY ====== */
const NET = {
  CHAIN: 97740,
  RPC: "https://rpc-pepu-v2-mainnet-0.t.conduit.xyz",
  LOCKER: "0xCCEfe66507762370C2487dd198d7D1fEfc6dEF8F",
  EXPLORER: "https://explorer-pepu-v2-mainnet-0.t.conduit.xyz"
};
// ⚠️ Set your Cloudflare Worker proxy (it should add Access-Control-Allow-Origin:* and stream JSON)
const RELAY = "https://odd-feather-f250.toshtech777.workers.dev/?url=";

// Burn sources
const BURN_ADDRESSES = [
  "0xa9fd599cd8857e90059c83e4885dc09986039085",
  "0x000000000000000000000000000000000000dead"
];

/* ====== ABIs ====== */
const ERC20 = [
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function totalSupply() view returns (uint256)",
  "function balanceOf(address) view returns (uint256)"
];
const LOCKER_ABI = [
  "function getActiveLocksByToken(address token,uint256 offset,uint256 limit) view returns (uint256[] lockIds,address[] owners,uint256[] amounts,uint256[] unlockTimes,string[] names)"
];

/* ====== Utils ====== */
const $ = id => document.getElementById(id);
const log = (...a)=>{ $("log").textContent += a.join(" ")+"\n"; };
const fmtUSD = n => n==null?'—' : n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
const fmtNum = (n,d=0)=> n==null?'—' : Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
function relTime(tsMs){
  if (!tsMs) return "—";
  const s = Math.max(1, Math.floor((Date.now() - tsMs)/1000));
  const m = Math.floor(s/60), h=Math.floor(m/60), d=Math.floor(h/24), mo=Math.floor(d/30);
  if (mo>0) return `${mo} month${mo>1?'s':''} ago`;
  if (d>0)  return `${d} day${d>1?'s':''} ago`;
  if (h>0)  return `${h} hour${h>1?'s':''} ago`;
  if (m>0)  return `${m} min${m>1?'s':''}`;
  return `${s} sec ago`;
}
function inFuture(tsMs){
  if (!tsMs) return "—";
  const s = Math.max(0, Math.floor((tsMs - Date.now())/1000));
  const m = Math.floor(s/60), h=Math.floor(m/60), d=Math.floor(h/24), mo=Math.floor(d/30);
  if (mo>0) return `in ${mo} month${mo>1?'s':''}`;
  if (d>0)  return `in ${d} day${d>1?'s':''}`;
  if (h>0)  return `in ${h} hour${h>1?'s':''}`;
  if (m>0)  return `in ${m} min${m>1?'s':''}`;
  return s>0?`in ${s} sec`:"—";
}
function daysUntil(tsMs){
  if (!tsMs) return 0;
  const d = (tsMs - Date.now()) / (1000*60*60*24);
  return Math.max(0, d);
}
function percentile90(values){
  if (!values.length) return 0;
  const a = values.slice().sort((x,y)=>x-y);
  const idx = Math.floor(0.9 * (a.length-1));
  return a[idx];
}

/* ====== State ====== */
let ro = new ethers.providers.JsonRpcProvider(NET.RPC);
let locker = new ethers.Contract(NET.LOCKER, LOCKER_ABI, ro);
let POOLS = []; // from pools_cache.json
let POOLMAP = new Map();
let VOTES = new Map(); // ca -> {votes, rank}
let CURRENT_ROWS = [];
let P90_RESERVE = 0;

// simple memo caches for speed per session
const cacheHoldersShare = new Map();
const cacheLocks = new Map();
const cacheSupply = new Map();

/* ====== Fetchers ====== */
async function fetchJSON(url){
  const r = await fetch(url,{cache:'no-cache'});
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}
async function loadPools(){
  const js = await fetchJSON("pools_cache.json");
  POOLS = (js.data||[]).map(x => ({
    address: (x.address||"").toLowerCase(),
    symbol: x.symbol||"",
    name: x.name||"",
    price: Number(x.price||0),
    market_cap: Number(x.market_cap||0),
    reserve_in_usd: Number(x.reserve_in_usd||0),
    pool_created_at: x.pool_created_at,
    buy_link: x.buy_link||""
  }));
  POOLMAP = new Map(POOLS.map(p=>[p.address,p]));
  $("status").textContent = `Pools loaded: ${POOLS.length}`;
}
async function fetchVotes(){
  try{
    const url = "https://holderradar.com/api/votes/ranking?period=30d&limit=100";
    const r = await fetch(RELAY + encodeURIComponent(url));
    if (!r.ok) throw new Error(`Votes relay HTTP ${r.status}`);
    const js = await r.json();
    const map = new Map();
    for (const it of js||[]){
      const ca = (it.contract||"").toLowerCase();
      if (ca) map.set(ca, { votes: Number(it.votes||0), rank: Number(it.rank||0) });
    }
    return map;
  }catch(e){
    log("Votes fetch failed:", e.message||e);
    return new Map();
  }
}

/* ====== Chain helpers ====== */
async function getActiveLocks(token){
  if (cacheLocks.has(token)) return cacheLocks.get(token);
  const res = await locker.getActiveLocksByToken(token,0,1000);
  const [ids, owners, amounts, unlockTimes, names] = res;
  if (!ids.length) { cacheLocks.set(token,null); return null; }

  let sum = ethers.BigNumber.from(0);
  let nextUnlock = null, lastUnlock = 0;
  const now = Math.floor(Date.now()/1000);
  for (let i=0;i<ids.length;i++){
    sum = sum.add(amounts[i]);
    const ut = Number(unlockTimes[i]);
    if (nextUnlock===null || (ut>now && ut<nextUnlock)) nextUnlock = ut;
    if (ut>lastUnlock) lastUnlock = ut;
  }
  const out = {
    totalLocked: sum,
    nextUnlock: nextUnlock ? nextUnlock*1000 : null,
    lastUnlock: lastUnlock ? lastUnlock*1000 : null,
    count: ids.length
  };
  cacheLocks.set(token,out);
  return out;
}
async function getSupplyAndBurn(token){
  if (cacheSupply.has(token)) return cacheSupply.get(token);
  const erc = new ethers.Contract(token, ERC20, ro);
  const [dec, total, symbol, name] = await Promise.all([
    erc.decimals().catch(()=>18),
    erc.totalSupply(),
    erc.symbol().catch(()=>"?"),
    erc.name().catch(()=>"?"),
  ]);
  let burned = ethers.BigNumber.from(0);
  for (const a of BURN_ADDRESSES){
    const b = await erc.balanceOf(a).catch(()=>ethers.BigNumber.from(0));
    burned = burned.add(b);
  }
  const out = { decimals:Number(dec), total, burned, symbol, name };
  cacheSupply.set(token,out);
  return out;
}

/* ====== Holders (Top-10 share) via RELAY to avoid CORS ====== */
async function fetchHoldersTopShare(ca, total, decimals){
  const key = ca.toLowerCase();
  if (cacheHoldersShare.has(key)) return cacheHoldersShare.get(key);

  const EXCLUDE = new Set([...BURN_ADDRESSES, NET.LOCKER.toLowerCase()]);
  const baseUrl = `${NET.EXPLORER}/api/v2/tokens/${ca}/holders`;
  let nextUrl = RELAY + encodeURIComponent(baseUrl);
  let items = [];
  let guard=0;

  while (nextUrl && guard<6){ // ~300 holders max
    const r = await fetch(nextUrl);
    if (!r.ok) break;
    const js = await r.json();
    items = items.concat(js.items||[]);
    const npp = js.next_page_params;
    if (npp){
      const url2 = `${baseUrl}?address_hash=${encodeURIComponent(npp.address_hash)}&items_count=${encodeURIComponent(npp.items_count)}&value=${encodeURIComponent(npp.value)}`;
      nextUrl = RELAY + encodeURIComponent(url2);
    }else nextUrl = null;
    guard++;
    if (items.length>=200) break;
  }

  // balances excluding burns + locker
  const balances = [];
  for (const it of items){
    const addr = (it.address?.hash||"").toLowerCase();
    if (!addr || EXCLUDE.has(addr)) continue;
    const val = it.value ? Number(it.value) : 0; // base units numeric
    balances.push(val);
  }
  const humanBalances = balances.map(v=> v / (10**decimals));
  humanBalances.sort((a,b)=>b-a);
  const top10 = humanBalances.slice(0,10);
  const top10Sum = top10.reduce((s,x)=>s+x,0);
  const nonExcludedTotal = Math.max(0, total); // conservative vs total supply
  const share = nonExcludedTotal>0 ? (top10Sum / nonExcludedTotal) : 0; // 0..1

  cacheHoldersShare.set(key, share);
  return share;
}

/* ====== Scoring ====== */
function scoreLockedPct(lockedPct){
  const capped = Math.min(95, Math.max(0, lockedPct||0));
  return (capped/95)*30;
}
function scoreTimeSafety(nextUnlockMs){
  const d = daysUntil(nextUnlockMs);
  return Math.max(0, Math.min(1, d/90)) * 10;
}
function scoreAge(days){
  if (days>=90) return 10;
  if (days>=30) return 7;
  if (days>=7)  return 4;
  return 1;
}

function scoreDepth(reserve){
  if (!P90_RESERVE || !reserve) return 0;
  return Math.max(0, Math.min(1, reserve / P90_RESERVE)) * 10;
}
function scoreVotes(votes){
  if (!VOTES.size) return 0;
  let max=0;
  VOTES.forEach(v=>{ if (v.votes>max) max=v.votes; });
  if (!max) return 0;
  return (Math.min(votes||0, max)/max)*10;
}
function scoreTop10Share(frac){
  const pct = (frac||0)*100;
  if (pct<=20) return 10;
  if (pct<=40) return 6;
  if (pct<=60) return 3;
  return 0;
}
function classifyScore(s){
  if (s>=75) return 'good';
  if (s>=50) return 'mid';
  return 'bad';
}

/* ====== Row render ====== */
function supplyBarHTML(circPct, burnPct, circText, burnText){
  const circW = Math.max(0, Math.min(100, circPct||0));
  const burnW = Math.max(0, Math.min(100, burnPct||0));
  return `
    <div class="small gray">${circText}  •  ${burnText}</div>
    <div class="supplybar"><i class="circ" style="width:${circW}%"></i><i class="burn" style="width:${burnW}%"></i></div>`;
}
function detailsHTML(d){
  return `
  <details>
    <summary>Score breakdown</summary>
    <div class="kvs" style="margin-top:8px">
      <div class="kvk">Liquidity Lock</div><div>
        Locked %: ${d.lockedPct?.toFixed(2)||'—'}% → ${d.s_locked.toFixed(1)}/30<br>
        Next unlock: ${inFuture(d.nextUnlock)||'—'} → ${d.s_time.toFixed(1)}/10
      </div>
      <div class="kvk">Age & Consistency</div><div>
        Pool age: ${d.ageDays.toFixed(0)} days → ${d.s_age.toFixed(1)}/10
      </div>
      <div class="kvk">On-chain Health</div><div>
        Reserve: ${fmtUSD(d.reserve)} vs P90 ${fmtUSD(P90_RESERVE)} → ${d.s_depth.toFixed(1)}/10<br>
        24h vol penalty: N/A → 0/5
      </div>
      <div class="kvk">Community Reputation</div><div>
        Votes (30d): ${d.votes||0} (max ${d.maxVotes||0}) → ${d.s_votes.toFixed(1)}/10
      </div>
      <div class="kvk">Holders Quality</div><div>
        Top10 share: ${(d.top10Share*100).toFixed(2)}% → ${d.s_top10.toFixed(1)}/10
      </div>
      <div class="kvk">Dev Transparency</div><div>
        N/A (creator endpoint not integrated yet) → 0/15
      </div>
      <div class="kvk">TVL (Locked)</div><div>${fmtUSD(d.tvlUSD)} = ${fmtNum(d.lockedTokens,0)} × ${fmtUSD(d.priceUSD)}</div>
      <div class="kvk">Supply</div><div>
        Total: ${fmtNum(d.total,0)} • Burned: ${fmtNum(d.burn,0)} • Circulating: ${fmtNum(d.circ,0)}
      </div>
    </div>
  </details>`;
}
function tokenCellHTML(sym, name, ca, score){
  const link = `https://www.toshtech.xyz/tdbv8.html?token=${ca}`;
  const cls = 'score '+classifyScore(score);
  return `
  <div class="token-cell">
    <div>
      <div><strong>${sym}</strong> — ${name}</div>
      <div class="small mono"><a href="${link}" target="_blank">${ca}</a></div>
    </div>
    <div style="margin-left:auto"><span class="${cls}">${Math.round(score)}</span></div>
  </div>`;
}
function rowHTML(o){
  const supplyHTML = supplyBarHTML(
    o.circPct, o.burnPct,
    `Circulating: ${fmtNum(o.circ,0)}`,
    `Burned: ${fmtNum(o.burn,0)}`
  );
  return `
  <tr>
    <td>${tokenCellHTML(o.symbol, o.name, o.ca, o.score)}${detailsHTML(o)}</td>
    <td>${o.eventDate ? relTime(o.eventDate) : "—"}</td>
    <td class="right">${o.lockedPct!=null ? o.lockedPct.toFixed(2)+'%' : '—'}</td>
    <td>${o.nextUnlock ? inFuture(o.nextUnlock) : "—"}</td>
    <td class="right">${o.tvlUSD!=null ? fmtUSD(o.tvlUSD) : '—'}</td>
    <td>${supplyHTML}</td>
  </tr>`;
}
function render(){
  const tbody = $("rows");
  tbody.innerHTML = "";
  CURRENT_ROWS.forEach(r => tbody.insertAdjacentHTML('beforeend', rowHTML(r)));
}

/* ====== Search / AC ====== */
function attachAutocomplete(){
  const inp=$("q"), list=$("ac");
  const hide=()=>list.style.display="none";
  const show=()=>list.style.display="block";
  function esc(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
  function renderAC(items){
    if (!items.length){ list.innerHTML='<div class="ac-empty">No matches</div>'; show(); return; }
    list.innerHTML = items.slice(0,20).map(it=>{
      const short = it.address.slice(0,8)+"…"+it.address.slice(-6);
      return `<div class="ac-item" data-addr="${it.address}">
        <span class="ac-name">${esc(it.name||"")}</span>
        <span class="ac-sym">(${esc(it.symbol||"")})</span>
        <span class="ac-addr">${short}</span>
      </div>`;
    }).join("");
    show();
  }
  function onType(){
    const q = inp.value.trim().toLowerCase();
    if (!q){ hide(); return; }
    if (/^0x[a-f0-9]{40}$/.test(q)){ renderAC([{address:q,name:"",symbol:""}]); return; }
    const hits = POOLS.filter(p =>
      (p.address||"").includes(q) ||
      (p.symbol||"").toLowerCase().includes(q) ||
      (p.name||"").toLowerCase().includes(q)
    );
    renderAC(hits);
  }
  inp.addEventListener('input', onType);
  inp.addEventListener('focus', ()=>{ if (list.innerHTML) show(); });
  document.addEventListener('click', (e)=>{ if (!list.contains(e.target) && e.target!==inp) hide(); });
  list.addEventListener('click', async (e)=>{
    const item = e.target.closest('.ac-item'); if (!item) return;
    const ca = item.getAttribute('data-addr');
    hide();
    await computeOne(ca);
  });
}

/* ====== Compute one token (on-demand for search) ====== */
async function computeOne(ca){
  try{
    $("status").textContent = "Computing…";
    const pool = POOLMAP.get(ca.toLowerCase());
    if (!pool) { $("status").textContent="Not found in pools_cache.json"; return; }

    const locks = await getActiveLocks(ca);
    if (!locks){ $("status").textContent="No active lock"; return; }

    const sup = await getSupplyAndBurn(ca);
    const dec = sup.decimals||18;
    const total = Number(ethers.utils.formatUnits(sup.total, dec));
    const burned = Number(ethers.utils.formatUnits(sup.burned, dec));
    const lockedTokens = Number(ethers.utils.formatUnits(locks.totalLocked, dec));
    const lockedPct = total>0 ? (lockedTokens/total*100) : 0;
    const circ = Math.max(0, total - burned - lockedTokens);
    const priceUSD = pool.price||0;
    const tvlUSD = lockedTokens * priceUSD;

    const ageDays = pool.pool_created_at ? (Date.now()-Date.parse(pool.pool_created_at))/(1000*60*60*24) : 0;
    const reserve = pool.reserve_in_usd||0;

    // Holders Top-10 share (via RELAY)
    const topShare = await fetchHoldersTopShare(ca, total, dec);

    // Votes
    const votesObj = VOTES.get(ca.toLowerCase());
    const votes = votesObj?.votes||0;
    let maxVotes = 0; VOTES.forEach(v=>{ if (v.votes>maxVotes) maxVotes=v.votes; });

    // Scores
    const s_locked = scoreLockedPct(lockedPct);
    const s_time   = scoreTimeSafety(locks.nextUnlock);
    const s_age    = scoreAge(ageDays);
    const s_depth  = scoreDepth(reserve);
    const s_votes  = scoreVotes(votes);
    const s_top10  = scoreTop10Share(topShare);
    const s_dev    = 0; // N/A

    const score = s_locked + s_time + s_age + s_depth + s_votes + s_top10 + s_dev;

    const row = {
      ca: ca,
      symbol: pool.symbol || sup.symbol || "",
      name: (pool.name||"").split("/")[0].trim() || sup.name || "",
      eventDate: locks.lastUnlock || (pool.pool_created_at ? Date.parse(pool.pool_created_at) : null),
      nextUnlock: locks.nextUnlock,
      lockedPct,
      tvlUSD,
      circ, burn: burned, total,
      circPct: total>0 ? (circ/total*100) : 0,
      burnPct: total>0 ? (burned/total*100) : 0,
      priceUSD, marketCap: pool.market_cap,
      // score details
      score,
      s_locked, s_time, s_age, s_depth, s_votes, s_top10,
      votes, maxVotes, ageDays, reserve, lockedTokens, top10Share: topShare
    };

    CURRENT_ROWS = [row];
    render();
    $("status").textContent = "Done";
  }catch(e){
    log("computeOne error", e.message||e);
    $("status").textContent = "Error";
  }
}

/* ====== Compute for top 10 by MC (fast) ====== */
async function computeTop10(){
  $("status").textContent="Scanning locks (top 10 MC)…";
  // candidates
  const sorted = POOLS.slice().sort((a,b)=> (b.market_cap||0)-(a.market_cap||0)).slice(0,10);
  const reserves = sorted.map(x=>x.reserve_in_usd||0);
  P90_RESERVE = percentile90(reserves);

  const rows = [];
  for (const pool of sorted){
    const ca = pool.address;
    try{
      const locks = await getActiveLocks(ca);
      if (!locks) continue;

      const sup = await getSupplyAndBurn(ca);
      const dec = sup.decimals||18;
      const total = Number(ethers.utils.formatUnits(sup.total, dec));
      const burned = Number(ethers.utils.formatUnits(sup.burned, dec));
      const lockedTokens = Number(ethers.utils.formatUnits(locks.totalLocked, dec));
      const lockedPct = total>0 ? (lockedTokens/total*100) : 0;
      const circ = Math.max(0, total - burned - lockedTokens);
      const priceUSD = pool.price||0;
      const tvlUSD = lockedTokens * priceUSD;

      const ageDays = pool.pool_created_at ? (Date.now()-Date.parse(pool.pool_created_at))/(1000*60*60*24) : 0;
      const reserve = pool.reserve_in_usd||0;

      const topShare = await fetchHoldersTopShare(ca, total, dec);
      const votesObj = VOTES.get(ca.toLowerCase());
      const votes = votesObj?.votes||0;
      let maxVotes = 0; VOTES.forEach(v=>{ if (v.votes>maxVotes) max=v.votes; });

      const s_locked = scoreLockedPct(lockedPct);
      const s_time   = scoreTimeSafety(locks.nextUnlock);
      const s_age    = scoreAge(ageDays);
      const s_depth  = scoreDepth(reserve);
      const s_votes  = scoreVotes(votes);
      const s_top10  = scoreTop10Share(topShare);
      const s_dev    = 0;

      const score = s_locked + s_time + s_age + s_depth + s_votes + s_top10 + s_dev;

      rows.push({
        ca: ca,
        symbol: pool.symbol || sup.symbol || "",
        name: (pool.name||"").split("/")[0].trim() || sup.name || "",
        eventDate: locks.lastUnlock || (pool.pool_created_at ? Date.parse(pool.pool_created_at) : null),
        nextUnlock: locks.nextUnlock,
        lockedPct,
        tvlUSD,
        circ, burn: burned, total,
        circPct: total>0 ? (circ/total*100) : 0,
        burnPct: total>0 ? (burned/total*100) : 0,
        priceUSD, marketCap: pool.market_cap,
        score,
        s_locked, s_time, s_age, s_depth, s_votes, s_top10,
        votes, maxVotes, ageDays, reserve, lockedTokens, top10Share: topShare
      });

      $("status").textContent = `Locked (top10): ${rows.length}`;
    }catch(e){
      log("scan err", pool.address, e.message||e);
    }
  }

  CURRENT_ROWS = rows.sort((a,b)=> (b.score||0)-(a.score||0));
  render();
  $("status").textContent = `Locked projects scored: ${CURRENT_ROWS.length}`;
}

/* ====== Sort by TVL click ====== */
$("sortTVL").addEventListener('click', ()=>{
  CURRENT_ROWS.sort((a,b)=> (b.tvlUSD||0)-(a.tvlUSD||0));
  render();
});

/* ====== Reload ====== */
async function reloadAll(){
  try{
    $("rows").innerHTML = "";
    $("log").textContent = "";
    $("status").textContent = "Loading…";
    ro = new ethers.providers.JsonRpcProvider(NET.RPC);
    locker = new ethers.Contract(NET.LOCKER, LOCKER_ABI, ro);

    await loadPools();
    VOTES = await fetchVotes();
    attachAutocomplete();
    await computeTop10();
  }catch(e){
    $("status").textContent = "Error";
    log("Fatal:", e.message||String(e));
  }
}

$("reload").addEventListener('click', reloadAll);
document.addEventListener('DOMContentLoaded', reloadAll);
</script>
</body>
</html>
