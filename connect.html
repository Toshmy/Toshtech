<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ToshLock — WalletConnect (UMD)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0c1222; --fg:#fff; --card: rgba(255,255,255,.06); --border: rgba(255,255,255,.12); }
    body { background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:0; }
    .wrap { max-width: 760px; margin: 40px auto; padding: 0 20px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .muted { opacity:.85; font-size:12px; }
    button { cursor:pointer; border-radius:10px; padding:8px 12px; border:0; }
    #btnConnect { background:#2563eb; color:#fff; }
  </style>

  <!-- ethers v5 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- WalletConnect Ethereum Provider v2 UMD (official) -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.11.2/dist/umd/index.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>🔌 Connect Wallet (WalletConnect UMD)</h1>
    <div class="card">
      <div class="row">
        <button id="btnConnect">Connect Wallet</button>
        <div id="status" class="muted">Not connected</div>
      </div>

      <div style="margin-top:12px" class="row">
        <button id="btnAddress" disabled>Show Address</button>
        <button id="btnChain" disabled>Show Chain</button>
      </div>

      <p class="muted" style="margin-top:12px">
        This page uses <code>@walletconnect/ethereum-provider</code> UMD + <code>ethers</code>.
        No bundler. No React. Works on GitHub Pages.
      </p>
      <pre id="log" class="card" style="margin-top:12px; height:180px; overflow:auto; font-size:12px;"></pre>
    </div>
  </div>

<script>
/** ===== Hardcoded env ===== */
const WC_PROJECT_ID = "6e2df48125e4f633b093361ba0a87c81";
const CHAIN_ID      = 97741;
const RPC_URL       = "https://rpc-pepu-v2-testnet-vn4qxxp9og.t.conduit.xyz";

/** ===== Globals ===== */
const $ = (id) => document.getElementById(id);
const log = (...a) => { $("log").textContent += a.join(" ") + "\n"; };

let wcProvider;     // WalletConnect EIP-1193 provider
let ethersProvider; // ethers.js provider wrapping wcProvider
let signer;         // ethers.js signer

/** ===== Sanity check for UMD global ===== */
function getWcUMD() {
  // UMD exposes WalletConnectEthereumProvider on window
  return window.WalletConnectEthereumProvider || null;
}

/** ===== Connect flow ===== */
$("btnConnect").onclick = async () => {
  try {
    const WcEP = getWcUMD();
    if (!WcEP) throw new Error("WalletConnect UMD not found. Check the <script> above.");

    // Initialize the provider (shows QR modal on enable)
    wcProvider = await WcEP.init({
      projectId: WC_PROJECT_ID,
      showQrModal: true,
      // Chains to support (single chain dapp)
      chains: [CHAIN_ID],
      optionalChains: [CHAIN_ID],
      // Map chain to RPC so wallets can call it
      rpcMap: { [CHAIN_ID]: RPC_URL },
      // Wallet / dapp metadata
      metadata: {
        name: "ToshLock",
        description: "Lock tokens with ToshLock",
        url: location.origin,
        icons: ["https://walletconnect.com/walletconnect-logo.png"]
      }
    });

    // Open session
    await wcProvider.enable();

    // Wrap with ethers
    ethersProvider = new ethers.providers.Web3Provider(wcProvider, "any");
    signer = ethersProvider.getSigner();

    // Update UI
    const addr = await signer.getAddress();
    const net  = await ethersProvider.getNetwork();
    $("status").textContent = `Connected: ${addr.slice(0,6)}…${addr.slice(-4)} on chain ${net.chainId}`;
    $("btnAddress").disabled = false;
    $("btnChain").disabled = false;

    // Listen for changes
    wcProvider.on("accountsChanged", (accts) => {
      $("status").textContent = accts.length
        ? `Connected: ${accts[0].slice(0,6)}…${accts[0].slice(-4)}`
        : "Not connected";
      log("[accountsChanged]", JSON.stringify(accts));
    });
    wcProvider.on("chainChanged", (chainIdHex) => {
      log("[chainChanged]", chainIdHex);
    });
    wcProvider.on("disconnect", () => {
      $("status").textContent = "Not connected";
      $("btnAddress").disabled = true;
      $("btnChain").disabled = true;
      log("[disconnect]");
    });

    log("✅ Connected via WalletConnect");

  } catch (e) {
    log("❌", e?.message || String(e));
    alert(e?.message || String(e));
  }
};

/** ===== Test helpers ===== */
$("btnAddress").onclick = async () => {
  try {
    const addr = await signer.getAddress();
    alert(addr);
  } catch (e) {
    alert(e?.message || String(e));
  }
};
$("btnChain").onclick = async () => {
  try {
    const net = await ethersProvider.getNetwork();
    alert(`chainId: ${net.chainId}`);
  } catch (e) {
    alert(e?.message || String(e));
  }
};
</script>
</body>
</html>
