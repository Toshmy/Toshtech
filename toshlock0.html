<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ToshLock â€“ Approve & Lock (Multiâ€‘Lock + Name)</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- ethers v5 UMD -->
  <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- WalletConnect v2 UMD (optional; set WC_PROJECT_ID) -->
  <script src="https://unpkg.com/@walletconnect/ethereum-provider@2.11.2/dist/index.umd.js"></script>
</head>
<body class="min-h-screen bg-gray-900 text-white">
  <div class="max-w-2xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">ðŸ”’ ToshLock â€” Approve & Lock (Multiâ€‘Lock + Name)</h1>
      <div class="flex gap-2">
        <button id="btnConnectMM" class="px-3 py-2 rounded-lg bg-green-600 hover:bg-green-700">MetaMask</button>
        <button id="btnConnectWC" class="px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-700">WalletConnect</button>
      </div>
    </header>

    <section class="space-y-4 bg-white bg-opacity-5 p-4 rounded-xl border border-white border-opacity-10">
      <div>
        <label class="block text-sm text-gray-300 mb-1">Token address</label>
        <input id="token" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="0x... token" />
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-1">Locker address (ToshLock V2)</label>
        <input id="locker" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="0x... locker" />
      </div>
      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <label class="block text-sm text-gray-300 mb-1">Amount (human)</label>
          <input id="amount" type="number" min="0" step="any" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="1000" />
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-1">Lock until (local time)</label>
          <input id="locktime" type="datetime-local" class="w-full p-2 rounded bg-gray-800 border border-gray-700" />
        </div>
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-1">Lock name (optional)</label>
        <input id="lockname" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="Liquidity Round #1" />
      </div>

      <div class="flex flex-wrap gap-3">
        <button id="btnRead" class="px-3 py-2 rounded-lg bg-gray-700 hover:bg-gray-600">Read token</button>
        <button id="btnApprove" class="px-3 py-2 rounded-lg bg-yellow-600 hover:bg-yellow-700">Approve</button>
        <button id="btnLock" class="px-3 py-2 rounded-lg bg-purple-600 hover:bg-purple-700">Lock</button>
        <button id="btnApproveLock" class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700">Approve & Lock</button>
      </div>

      <p class="text-sm text-gray-300">Note: Contract takes a fee (default 3%). It pulls the full amount, sends fee to owner, and locks the remainder. One user can create <b>multiple</b> locks per token; each gets its own <i>lockId</i>.</p>
    </section>

    <section class="bg-white bg-opacity-5 p-4 rounded-xl border border-white border-opacity-10">
      <div id="status" class="text-sm text-gray-300">Ready.</div>
      <pre id="log" class="mt-2 p-2 bg-black rounded text-xs h-56 overflow-auto"></pre>
    </section>
  </div>

<script>
// ===== CONFIG =====
const WC_PROJECT_ID = "6e2df48125e4f633b093361ba0a87c81"; // set if you want WalletConnect QR

// ===== libs =====
const ethers = window.ethers;

// ===== ABIs =====
const ERC20_ABI = [
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function approve(address spender, uint256 value) returns (bool)"
];
const LOCKER_ABI = [
  "function lockLiquidity(address token, uint256 amount, uint256 lockTime)",
  "function lockLiquidityWithName(address token, uint256 amount, uint256 lockTime, string name)",
  "function getLock(address token, address user, uint256 lockId) view returns (uint256 amount, uint256 unlockTime, string name)",
  "function getLockCount(address token, address user) view returns (uint256)"
];

// ===== state =====
let rawProvider = null;      // window.ethereum or WC provider
let provider = null;         // ethers provider
let signer = null;
let account = null;

// ===== helpers =====
const $ = (id) => document.getElementById(id);
const log = (...a) => { $("log").textContent += a.join(" ") + "\n"; };
const setStatus = (s) => { $("status").textContent = s; };
const addr = (a) => ethers.utils.getAddress(a);
const toUnits = (v, d) => ethers.utils.parseUnits(v || "0", d);
const tsFromInput = () => {
  const v = $("locktime").value; if(!v) throw new Error("Pick lock time");
  const s = Math.floor(Date.parse(v)/1000); if(!s) throw new Error("Bad date");
  if(s <= Math.floor(Date.now()/1000)) throw new Error("Lock time must be future");
  return s;
};

// ===== connect wallets =====
$("btnConnectMM").onclick = async () => {
  try{
    if(!window.ethereum) throw new Error("MetaMask not found");
    rawProvider = window.ethereum;
    provider = new ethers.providers.Web3Provider(rawProvider, "any");
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    account = await signer.getAddress();
    const net = await provider.getNetwork();
    setStatus(`Connected MetaMask ${account.slice(0,6)}â€¦${account.slice(-4)} on chain ${net.chainId}`);
  }catch(e){ setStatus(e.message || String(e)); }
};

$("btnConnectWC").onclick = async () => {
  try{
    if(!WC_PROJECT_ID) throw new Error("Set WC_PROJECT_ID in the script");
    const wc = await window.EthereumProvider.init({ projectId: WC_PROJECT_ID, chains: [], showQrModal: true });
    await wc.enable();
    rawProvider = wc;
    provider = new ethers.providers.Web3Provider(wc, "any");
    signer = provider.getSigner();
    account = await signer.getAddress();
    const net = await provider.getNetwork();
    setStatus(`Connected WalletConnect ${account.slice(0,6)}â€¦${account.slice(-4)} on chain ${net.chainId}`);
  }catch(e){ setStatus(e.message || String(e)); }
};

// ===== actions =====
$("btnRead").onclick = async () => {
  try{
    if(!signer) throw new Error("Connect wallet first");
    const token = new ethers.Contract(addr($("token").value), ERC20_ABI, signer);
    const [name, symbol, decimals] = await Promise.all([token.name(), token.symbol(), token.decimals()]);
    log(`Token: ${name} (${symbol}), decimals=${decimals}`);
  }catch(e){ log("Read token error:", e.data?.message || e.message || String(e)); }
};

$("btnApprove").onclick = async () => {
  try{
    if(!signer) throw new Error("Connect wallet first");
    const token = new ethers.Contract(addr($("token").value), ERC20_ABI, signer);
    const lockerAddr = addr($("locker").value);
    const dec = await token.decimals();
    const amount = toUnits($("amount").value, dec);
    const tx = await token.approve(lockerAddr, amount);
    setStatus("Approval sentâ€¦"); log("Approval:", tx.hash);
    await tx.wait(); setStatus("âœ… Approval confirmed");
  }catch(e){ setStatus(e.data?.message || e.message || String(e)); }
};

async function doLock(){
  if(!signer) throw new Error("Connect wallet first");
  const tokenAddr = addr($("token").value);
  const lockerAddr = addr($("locker").value);
  const token = new ethers.Contract(tokenAddr, ERC20_ABI, signer);
  const locker = new ethers.Contract(lockerAddr, LOCKER_ABI, signer);
  const dec = await token.decimals();
  const amount = toUnits($("amount").value, dec);
  const when = tsFromInput();
  const name = $("lockname").value || "";

  // try the named function first, fallback if old contract
  let tx;
  if (locker.interface.functions["lockLiquidityWithName(address,uint256,uint256,string)"]) {
    tx = await locker.lockLiquidityWithName(tokenAddr, amount, when, name);
  } else {
    tx = await locker.lockLiquidity(tokenAddr, amount, when);
  }
  setStatus("Lock sentâ€¦"); log("Lock:", tx.hash);
  await tx.wait(); setStatus("ðŸ”’ Lock confirmed");
}

$("btnLock").onclick = async () => {
  try { await doLock(); } catch(e){ setStatus(e.data?.message || e.message || String(e)); }
};

$("btnApproveLock").onclick = async () => {
  try{
    await $("btnApprove").onclick();
    await doLock();
  }catch(e){ setStatus(e.data?.message || e.message || String(e)); }
};
</script>
</body>
</html>
