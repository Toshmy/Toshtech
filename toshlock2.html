<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ToshLock - Lock Tokens</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.11.2/dist/umd/index.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #0c1222; color: white; text-align: center; }
    input, button { padding: 8px; margin: 5px; border-radius: 5px; }
    button { cursor: pointer; }
    #connStatus { margin-top: 10px; }
  </style>
</head>
<body>

<h1>ToshLock</h1>
<p>Lock your tokens securely on PEPU testnet</p>

<button id="connect-wc">Connect Wallet</button>
<div id="connStatus">Not connected</div>

<hr>

<h2>Lock Tokens</h2>
<label>Token Address:</label>
<input type="text" id="tokenAddress" placeholder="0x..." size="45">
<span id="tokenInfo"></span><br>

<label>Amount:</label>
<input type="text" id="amount" placeholder="Amount"><br>

<label>Unlock Time (Unix):</label>
<input type="text" id="unlockTime" placeholder="e.g. 1754928000"><br>

<button id="approveLockBtn">Approve & Lock</button>

<div id="txStatus"></div>

<script>
const WC_PROJECT_ID = "6e2df48125e4f633b093361ba0a87c81";
const CHAIN_ID = 97741;
const RPC_URL = "https://rpc-pepu-v2-testnet-vn4qxxp9og.t.conduit.xyz";
const TOSHLOCK_ADDRESS = "0xdAafaf8fC73C6D4dfE27B2494Bdc864D0f7C9c01";

let signer, provider;

function getWcEthereumProviderUMD() {
  return window.WalletConnectEthereumProvider || null;
}

document.getElementById("connect-wc").onclick = async () => {
  try {
    const WcEP = getWcEthereumProviderUMD();
    if (!WcEP) throw new Error("WalletConnect UMD not found (check the <script> tag)");
    const wcProvider = await WcEP.init({
      projectId: WC_PROJECT_ID,
      showQrModal: true,
      optionalChains: [CHAIN_ID],
      rpcMap: { [CHAIN_ID]: RPC_URL },
      metadata: {
        name: "ToshLock",
        description: "Lock tokens with ToshLock",
        url: location.origin,
        icons: ["https://walletconnect.com/walletconnect-logo.png"]
      }
    });
    await wcProvider.enable();
    provider = new ethers.providers.Web3Provider(wcProvider, "any");
    signer = provider.getSigner();
    const account = await signer.getAddress();
    const net = await provider.getNetwork();
    document.getElementById("connStatus").textContent =
      `Connected: ${account.slice(0,6)}…${account.slice(-4)} on chain ${net.chainId}`;
  } catch (e) {
    document.getElementById("connStatus").textContent = e.message || String(e);
    console.error(e);
  }
};

document.getElementById("tokenAddress").addEventListener("change", async () => {
  try {
    const tokenAddr = document.getElementById("tokenAddress").value;
    if (!ethers.utils.isAddress(tokenAddr)) {
      document.getElementById("tokenInfo").textContent = "Invalid address";
      return;
    }
    const tokenAbi = [
      "function name() view returns (string)",
      "function symbol() view returns (string)"
    ];
    const tokenContract = new ethers.Contract(tokenAddr, tokenAbi, provider || new ethers.providers.JsonRpcProvider(RPC_URL));
    const [name, symbol] = await Promise.all([
      tokenContract.name(),
      tokenContract.symbol()
    ]);
    document.getElementById("tokenInfo").textContent = `${name} (${symbol})`;
  } catch (err) {
    document.getElementById("tokenInfo").textContent = "Token info not found";
    console.error(err);
  }
});

document.getElementById("approveLockBtn").onclick = async () => {
  try {
    const tokenAddr = document.getElementById("tokenAddress").value;
    const amount = document.getElementById("amount").value;
    const unlockTime = document.getElementById("unlockTime").value;

    if (!signer) throw new Error("Please connect wallet first");

    const tokenAbi = [
      "function approve(address spender, uint256 amount) returns (bool)"
    ];
    const lockAbi = [
      "function lockLiquidity(address token, uint256 amount, uint256 lockTime)"
    ];

    const tokenContract = new ethers.Contract(tokenAddr, tokenAbi, signer);
    const amtWei = ethers.utils.parseUnits(amount, 18);
    const approveTx = await tokenContract.approve(TOSHLOCK_ADDRESS, amtWei);
    document.getElementById("txStatus").textContent = `Approving... ${approveTx.hash}`;
    await approveTx.wait();

    const lockContract = new ethers.Contract(TOSHLOCK_ADDRESS, lockAbi, signer);
    const lockTx = await lockContract.lockLiquidity(tokenAddr, amtWei, unlockTime);
    document.getElementById("txStatus").textContent = `Locking... ${lockTx.hash}`;
    await lockTx.wait();
    document.getElementById("txStatus").textContent = `✅ Tokens locked! TX: ${lockTx.hash}`;
  } catch (err) {
    document.getElementById("txStatus").textContent = `❌ ${err.message || err}`;
    console.error(err);
  }
};
</script>

</body>
</html>
