<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ToshLock Dashboard â€“ Ownerâ€™s Active Locks</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body class="min-h-screen bg-gray-900 text-white">
  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-bold text-green-300">ðŸ“Š ToshLock Dashboard â€” Ownerâ€™s Active Locks</h1>
      <div class="flex gap-2">
        <button id="btnConnect" class="px-3 py-2 rounded-lg bg-green-600 hover:bg-green-700">Connect Wallet</button>
        <button id="btnUseRPC" class="px-3 py-2 rounded-lg bg-gray-700 hover:bg-gray-600">Use RPC</button>
      </div>
    </header>

    <section class="bg-white bg-opacity-5 p-4 rounded-xl border border-white border-opacity-10 grid md:grid-cols-2 gap-4">
      <div class="space-y-3">
        <div>
          <label class="block text-sm text-gray-300 mb-1">Locker address (ToshLock V2)</label>
          <input id="locker" value="0xdAafaf8fC73C6D4dfE27B2494Bdc864D0f7C9c01" class="w-full p-2 rounded bg-gray-800 border border-gray-700" />
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-1">Owner address (wallet to show locks for)</label>
          <input id="owner" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="0x... (leave empty to use connected wallet)" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm text-gray-300 mb-1">From block</label>
            <input id="fromBlock" class="w-full p-2 rounded bg-gray-800 border border-gray-700" value="97740" />
          </div>
          <div>
            <label class="block text-sm text-gray-300 mb-1">To block</label>
            <input id="toBlock" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="latest" />
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm text-gray-300 mb-1">RPC URL (read-only)</label>
            <input id="rpcUrl" class="w-full p-2 rounded bg-gray-800 border border-gray-700" value="https://rpc-pepu-v2-testnet-vn4qxxp9og.t.conduit.xyz" />
          </div>
          <div>
            <label class="block text-sm text-gray-300 mb-1">Explorer base URL</label>
            <input id="explorer" class="w-full p-2 rounded bg-gray-800 border border-gray-700" value="https://explorer-pepu-v2-testnet-vn4qxxp9og.t.conduit.xyz" />
          </div>
        </div>
        <div class="flex gap-2 pt-1">
          <button id="btnScan" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700">Scan</button>
          <button id="btnExport" class="px-4 py-2 rounded-xl bg-gray-700 hover:bg-gray-600">Export CSV</button>
        </div>
        <div id="status" class="text-sm text-gray-300"></div>
      </div>

      <div class="bg-white bg-opacity-5 p-4 rounded-xl border border-white border-opacity-10">
        <h3 class="font-semibold text-green-200 mb-1">What it shows</h3>
        <ul class="text-sm text-gray-300 list-disc pl-5 space-y-1">
          <li>Only <b>active</b> locks (amount &gt; 0 and unlock in the future).</li>
          <li>Filtered by the specified <b>Owner</b> address (the wallet that created the locks).</li>
          <li>Each lock has a unique <b>Lock ID</b> and a <b>Name</b>.</li>
        </ul>
      </div>
    </section>

    <section class="bg-white bg-opacity-5 p-4 rounded-xl border border-white border-opacity-10">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-xl font-semibold text-green-200">Active Locks</h2>
        <div class="text-sm text-gray-300" id="summary"></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left bg-gray-800">
              <th class="p-2">#</th>
              <th class="p-2">Token</th>
              <th class="p-2">Symbol</th>
              <th class="p-2">Name</th>
              <th class="p-2">Amount</th>
              <th class="p-2">Unlock Time</th>
              <th class="p-2">Lock ID</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <section class="bg-white bg-opacity-5 p-4 rounded-xl border border-white border-opacity-10">
      <h3 class="font-semibold mb-2 text-green-200">Log</h3>
      <pre id="log" class="bg-black rounded p-3 text-xs h-56 overflow-auto"></pre>
    </section>
  </div>

<script>
const ethers = window.ethers;

const LOCKER_ABI = [
  "event LiquidityLocked(address indexed token, address indexed user, uint256 indexed lockId, uint256 amount, uint256 unlockTime, string name)",
  "event LiquidityUnlocked(address indexed token, address indexed user, uint256 indexed lockId, uint256 amount)",
  "function getLock(address token, address user, uint256 lockId) view returns (uint256 amount, uint256 unlockTime, string name)"
];
const ERC20_ABI = [
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)"
];

let provider = null; let signer = null; let account = null;
const $ = (id) => document.getElementById(id);
const log = (...a) => { $("log").textContent += a.join(" ") + "\n"; };

$("btnConnect").onclick = async () => {
  try{
    if(!window.ethereum) throw new Error("No wallet");
    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner(); account = await signer.getAddress();
    const net = await provider.getNetwork();
    $("status").textContent = `Connected ${account.slice(0,6)}â€¦${account.slice(-4)} on chain ${net.chainId}`;
  }catch(e){ $("status").textContent = e.message || String(e); }
};

$("btnUseRPC").onclick = async () => {
  try{
    const url = $("rpcUrl").value.trim(); if(!url) throw new Error("Enter RPC URL");
    provider = new ethers.providers.JsonRpcProvider(url);
    signer = null; account = null;
    const net = await provider.getNetwork();
    $("status").textContent = `Using RPC chain ${net.chainId}`;
  }catch(e){ $("status").textContent = e.message || String(e); }
};

$("btnScan").onclick = async () => {
  try{
    if(!provider) throw new Error("Connect wallet or set RPC first");
    const lockerAddr = ethers.utils.getAddress($("locker").value.trim());
    const owner = $("owner").value.trim() ? ethers.utils.getAddress($("owner").value.trim()) : account;
    if(!owner) throw new Error("Set Owner address or connect wallet");
    const fromBlock = Number($("fromBlock").value || 0);
    const toBlock = $("toBlock").value ? Number($("toBlock").value) : await provider.getBlockNumber();

    const iface = new ethers.utils.Interface(LOCKER_ABI);
    const topic = iface.getEventTopic("LiquidityLocked");

    // Filter on indexed user to reduce the log size
    const userTopic = ethers.utils.hexZeroPad(owner, 32);

    // Chunked fetch
    const step = 50000; const logs = [];
    for(let start=fromBlock; start <= toBlock; start += (step+1)){
      const end = Math.min(start + step, toBlock);
      const chunk = await provider.getLogs({ address: lockerAddr, topics: [topic, null, userTopic], fromBlock: start, toBlock: end });
      logs.push(...chunk);
    }

    const rows = [];
    const locker = new ethers.Contract(lockerAddr, LOCKER_ABI, provider);
    const tokenCache = new Map();
    async function tokenInfo(addr){
      const k = addr.toLowerCase(); if(tokenCache.has(k)) return tokenCache.get(k);
      try{
        const erc = new ethers.Contract(addr, ERC20_ABI, provider);
        const [dec, sym] = await Promise.all([erc.decimals(), erc.symbol()]);
        const info = {decimals: Number(dec), symbol: sym}; tokenCache.set(k, info); return info;
      }catch{ const info = {decimals: 18, symbol: "?"}; tokenCache.set(k, info); return info; }
    }

    const now = Math.floor(Date.now()/1000);

    for(const lg of logs){
      let ev; try{ ev = iface.parseLog(lg); }catch{ continue; }
      const token = ev.args.token; const lockId = ev.args.lockId.toNumber();
      let amount, unlockTime, name;
      try{
        const res = await locker.getLock(token, owner, lockId);
        amount = res.amount !== undefined ? res.amount : res[0];
        unlockTime = res.unlockTime !== undefined ? res.unlockTime : res[1];
        name = res.name !== undefined ? res.name : res[2];
      }catch{ continue; }
      if(!amount || amount.toString() === "0") continue;
      if(unlockTime.toNumber() <= now) continue; // only active

      const info = await tokenInfo(token);
      rows.push({ token, symbol: info.symbol, amountHuman: ethers.utils.formatUnits(amount, info.decimals), unlock: unlockTime.toNumber(), name, lockId });
    }

    // Render
    rows.sort((a,b)=> a.unlock - b.unlock);
    const tbody = $("tbody"); tbody.innerHTML = "";
    const explorer = $("explorer").value.trim();

    rows.forEach((r, i) => {
      const tr = document.createElement('tr'); tr.className = i%2?'bg-gray-900':'';
      const tok = explorer ? `<a class='text-green-300 underline' target='_blank' href='${explorer}/address/${r.token}'>${r.token.slice(0,6)}â€¦${r.token.slice(-4)}</a>` : r.token.slice(0,6)+"â€¦"+r.token.slice(-4);
      tr.innerHTML = `
        <td class='p-2'>${i+1}</td>
        <td class='p-2'>${tok}</td>
        <td class='p-2'>${r.symbol}</td>
        <td class='p-2'>${r.name || ''}</td>
        <td class='p-2'>${Number(r.amountHuman).toLocaleString()}</td>
        <td class='p-2'>${new Date(r.unlock*1000).toLocaleString()}</td>
        <td class='p-2'>${r.lockId}</td>`;
      tbody.appendChild(tr);
    });

    $("summary").textContent = `${rows.length} active lock${rows.length===1?'':'s'} for ${owner.slice(0,6)}â€¦${owner.slice(-4)}`;
    $("status").textContent = `Done.`;
  }catch(e){
    console.error(e); $("status").textContent = e.data?.message || e.message || String(e);
  }
};

$("btnExport").onclick = () => {
  const tbody = $("tbody"); if(!tbody.children.length) return alert('No rows to export');
  const rows = [['#','Token','Symbol','Name','Amount','Unlock Time','Lock ID']];
  Array.from(tbody.children).forEach(tr => {
    rows.push(Array.from(tr.children).map(td => td.textContent));
  });
  const csv = rows.map(r => r.map(x => '"'+String(x).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a = document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv); a.download = 'toshlock_owner_active_locks.csv'; a.click();
};
</script>
</body>
</html>
