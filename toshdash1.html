<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ToshLock Dashboard â€” Active Locks</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body class="min-h-screen bg-gray-900 text-white">
  <div class="max-w-5xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">ðŸ“Š ToshLock Dashboard â€” Active Locks</h1>

    <div class="grid md:grid-cols-4 gap-3 mb-4">
      <div class="md:col-span-2">
        <label class="block text-sm text-gray-400 mb-1">Locker (hardcoded)</label>
        <input id="locker" class="w-full p-2 rounded bg-gray-800 border border-gray-700" readonly/>
      </div>
      <div>
        <label class="block text-sm text-gray-400 mb-1">From block</label>
        <input id="fromBlock" class="w-full p-2 rounded bg-gray-800 border border-gray-700" />
      </div>
      <div>
        <label class="block text-sm text-gray-400 mb-1">Owner filter (optional)</label>
        <input id="owner" class="w-full p-2 rounded bg-gray-800 border border-gray-700" placeholder="0x... wallet"/>
      </div>
    </div>

    <div class="flex gap-3 mb-4">
      <button id="scan" class="px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-700">Scan Locks</button>
      <button id="exportCsv" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600">Export CSV</button>
      <span id="status" class="text-sm text-gray-300"></span>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-800">
          <tr>
            <th class="px-3 py-2 text-left">Lock ID</th>
            <th class="px-3 py-2 text-left">Owner</th>
            <th class="px-3 py-2 text-left">Token</th>
            <th class="px-3 py-2 text-left">Name</th>
            <th class="px-3 py-2 text-right">Amount</th>
            <th class="px-3 py-2 text-left">Symbol</th>
            <th class="px-3 py-2 text-left">Unlock time</th>
            <th class="px-3 py-2 text-left">Link</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <pre id="log" class="mt-6 p-3 bg-black rounded-lg text-xs overflow-x-auto h-64"></pre>
  </div>

<script>
const ethers = window.ethers;

/** ===== Hardcoded env ===== */
const RPC_URL   = "https://rpc-pepu-v2-testnet-vn4qxxp9og.t.conduit.xyz";
const EXPLORER  = "https://explorer-pepu-v2-testnet-vn4qxxp9og.t.conduit.xyz";
const LOCKER    = "0xdAafaf8fC73C6D4dfE27B2494Bdc864D0f7C9c01";
const DEFAULT_FROM_BLOCK = "97740";

/** ===== ABIs (events + views) ===== */
const LOCKER_ABI = [
  "event LiquidityLocked(address indexed token, address indexed user, uint256 indexed lockId, uint256 amount, uint256 unlockTime, string name)",
  "function getLock(address token, address user, uint256 lockId) view returns (uint256 amount, uint256 unlockTime, string name)"
];
const ERC20_ABI = [
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)"
];

/** ===== UI refs ===== */
const $ = (id)=>document.getElementById(id);
$("locker").value   = LOCKER;
$("fromBlock").value= DEFAULT_FROM_BLOCK;

/** ===== Provider ===== */
const provider = new ethers.providers.JsonRpcProvider(RPC_URL);

/** ===== Helpers ===== */
function log(...args){ $("log").textContent += args.join(" ") + "\n"; }
function fmtDate(s){ return new Date(s*1000).toLocaleString(); }
function linkTx(hash){ return `${EXPLORER}/tx/${hash}`; }
function linkAddr(a){ return `${EXPLORER}/address/${a}`; }
function ensureAddr(a){ return ethers.utils.getAddress(a); }
function csvEscape(s){ return `"${String(s).replace(/"/g,'""')}"`; }

async function scan() {
  try{
    $("rows").innerHTML = "";
    $("status").textContent = "Scanningâ€¦";
    const locker = new ethers.Contract(LOCKER, LOCKER_ABI, provider);

    const iface = new ethers.utils.Interface(LOCKER_ABI);
    const topicLocked = iface.getEventTopic("LiquidityLocked");

    const from = parseInt($("fromBlock").value || DEFAULT_FROM_BLOCK, 10);
    const latest = await provider.getBlockNumber();

    // chunked getLogs (50k blocks per chunk)
    const CHUNK = 50_000;
    let logs = [];
    for(let start = from; start <= latest; start += CHUNK){
      const end = Math.min(start + CHUNK - 1, latest);
      const chunk = await provider.getLogs({
        address: LOCKER,
        fromBlock: start,
        toBlock: end,
        topics: [topicLocked]
      });
      logs = logs.concat(chunk);
    }
    log("Found logs:", logs.length);

    const rows = [];
    const now = Math.floor(Date.now()/1000);
    const tokenMetaCache = new Map();

    for(const lg of logs){
      try{
        const parsed = locker.interface.parseLog(lg);
        const token = parsed.args.token;
        const user  = parsed.args.user;
        const lockId= parsed.args.lockId.toNumber();
        // read current lock state (filters out those already unlocked)
        const [amount, unlockTime, name] = await locker.getLock(token, user, lockId);
        if(amount.eq(0) || unlockTime.toNumber() <= now) continue; // only active

        // token meta (cache)
        let meta = tokenMetaCache.get(token);
        if(!meta){
          const erc20 = new ethers.Contract(token, ERC20_ABI, provider);
          const [sym, dec] = await Promise.all([erc20.symbol().catch(()=>"?"), erc20.decimals().catch(()=>18)]);
          meta = {sym, dec};
          tokenMetaCache.set(token, meta);
        }
        const human = ethers.utils.formatUnits(amount, meta.dec);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-3 py-2">${lockId}</td>
          <td class="px-3 py-2"><a class="text-blue-400 hover:underline" href="${linkAddr(user)}" target="_blank">${user.slice(0,6)}â€¦${user.slice(-4)}</a></td>
          <td class="px-3 py-2"><a class="text-blue-400 hover:underline" href="${linkAddr(token)}" target="_blank">${token.slice(0,6)}â€¦${token.slice(-4)}</a></td>
          <td class="px-3 py-2">${name || ""}</td>
          <td class="px-3 py-2 text-right">${human}</td>
          <td class="px-3 py-2">${meta.sym}</td>
          <td class="px-3 py-2">${fmtDate(unlockTime.toNumber())}</td>
          <td class="px-3 py-2"><a class="text-blue-400 hover:underline" href="${EXPLORER}/block/${lg.blockNumber}" target="_blank">view</a></td>
        `;
        $("rows").appendChild(tr);

        rows.push({
          lockId, user, token, name,
          amount: human, symbol: meta.sym,
          unlockTime: unlockTime.toNumber()
        });
      }catch(e){ log("parse/read error:", e.message || e); }
    }

    $("status").textContent = `${rows.length} active locks`;
    // store for CSV
    window.__rows = rows;
  }catch(e){
    $("status").textContent = "Scan failed";
    log("Scan error:", e.message || e);
  }
}

$("scan").onclick = scan;

$("exportCsv").onclick = () => {
  const rows = window.__rows || [];
  const header = ["lockId","owner","token","name","amount","symbol","unlockTime"];
  const lines = [header.join(",")];
  for(const r of rows){
    lines.push([r.lockId, r.user, r.token, r.name, r.amount, r.symbol, r.unlockTime].map(csvEscape).join(","));
  }
  const blob = new Blob([lines.join("\n")], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "toshlock_active_locks.csv"; a.click();
  URL.revokeObjectURL(url);
};

// auto scan on load
window.addEventListener("load", scan);
</script>
</body>
</html>
